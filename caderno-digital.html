<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Caderno Digital do Paciente - Dr. Marcio Scartozzoni</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }
        
        /* Melhorias de Performance - CSS Otimizado */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        /* Container principal otimizado */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            position: relative;
        }
        
        /* Loading Spinner */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(102, 126, 234, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(10px);
            transition: opacity 0.3s ease;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Header aprimorado */

        /* Header aprimorado com melhor responsividade */
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            position: relative;
            overflow: hidden;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
            transform: rotate(45deg);
            animation: shimmer 3s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%) rotate(45deg); }
            100% { transform: translateX(100%) rotate(45deg); }
        }
        
        .header-content {
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            gap: 30px;
            align-items: center;
            position: relative;
            z-index: 1;
        }
        
        /* Sistema de status em tempo real */
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255,255,255,0.1);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 12px;
            margin-top: 10px;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10b981;
            animation: pulse 2s infinite;
        }
        
        .status-dot.offline {
            background: #ef4444;
            animation: none;
        }

        .header-left {
            display: flex;
            align-items: center;
        }

        .header-center {
            text-align: center;
        }

        .header-right {
            text-align: right;
        }

        .paciente-info {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 15px;
            border: 2px solid rgba(255,255,255,0.2);
        }

        .paciente-info h3 {
            margin-bottom: 10px;
            font-size: 1.3em;
            color: #fff;
        }

        .paciente-info .dados {
            font-size: 14px;
            opacity: 0.9;
            line-height: 1.6;
        }

        .prontuario-id {
            background: rgba(255,255,255,0.2);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            display: inline-block;
            margin-bottom: 10px;
        }

        .header h1 {
            margin-bottom: 5px;
            font-size: 2.2em;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .btn-voltar {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-voltar:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.05);
        }

        .toolbar {
            background: #f8f9fa;
            padding: 20px 30px;
            border-bottom: 2px solid #e9ecef;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .toolbar select, .toolbar input {
            padding: 10px 15px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
            background: white;
        }

        .toolbar button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .toolbar button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .main-content {
            display: grid;
            grid-template-columns: 300px 1fr;
            min-height: 70vh;
        }

        .sidebar {
            background: #f8f9fa;
            border-right: 2px solid #e9ecef;
            padding: 20px;
        }

        .sidebar h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #dee2e6;
        }

        /* Estilos para os bot√µes de a√ß√£o r√°pida */
        .acoes-rapidas {
            margin-bottom: 30px;
        }

        .btn-acao {
            width: 100%;
            padding: 12px 15px;
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .btn-acao:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .btn-acao i {
            font-size: 16px;
        }

        /* Estilos para bot√µes de edi√ß√£o dos cards */
        .btn-edit-marco, .btn-edit-agendamento {
            background: #6c757d;
            border: none;
            color: white;
            padding: 4px 6px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 10px;
            transition: all 0.3s ease;
            margin-left: auto;
        }

        .btn-edit-marco:hover, .btn-edit-agendamento:hover {
            background: #5a6268;
            transform: scale(1.1);
        }

        .marco-header {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .agendamento-recente {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px;
            border-radius: 6px;
            margin-bottom: 5px;
            background: rgba(255,255,255,0.7);
            transition: all 0.3s ease;
        }

        .agendamento-recente:hover {
            background: rgba(255,255,255,0.9);
            transform: translateX(3px);
        }

        .agendamento-info {
            flex: 1;
            cursor: pointer;
        }

        .document-list {
            list-style: none;
        }

        .document-item {
            background: white;
            margin-bottom: 10px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .document-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }

        .document-item.active {
            border-left: 5px solid #667eea;
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
        }

        .document-header {
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .document-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
        }

        .document-icon.orcamento { background: #3498db; }
        .document-icon.cadastro { background: #2ecc71; }
        .document-icon.jornada { background: #e74c3c; }
        .document-icon.acompanhamento { background: #f39c12; }
        .document-icon.receita { background: #9b59b6; }
        .document-icon.exames { background: #1abc9c; }

        .document-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .btn-modelo, .btn-download {
            flex: 1;
            padding: 12px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .btn-modelo {
            background: #e74c3c;
            color: white;
        }

        .btn-modelo:hover {
            background: #c0392b;
            transform: translateY(-2px);
        }

        .btn-download {
            background: #27ae60;
            color: white;
        }

        .btn-download:hover {
            background: #229954;
            transform: translateY(-2px);
        }

        .document-info h4 {
            color: #2c3e50;
            margin-bottom: 4px;
        }

        .document-info p {
            color: #7f8c8d;
            font-size: 12px;
        }

        /* Estilos para Hist√≥rico de Agendamentos */
        .historico-container {
            margin-bottom: 20px;
            background: rgba(255,255,255,0.7);
            border-radius: 10px;
            padding: 15px;
        }

        .marcos-principais {
            margin-bottom: 20px;
        }

        .marco-item {
            background: white;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .marco-item:hover {
            transform: translateX(5px);
            box-shadow: 0 3px 12px rgba(0,0,0,0.15);
        }

        .marco-item.primeira-consulta { border-left-color: #28a745; }
        .marco-item.retorno { border-left-color: #17a2b8; }
        .marco-item.cirurgia { border-left-color: #dc3545; }
        .marco-item.primeiro-retorno { border-left-color: #fd7e14; }
        .marco-item.proximo-retorno { border-left-color: #6f42c1; }
        .marco-item.alta { border-left-color: #20c997; }

        .marco-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 5px;
        }

        .marco-tipo {
            font-weight: 600;
            font-size: 12px;
            color: #2c3e50;
        }

        .marco-data {
            font-size: 13px;
            color: #6c757d;
        }

        .marco-status {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: auto;
        }

        .marco-status.realizado {
            background: #d4edda;
            color: #155724;
        }

        .marco-status.agendado {
            background: #d1ecf1;
            color: #0c5460;
        }

        .marco-status.pendente {
            background: #fff3cd;
            color: #856404;
        }

        .agendamento-recente {
            background: white;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 3px solid #667eea;
        }

        .agendamento-recente:hover {
            transform: translateX(3px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.15);
        }

        .agendamento-data {
            font-size: 12px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 3px;
        }

        .agendamento-tipo {
            font-size: 11px;
            color: #6c757d;
        }

        /* Estilos para Cards de Evolu√ß√£o */
        .card-evolucao {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-left: 5px solid;
            transition: all 0.3s ease;
        }

        .card-evolucao:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .card-evolucao.success {
            border-left-color: #28a745;
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
        }

        .card-evolucao.warning {
            border-left-color: #ffc107;
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
        }

        .card-evolucao.danger {
            border-left-color: #dc3545;
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .card-title h4 {
            margin: 0;
            color: #2c3e50;
            font-size: 16px;
            font-weight: 600;
        }

        .card-tipo {
            background: rgba(0,0,0,0.1);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 500;
            color: #6c757d;
            margin-top: 5px;
            display: inline-block;
        }

        .card-status {
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .card-status.success {
            background: #28a745;
            color: white;
        }

        .card-status.warning {
            background: #ffc107;
            color: #212529;
        }

        .card-status.danger {
            background: #dc3545;
            color: white;
        }

        .card-prazo {
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-prazo.urgente {
            background: #fff5f5;
            color: #e53e3e;
            border: 1px solid #feb2b2;
        }

        .card-tarefas h5 {
            margin: 0 0 10px 0;
            color: #2c3e50;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-tarefas ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .card-tarefas li {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
            border-bottom: 1px solid rgba(0,0,0,0.1);
            font-size: 13px;
        }

        .card-tarefas li:last-child {
            border-bottom: none;
        }

        .card-tarefas li.concluido span {
            text-decoration: line-through;
            color: #6c757d;
        }

        .card-tarefas input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: #28a745;
        }

        .card-observacoes {
            margin: 15px 0;
        }

        .card-observacoes textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            font-size: 12px;
            resize: vertical;
            min-height: 60px;
            font-family: inherit;
        }

        .card-actions {
            display: flex;
            gap: 8px;
            margin-top: 15px;
        }

        .card-actions button {
            flex: 1;
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .btn-edit {
            background: #17a2b8;
            color: white;
        }

        .btn-edit:hover {
            background: #138496;
        }

        .btn-duplicate {
            background: #6c757d;
            color: white;
        }

        .btn-duplicate:hover {
            background: #5a6268;
        }

        .btn-remove {
            background: #dc3545;
            color: white;
        }

        .btn-remove:hover {
            background: #c82333;
        }

        /* Estilos para Status Cards */
        .status-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid;
        }

        .status-card.success {
            border-left-color: #28a745;
        }

        .status-card.warning {
            border-left-color: #ffc107;
        }

        .status-card.danger {
            border-left-color: #dc3545;
        }

        .status-icon {
            font-size: 24px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .status-card.success .status-icon {
            background: #d4edda;
            color: #28a745;
        }

        .status-card.warning .status-icon {
            background: #fff3cd;
            color: #ffc107;
        }

        .status-card.danger .status-icon {
            background: #f8d7da;
            color: #dc3545;
        }

        .status-info h4 {
            margin: 0;
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }

        .status-info p {
            margin: 0;
            font-size: 12px;
            color: #6c757d;
        }

        /* Estilos para Notifica√ß√µes */
        .notification {
            background: white;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            border-left: 4px solid;
        }

        .notification.urgent {
            border-left-color: #dc3545;
            background: #fff5f5;
        }

        .notification.warning {
            border-left-color: #ffc107;
            background: #fffbf0;
        }

        .notification.info {
            border-left-color: #17a2b8;
            background: #f0fcff;
        }

        .notification-text {
            font-size: 12px;
            color: #2c3e50;
            flex: 1;
        }

        .notification-action {
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 8px;
            font-size: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .notification-action:hover {
            background: #5a6268;
        }

        .no-notifications {
            text-align: center;
            color: #6c757d;
            font-size: 12px;
            padding: 20px;
            background: white;
            border-radius: 8px;
        }

        /* Anima√ß√£o de pulse */
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
            50% { transform: scale(1.05); box-shadow: 0 8px 25px rgba(231, 76, 60, 0.3); }
            100% { transform: scale(1); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        }

        .canvas-area {
            padding: 30px;
            background: white;
            position: relative;
            overflow: auto;
        }

        .canvas-container {
            background: #fafafa;
            border: 2px dashed #dee2e6;
            border-radius: 15px;
            min-height: 600px;
            position: relative;
            padding: 20px;
        }

        .canvas-placeholder {
            text-align: center;
            padding: 100px 20px;
            color: #7f8c8d;
        }

        .canvas-placeholder i {
            font-size: 4em;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .document-form {
            display: none;
            max-width: 800px;
            margin: 0 auto;
        }

        .document-form.active {
            display: block;
        }

        .form-section {
            background: white;
            padding: 25px;
            margin-bottom: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .form-section h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #2c3e50;
            font-weight: 600;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .photo-upload {
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .photo-upload:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }

        .photo-upload i {
            font-size: 3em;
            color: #667eea;
            margin-bottom: 15px;
        }

        .photo-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .photo-item {
            position: relative;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .photo-item img {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }

        .photo-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: all 0.3s ease;
        }

        .photo-item:hover .photo-overlay {
            opacity: 1;
        }

        .photo-actions {
            display: flex;
            gap: 10px;
        }

        .photo-actions button {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 10px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .photo-actions button:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }

        .annotation-tools {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .tool-btn {
            background: white;
            border: 2px solid #dee2e6;
            color: #2c3e50;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tool-btn:hover,
        .tool-btn.active {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .evolution-timeline {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
        }

        .timeline-item {
            display: flex;
            margin-bottom: 25px;
            position: relative;
        }

        .timeline-item:not(:last-child)::after {
            content: '';
            position: absolute;
            left: 20px;
            top: 60px;
            bottom: -25px;
            width: 2px;
            background: #dee2e6;
        }

        .timeline-marker {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #667eea;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 20px;
            z-index: 1;
        }

        .timeline-content {
            flex: 1;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
        }

        .timeline-date {
            color: #7f8c8d;
            font-size: 12px;
            margin-bottom: 5px;
        }

        .timeline-title {
            color: #2c3e50;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .save-btn {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: block;
            margin: 30px auto;
        }

        .save-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(46, 204, 113, 0.3);
        }

        /* Sistema de modais aprimorados */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.4);
            max-height: 90vh;
            overflow-y: auto;
            animation: slideInUp 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            scrollbar-width: thin;
            scrollbar-color: #667eea #f1f1f1;
        }

        .modal-content::-webkit-scrollbar {
            width: 8px;
        }

        .modal-content::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .modal-content::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
        }

        @keyframes slideInUp {
            from { 
                transform: translateY(50px);
                opacity: 0;
            }
            to { 
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px 30px;
            border-radius: 20px 20px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            overflow: hidden;
        }

        .modal-header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
            transform: rotate(45deg);
            animation: shimmer 3s infinite;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.6em;
            font-weight: 700;
            position: relative;
            z-index: 1;
        }

        .btn-close {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 22px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            z-index: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1) rotate(90deg);
        }

        .modal-body {
            padding: 30px;
            background: #fafbfc;
        }

        .modal-footer {
            padding: 20px 30px;
            border-top: 1px solid #e9ecef;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            flex-wrap: wrap;
            background: white;
            border-radius: 0 0 20px 20px;
        }

        /* Preset texts melhorados */
        .preset-texts {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }

        .preset-btn {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 2px solid #dee2e6;
            padding: 12px 16px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            text-align: left;
            font-size: 14px;
            font-weight: 500;
            position: relative;
            overflow: hidden;
        }

        .preset-btn::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 4px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }

        .preset-btn:hover {
            background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
            border-color: #667eea;
            transform: translateX(8px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }

        .preset-btn:hover::before {
            transform: scaleY(1);
        }

        /* Bot√µes do modal aprimorados */
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
        }

        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:hover::before {
            left: 100%;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #5a6268 0%, #495057 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(108, 117, 125, 0.3);
        }

        /* Modal Evolu√ß√£o do Paciente */
        .modal-evolucao {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-evolucao.active {
            display: flex;
        }

        .modal-content-evolucao {
            background: white;
            border-radius: 15px;
            width: 100%;
            max-width: 1200px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }

        .modal-header-evolucao {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            padding: 25px 30px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body-evolucao {
            padding: 30px;
        }

        .timeline-evolucao {
            position: relative;
            padding-left: 40px;
        }

        .timeline-evolucao::before {
            content: '';
            position: absolute;
            left: 20px;
            top: 0;
            bottom: 0;
            width: 3px;
            background: linear-gradient(to bottom, #e74c3c, #c0392b);
        }

        .evolucao-item {
            position: relative;
            background: white;
            margin-bottom: 25px;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-left: 4px solid #e74c3c;
        }

        .evolucao-item::before {
            content: '';
            position: absolute;
            left: -45px;
            top: 20px;
            width: 12px;
            height: 12px;
            background: #e74c3c;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .evolucao-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f8f9fa;
        }

        .evolucao-data {
            font-weight: 700;
            color: #e74c3c;
            font-size: 16px;
        }

        .evolucao-tipo {
            background: #e74c3c;
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
        }

        .evolucao-descricao {
            color: #2c3e50;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .evolucao-detalhes {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
        }

        .detalhe-item {
            text-align: center;
        }

        .detalhe-valor {
            font-size: 1.2em;
            font-weight: 700;
            color: #e74c3c;
            margin-bottom: 5px;
        }

        .detalhe-label {
            font-size: 12px;
            color: #7f8c8d;
            text-transform: uppercase;
            font-weight: 600;
        }

        /* Modal Ficha de Atendimento */
        .modal-ficha {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-ficha.active {
            display: flex;
        }

        .modal-content-ficha {
            background: white;
            border-radius: 15px;
            width: 100%;
            max-width: 1400px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }

        .modal-header-ficha {
            background: linear-gradient(135deg, #8e44ad 0%, #9b59b6 100%);
            color: white;
            padding: 25px 30px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body-ficha {
            padding: 30px;
        }

        .ficha-sections {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .ficha-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            border-left: 4px solid #8e44ad;
        }

        .ficha-section h3 {
            color: #8e44ad;
            margin-bottom: 20px;
            font-size: 1.2em;
            font-weight: 700;
            padding-bottom: 10px;
            border-bottom: 2px solid #e9ecef;
        }

        .form-group-ficha {
            margin-bottom: 20px;
        }

        .form-group-ficha label {
            display: block;
            margin-bottom: 8px;
            color: #2c3e50;
            font-weight: 600;
            font-size: 14px;
        }

        .form-group-ficha input,
        .form-group-ficha select,
        .form-group-ficha textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-group-ficha input:focus,
        .form-group-ficha select:focus,
        .form-group-ficha textarea:focus {
            border-color: #8e44ad;
            outline: none;
            box-shadow: 0 0 0 3px rgba(142, 68, 173, 0.1);
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-item input[type="checkbox"] {
            width: auto;
            margin: 0;
        }

        .fotos-section {
            grid-column: 1 / -1;
            margin-top: 20px;
        }

        .fotos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .foto-slot {
            aspect-ratio: 1;
            border: 3px dashed #8e44ad;
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
            position: relative;
            overflow: hidden;
        }

        .foto-slot:hover {
            border-color: #7d3c98;
            background: #f8f4fd;
        }

        .foto-slot img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 12px;
        }

        .foto-slot i {
            font-size: 24px;
            color: #8e44ad;
            margin-bottom: 8px;
        }

        .foto-slot span {
            color: #8e44ad;
            font-size: 12px;
            text-align: center;
        }

        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .btn-nova-evolucao {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 25px;
            transition: all 0.3s ease;
        }

        .btn-nova-evolucao:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.3);
        }

        @media (max-width: 768px) {
            .ficha-sections {
                grid-template-columns: 1fr;
            }
            
            .checkbox-group {
                grid-template-columns: 1fr;
            }
            
            .fotos-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                border-right: none;
                border-bottom: 2px solid #e9ecef;
            }
            
            .btn-voltar {
                position: relative;
                left: 0;
                top: 0;
                transform: none;
                margin-bottom: 15px;
            }
            
            .header h1 {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <div class="header-left">
                    <button class="btn-voltar" onclick="voltarProntuarios()">
                        <i class="fas fa-arrow-left"></i> Voltar aos Prontu√°rios
                    </button>
                </div>
                
                <div class="header-center">
                    <h1><i class="fas fa-book-medical"></i> Caderno Digital do Paciente</h1>
                    <p>Sistema integrado de documenta√ß√£o m√©dica especializada</p>
                </div>
                
                <div class="header-right">
                    <div class="paciente-info" id="pacienteInfoHeader">
                        <div class="prontuario-id" id="prontuarioId">PRON001</div>
                        <h3 id="nomePacienteHeader">Selecione um paciente</h3>
                        <div class="dados" id="dadosPacienteHeader">
                            <div>üìÖ Nascimento: --/--/----</div>
                            <div>üì± Telefone: (--) --------- </div>
                            <div>üìß Email: -------</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="toolbar">
            <button onclick="editarDadosPaciente()" style="background: #fd7e14;">
                <i class="fas fa-user-edit"></i> Editar Dados do Paciente
            </button>
            
            <button onclick="agendarConsultaPaciente()" style="background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);">
                <i class="fas fa-calendar-plus"></i> Agendar Consulta
            </button>
            
            <input type="date" id="dataFiltro" placeholder="Filtrar por data">
            
            <button onclick="novoDocumento()">
                <i class="fas fa-plus"></i> Novo Documento
            </button>
            
            <button onclick="gerarReceita()" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                <i class="fas fa-prescription"></i> Gerar Receita
            </button>
            
            <button onclick="gerarExames()" style="background: linear-gradient(135deg, #17a2b8 0%, #20c997 100%);">
                <i class="fas fa-vial"></i> Gerar Exames
            </button>
            
            <button onclick="abrirEvolucao()" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);">
                <i class="fas fa-chart-line"></i> Evolu√ß√£o Paciente
            </button>
            
            <button onclick="abrirFichaAtendimento()" style="background: linear-gradient(135deg, #8e44ad 0%, #9b59b6 100%);">
                <i class="fas fa-clipboard-check"></i> Ficha Atendimento
            </button>
            
            <button onclick="capturarFoto()">
                <i class="fas fa-camera"></i> Capturar Foto
            </button>
            
            <button onclick="configurarNotificacoes()" style="background: linear-gradient(135deg, #6f42c1 0%, #563d7c 100%);">
                <i class="fas fa-bell"></i> Configurar Notifica√ß√µes
            </button>
            
            <button onclick="mostrarTarefasDoDia()" style="background: linear-gradient(135deg, #20c997 0%, #17a2b8 100%);">
                <i class="fas fa-tasks"></i> Tarefas do Dia
            </button>
            
            <button onclick="exportarPDF()">
                <i class="fas fa-file-pdf"></i> Exportar PDF
            </button>
            
            <button onclick="sincronizar()">
                <i class="fas fa-sync"></i> Sincronizar
            </button>
        </div>

        <div class="main-content">
            <div class="sidebar">
                <!-- Se√ß√£o de A√ß√µes R√°pidas - MOVIDA PARA O TOPO -->
                <h3><i class="fas fa-bolt"></i> A√ß√µes R√°pidas</h3>
                <div class="acoes-rapidas" style="margin-bottom: 30px;">
                    <button onclick="abrirFichaAtendimento()" class="btn-acao" style="background: linear-gradient(135deg, #8e44ad 0%, #9b59b6 100%); margin-bottom: 10px;">
                        <i class="fas fa-clipboard-check"></i> Ficha de Atendimento
                    </button>
                    
                    <button onclick="abrirEvolucao()" class="btn-acao" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); margin-bottom: 10px;">
                        <i class="fas fa-chart-line"></i> Evolu√ß√£o Paciente
                    </button>
                    
                    <button onclick="abrirDocumento('orcamento')" class="btn-acao" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); margin-bottom: 10px;">
                        <i class="fas fa-calculator"></i> Or√ßamento
                    </button>
                    
                    <button onclick="gerarReceita()" class="btn-acao" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); margin-bottom: 10px;">
                        <i class="fas fa-prescription"></i> Gerar Receita
                    </button>
                    
                    <button onclick="gerarExames()" class="btn-acao" style="background: linear-gradient(135deg, #17a2b8 0%, #20c997 100%); margin-bottom: 10px;">
                        <i class="fas fa-vial"></i> Gerar Exames
                    </button>
                    
                    <button onclick="agendarConsultaPaciente()" class="btn-acao" style="background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); margin-bottom: 10px;">
                        <i class="fas fa-calendar-plus"></i> Agendar Consulta
                    </button>
                    
                    <button onclick="capturarFoto()" class="btn-acao" style="background: linear-gradient(135deg, #6c757d 0%, #495057 100%); margin-bottom: 10px;">
                        <i class="fas fa-camera"></i> Tirar Foto
                    </button>
                </div>
                
                <h3><i class="fas fa-folder"></i> Documentos</h3>
                <ul class="document-list" style="margin-bottom: 30px;">
                    <li class="document-item active" onclick="abrirDocumento('orcamento')">
                        <div class="document-header">
                            <div class="document-icon orcamento">
                                <i class="fas fa-calculator"></i>
                            </div>
                            <div class="document-info">
                                <h4>Or√ßamento Cir√∫rgico</h4>
                                <p>Valores e formas de pagamento</p>
                            </div>
                        </div>
                    </li>
                    
                    <li class="document-item" onclick="abrirDocumento('cadastro')">
                        <div class="document-header">
                            <div class="document-icon cadastro">
                                <i class="fas fa-user-plus"></i>
                            </div>
                            <div class="document-info">
                                <h4>Dados do Paciente</h4>
                                <p>Cadastro completo</p>
                            </div>
                        </div>
                    </li>
                    
                    <li class="document-item" onclick="abrirDocumento('jornada')">
                        <div class="document-header">
                            <div class="document-icon jornada">
                                <i class="fas fa-route"></i>
                            </div>
                            <div class="document-info">
                                <h4>Caderno de Jornada</h4>
                                <p>Acompanhamento evolutivo</p>
                            </div>
                        </div>
                    </li>
                    
                    <li class="document-item" onclick="abrirDocumento('acompanhamento')">
                        <div class="document-header">
                            <div class="document-icon acompanhamento">
                                <i class="fas fa-heartbeat"></i>
                            </div>
                            <div class="document-info">
                                <h4>Acompanhamento</h4>
                                <p>Follow-up p√≥s-operat√≥rio</p>
                            </div>
                        </div>
                    </li>
                    
                    <li class="document-item" onclick="abrirDocumento('receita')">
                        <div class="document-header">
                            <div class="document-icon receita">
                                <i class="fas fa-prescription-bottle-alt"></i>
                            </div>
                            <div class="document-info">
                                <h4>Receitas</h4>
                                <p>Prescri√ß√µes m√©dicas</p>
                            </div>
                        </div>
                    </li>
                    
                    <li class="document-item" onclick="abrirDocumento('exames')">
                        <div class="document-header">
                            <div class="document-icon exames">
                                <i class="fas fa-vials"></i>
                            </div>
                            <div class="document-info">
                                <h4>Pedido de Exames</h4>
                                <p>Solicita√ß√µes laboratoriais</p>
                            </div>
                        </div>
                    </li>
                </ul>
                
                <!-- Se√ß√£o de Hist√≥rico de Agendamentos - MOVIDA PARA BAIXO -->
                <h3><i class="fas fa-calendar-alt"></i> Hist√≥rico & Marcos</h3>
                <div class="historico-container">
                    <div class="marcos-principais" id="marcosPrincipais">
                        <!-- Marcos ser√£o carregados aqui -->
                    </div>
                    <div class="agendamentos-recentes">
                        <h4 style="color: #6c757d; font-size: 14px; margin: 15px 0 10px 0;">
                            <i class="fas fa-clock"></i> Consultas Recentes
                        </h4>
                        <div id="agendamentosRecentes">
                            <!-- Agendamentos ser√£o carregados aqui -->
                        </div>
                    </div>
                </div>
            </div>

            <div class="canvas-area">
                <!-- Placeholder inicial -->
                <div class="canvas-placeholder" id="placeholder">
                    <i class="fas fa-book-open"></i>
                    <h3>Selecione um documento para come√ßar</h3>
                    <p>Escolha um tipo de documento no menu lateral</p>
                </div>

                <!-- Formul√°rio de Or√ßamento -->
                <div class="document-form" id="orcamento-form">
                    <div class="form-section">
                        <h3><i class="fas fa-calculator"></i> Or√ßamento Cir√∫rgico</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Nome Completo</label>
                                <input type="text" id="orcamento-nome" placeholder="Nome do paciente">
                            </div>
                            <div class="form-group">
                                <label>Cirurgia</label>
                                <input type="text" id="orcamento-cirurgia" placeholder="Tipo de cirurgia">
                            </div>
                            <div class="form-group">
                                <label>Valor Cl√≠nica</label>
                                <input type="number" id="orcamento-valor-clinica" placeholder="0,00">
                            </div>
                            <div class="form-group">
                                <label>Valor Hospital</label>
                                <input type="number" id="orcamento-valor-hospital" placeholder="0,00">
                            </div>
                        </div>
                        
                        <h4>Forma de Pagamento</h4>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>
                                    <input type="radio" name="pagamento" value="vista"> 
                                    Pagamento √† vista (3% desconto)
                                </label>
                            </div>
                            <div class="form-group">
                                <label>
                                    <input type="radio" name="pagamento" value="3x"> 
                                    Em at√© 3x (5% acr√©scimo)
                                </label>
                            </div>
                            <div class="form-group">
                                <label>
                                    <input type="radio" name="pagamento" value="10x"> 
                                    Em at√© 10x (10% acr√©scimo)
                                </label>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Hospital</label>
                            <input type="text" id="orcamento-hospital" placeholder="Hospital onde ser√° realizada">
                        </div>
                        
                        <div class="form-group">
                            <label>Observa√ß√µes</label>
                            <textarea id="orcamento-obs" rows="4" placeholder="Informa√ß√µes adicionais"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label>Modelo de Or√ßamento</label>
                            <div class="document-actions">
                                <button type="button" onclick="visualizarOrcamentoModelo()" class="btn-modelo">
                                    <i class="fas fa-file-pdf"></i> Ver Modelo PDF
                                </button>
                                <button type="button" onclick="baixarOrcamentoModelo()" class="btn-download">
                                    <i class="fas fa-download"></i> Baixar Modelo
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Formul√°rio de Cadastro -->
                <div class="document-form" id="cadastro-form">
                    <div class="form-section">
                        <h3><i class="fas fa-user-plus"></i> Dados do Paciente</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Nome Completo</label>
                                <input type="text" id="cadastro-nome" placeholder="Nome completo">
                            </div>
                            <div class="form-group">
                                <label>CPF</label>
                                <input type="text" id="cadastro-cpf" placeholder="000.000.000-00">
                            </div>
                            <div class="form-group">
                                <label>Data de Nascimento</label>
                                <input type="date" id="cadastro-nascimento">
                            </div>
                            <div class="form-group">
                                <label>E-mail</label>
                                <input type="email" id="cadastro-email" placeholder="email@exemplo.com">
                            </div>
                            <div class="form-group">
                                <label>Celular</label>
                                <input type="tel" id="cadastro-celular" placeholder="(11) 99999-9999">
                            </div>
                            <div class="form-group">
                                <label>Telefone</label>
                                <input type="tel" id="cadastro-telefone" placeholder="(11) 3333-3333">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Endere√ßo Completo</label>
                            <textarea id="cadastro-endereco" rows="3" placeholder="Rua, n√∫mero, complemento, bairro, cidade, CEP"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Caderno de Jornada -->
                <div class="document-form" id="jornada-form">
                    <div class="form-section">
                        <h3><i class="fas fa-route"></i> Caderno de Jornada - Acompanhamento Evolutivo</h3>
                        
                        <div class="annotation-tools">
                            <button class="tool-btn active" onclick="selecionarFerramenta('texto')">
                                <i class="fas fa-font"></i> Texto
                            </button>
                            <button class="tool-btn" onclick="selecionarFerramenta('desenho')">
                                <i class="fas fa-pencil-alt"></i> Desenho
                            </button>
                            <button class="tool-btn" onclick="selecionarFerramenta('regua')">
                                <i class="fas fa-ruler"></i> R√©gua
                            </button>
                            <button class="tool-btn" onclick="selecionarFerramenta('marca')">
                                <i class="fas fa-highlighter"></i> Marcador
                            </button>
                            <button class="tool-btn" onclick="selecionarFerramenta('foto')">
                                <i class="fas fa-camera"></i> Foto
                            </button>
                        </div>
                        
                        <div class="evolution-timeline">
                            <h4>Timeline de Evolu√ß√£o</h4>
                            <div class="timeline-item">
                                <div class="timeline-marker">
                                    <i class="fas fa-plus"></i>
                                </div>
                                <div class="timeline-content">
                                    <div class="timeline-date">29/07/2025 - 10:30</div>
                                    <div class="timeline-title">Consulta Inicial</div>
                                    <p>Avalia√ß√£o inicial do paciente. Estado geral bom, sem comorbidades significativas.</p>
                                </div>
                            </div>
                            
                            <div class="timeline-item">
                                <div class="timeline-marker">
                                    <i class="fas fa-stethoscope"></i>
                                </div>
                                <div class="timeline-content">
                                    <div class="timeline-date">02/08/2025 - 14:00</div>
                                    <div class="timeline-title">Pr√©-operat√≥rio</div>
                                    <p>Exames pr√©-operat√≥rios realizados. Paciente apto para cirurgia.</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Nova Evolu√ß√£o</label>
                            <textarea id="nova-evolucao" rows="4" placeholder="Descreva a evolu√ß√£o do paciente..."></textarea>
                            <button type="button" onclick="adicionarEvolucao()" style="margin-top: 10px; background: #2ecc71; color: white; border: none; padding: 10px 20px; border-radius: 5px;">
                                <i class="fas fa-plus"></i> Adicionar Evolu√ß√£o
                            </button>
                        </div>
                        
                        <div class="photo-upload" onclick="document.getElementById('foto-input').click()">
                            <i class="fas fa-camera"></i>
                            <h4>Capturar ou Adicionar Foto</h4>
                            <p>Clique para capturar uma foto ou selecionar da galeria</p>
                            <input type="file" id="foto-input" accept="image/*" style="display: none;" onchange="adicionarFoto(this)">
                        </div>
                        
                        <div class="photo-gallery" id="galeria-fotos">
                            <!-- Fotos ser√£o adicionadas aqui dinamicamente -->
                        </div>
                    </div>
                </div>

                <!-- Outros formul√°rios similares para acompanhamento, receita, exames -->
                <div class="document-form" id="acompanhamento-form">
                    <div class="form-section">
                        <h3><i class="fas fa-heartbeat"></i> Formul√°rio de Acompanhamento</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Data da Consulta</label>
                                <input type="date" id="acomp-data">
                            </div>
                            <div class="form-group">
                                <label>Peso Atual</label>
                                <input type="number" id="acomp-peso" placeholder="kg">
                            </div>
                            <div class="form-group">
                                <label>Press√£o Arterial</label>
                                <input type="text" id="acomp-pressao" placeholder="120/80">
                            </div>
                            <div class="form-group">
                                <label>Sintomas</label>
                                <textarea id="acomp-sintomas" rows="3" placeholder="Descreva sintomas ou queixas"></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="document-form" id="receita-form">
                    <div class="form-section">
                        <h3><i class="fas fa-prescription-bottle-alt"></i> Receita M√©dica</h3>
                        <div class="form-group">
                            <label>Medicamentos Prescritos</label>
                            <textarea id="receita-medicamentos" rows="6" placeholder="1. Medicamento - Posologia - Dura√ß√£o&#10;2. Medicamento - Posologia - Dura√ß√£o"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Orienta√ß√µes Gerais</label>
                            <textarea id="receita-orientacoes" rows="4" placeholder="Orienta√ß√µes adicionais para o paciente"></textarea>
                        </div>
                    </div>
                </div>

                <div class="document-form" id="exames-form">
                    <div class="form-section">
                        <h3><i class="fas fa-vials"></i> Pedido de Exames</h3>
                        <div class="form-group">
                            <label>Exames Solicitados</label>
                            <textarea id="exames-lista" rows="6" placeholder="Liste os exames solicitados:&#10;- Hemograma completo&#10;- Glicemia de jejum&#10;- etc."></textarea>
                        </div>
                        <div class="form-group">
                            <label>Justificativa</label>
                            <textarea id="exames-justificativa" rows="3" placeholder="Justificativa cl√≠nica para os exames"></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <button class="save-btn" onclick="salvarDocumento()">
            <i class="fas fa-save"></i> Salvar Documento
        </button>
    </div>

    <!-- Modal para Gerar Receita -->
    <div id="modal-receita" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 900px; width: 90%;">
            <div class="modal-header">
                <h2><i class="fas fa-prescription"></i> Gerar Receita M√©dica</h2>
                <button onclick="fecharModal('modal-receita')" class="btn-close">√ó</button>
            </div>
            
            <div class="modal-body">
                <div style="display: flex; gap: 20px;">
                    <!-- √Årea principal de edi√ß√£o -->
                    <div style="flex: 2;">
                        <div class="form-group">
                            <label>Prescri√ß√£o:</label>
                            <textarea id="receita-texto" rows="15" 
                                style="width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 8px; font-family: 'Courier New', monospace;"
                                placeholder="Digite a prescri√ß√£o m√©dica aqui...&#10;&#10;Exemplo:&#10;1. Dipirona 500mg - Tomar 1 comprimido de 6/6h por 5 dias&#10;2. Omeprazol 20mg - Tomar 1 c√°psula em jejum por 7 dias"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label>Orienta√ß√µes Gerais:</label>
                            <textarea id="receita-orientacoes" rows="3" 
                                style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px;"
                                placeholder="Orienta√ß√µes adicionais ao paciente..."></textarea>
                        </div>
                    </div>
                    
                    <!-- Textos pr√©-configurados -->
                    <div style="flex: 1;">
                        <h4>üìù Textos Pr√©-configurados</h4>
                        <div class="preset-texts">
                            <button onclick="inserirTextoReceita('antibiotico')" class="preset-btn">Antibi√≥tico</button>
                            <button onclick="inserirTextoReceita('analgesia')" class="preset-btn">Analgesia</button>
                            <button onclick="inserirTextoReceita('anti-inflamatorio')" class="preset-btn">Anti-inflamat√≥rio</button>
                            <button onclick="inserirTextoReceita('pos-operatorio')" class="preset-btn">P√≥s-operat√≥rio</button>
                            <button onclick="inserirTextoReceita('vitaminas')" class="preset-btn">Vitaminas</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button onclick="assinarDigitalmente('receita')" class="btn-primary" style="background: #28a745;">
                    <i class="fas fa-signature"></i> Assinar Digitalmente (VIDAAS)
                </button>
                <button onclick="gerarPDFReceita()" class="btn-primary" style="background: #dc3545;">
                    <i class="fas fa-file-pdf"></i> Gerar PDF
                </button>
                <button onclick="imprimirReceita()" class="btn-primary" style="background: #6f42c1;">
                    <i class="fas fa-print"></i> Imprimir
                </button>
                <button onclick="enviarPorEmail('receita')" class="btn-secondary">
                    <i class="fas fa-envelope"></i> Enviar por Email
                </button>
            </div>
        </div>
    </div>

    <!-- Modal para Gerar Exames -->
    <div id="modal-exames" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 900px; width: 90%;">
            <div class="modal-header">
                <h2><i class="fas fa-vial"></i> Gerar Solicita√ß√£o de Exames</h2>
                <button onclick="fecharModal('modal-exames')" class="btn-close">√ó</button>
            </div>
            
            <div class="modal-body">
                <div style="display: flex; gap: 20px;">
                    <!-- √Årea principal de edi√ß√£o -->
                    <div style="flex: 2;">
                        <div class="form-group">
                            <label>Exames Solicitados:</label>
                            <textarea id="exames-texto" rows="12" 
                                style="width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 8px; font-family: 'Courier New', monospace;"
                                placeholder="Digite os exames solicitados...&#10;&#10;Exemplo:&#10;‚ñ° Hemograma completo&#10;‚ñ° Glicemia de jejum&#10;‚ñ° Colesterol total e fra√ß√µes&#10;‚ñ° Ureia e creatinina"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label>Justificativa Cl√≠nica:</label>
                            <textarea id="exames-justificativa" rows="3" 
                                style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px;"
                                placeholder="Justificativa para solicita√ß√£o dos exames..."></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label>CID-10:</label>
                            <input type="text" id="exames-cid" 
                                style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px;"
                                placeholder="Ex: Z01.0 - Exame m√©dico geral">
                        </div>
                    </div>
                    
                    <!-- Exames pr√©-configurados -->
                    <div style="flex: 1;">
                        <h4>üß™ Exames Pr√©-configurados</h4>
                        <div class="preset-texts">
                            <button onclick="inserirTextoExames('rotina')" class="preset-btn">Check-up Rotina</button>
                            <button onclick="inserirTextoExames('pre-operatorio')" class="preset-btn">Pr√©-operat√≥rio</button>
                            <button onclick="inserirTextoExames('cardiologico')" class="preset-btn">Cardiol√≥gico</button>
                            <button onclick="inserirTextoExames('diabetes')" class="preset-btn">Diabetes</button>
                            <button onclick="inserirTextoExames('tireoide')" class="preset-btn">Tireoide</button>
                            <button onclick="inserirTextoExames('hepatico')" class="preset-btn">Fun√ß√£o Hep√°tica</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button onclick="assinarDigitalmente('exames')" class="btn-primary" style="background: #28a745;">
                    <i class="fas fa-signature"></i> Assinar Digitalmente (VIDAAS)
                </button>
                <button onclick="gerarPDFExames()" class="btn-primary" style="background: #dc3545;">
                    <i class="fas fa-file-pdf"></i> Gerar PDF
                </button>
                <button onclick="imprimirExames()" class="btn-primary" style="background: #6f42c1;">
                    <i class="fas fa-print"></i> Imprimir
                </button>
                <button onclick="enviarPorEmail('exames')" class="btn-secondary">
                    <i class="fas fa-envelope"></i> Enviar por Email
                </button>
            </div>
        </div>
    </div>

    <script src="caderno-digital-functions.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        let documentoAtivo = 'orcamento';
        let ferramentaAtiva = 'texto';
        let fotos = [];

        function voltarDashboard() {
            window.location.href = 'dashboard.html';
        }

        function abrirDocumento(tipo) {
            // Remove classe active de todos os itens
            document.querySelectorAll('.document-item').forEach(item => {
                item.classList.remove('active');
            });

            // Adiciona active ao item clicado
            event.currentTarget.classList.add('active');

            // Oculta todos os formul√°rios
            document.querySelectorAll('.document-form').forEach(form => {
                form.classList.remove('active');
            });

            // Oculta placeholder
            document.getElementById('placeholder').style.display = 'none';

            // Mostra formul√°rio espec√≠fico
            document.getElementById(tipo + '-form').classList.add('active');
            documentoAtivo = tipo;
        }

        function selecionarFerramenta(ferramenta) {
            document.querySelectorAll('.tool-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.currentTarget.classList.add('active');
            ferramentaAtiva = ferramenta;

            // Implementar l√≥gica espec√≠fica de cada ferramenta
            console.log('Ferramenta selecionada:', ferramenta);
        }

        function adicionarFoto(input) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const fotoData = {
                        id: Date.now(),
                        src: e.target.result,
                        nome: file.name,
                        data: new Date().toLocaleString('pt-BR')
                    };
                    
                    fotos.push(fotoData);
                    renderizarGaleria();
                };
                reader.readAsDataURL(file);
            }
        }

        function renderizarGaleria() {
            const galeria = document.getElementById('galeria-fotos');
            galeria.innerHTML = '';

            fotos.forEach(foto => {
                const item = document.createElement('div');
                item.className = 'photo-item';
                item.innerHTML = `
                    <img src="${foto.src}" alt="${foto.nome}">
                    <div class="photo-overlay">
                        <div class="photo-actions">
                            <button onclick="editarFoto(${foto.id})" title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="adicionarAnotacao(${foto.id})" title="Anotar">
                                <i class="fas fa-pencil-alt"></i>
                            </button>
                            <button onclick="removerFoto(${foto.id})" title="Remover">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                galeria.appendChild(item);
            });
        }

        function capturarFoto() {
            cadernoDigital.capturarFoto();
        }

        function selecionarFerramenta(ferramenta) {
            document.querySelectorAll('.tool-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.currentTarget.classList.add('active');
            cadernoDigital.ativarFerramenta(ferramenta);
        }

        function exportarPDF() {
            cadernoDigital.exportarPDF();
        }

        function sincronizar() {
            cadernoDigital.sincronizarDados();
        }

        function adicionarFoto(input) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const fotoData = {
                        id: Date.now(),
                        src: e.target.result,
                        nome: file.name,
                        timestamp: new Date().toISOString()
                    };
                    
                    cadernoDigital.fotos.push(fotoData);
                    cadernoDigital.renderizarGaleria();
                };
                reader.readAsDataURL(file);
            }
        }

        function adicionarEvolucao() {
            const textoEvolucao = document.getElementById('nova-evolucao').value;
            if (textoEvolucao.trim()) {
                const timeline = document.querySelector('.evolution-timeline');
                const novaEvolucao = document.createElement('div');
                novaEvolucao.className = 'timeline-item';
                novaEvolucao.innerHTML = `
                    <div class="timeline-marker">
                        <i class="fas fa-notes-medical"></i>
                    </div>
                    <div class="timeline-content">
                        <div class="timeline-date">${new Date().toLocaleString('pt-BR')}</div>
                        <div class="timeline-title">Nova Evolu√ß√£o</div>
                        <p>${textoEvolucao}</p>
                    </div>
                `;
                timeline.appendChild(novaEvolucao);
                document.getElementById('nova-evolucao').value = '';
            }
        }

        function editarFoto(id) {
            console.log('Editando foto:', id);
            // Implementar editor de imagem
        }

        function adicionarAnotacao(id) {
            console.log('Adicionando anota√ß√£o √† foto:', id);
            // Implementar sistema de anota√ß√µes
        }

        function removerFoto(id) {
            fotos = fotos.filter(foto => foto.id !== id);
            renderizarGaleria();
        }

        function novoDocumento() {
            if (confirm('Criar novo documento? Os dados n√£o salvos ser√£o perdidos.')) {
                document.querySelectorAll('input, textarea').forEach(field => {
                    field.value = '';
                });
                fotos = [];
                renderizarGaleria();
            }
        }

        function salvarDocumento() {
            const dadosDocumento = {
                tipo: documentoAtivo,
                data: new Date().toISOString(),
                dados: {},
                fotos: fotos
            };

            // Coletar dados espec√≠ficos do documento ativo
            const formulario = document.getElementById(documentoAtivo + '-form');
            const campos = formulario.querySelectorAll('input, textarea, select');
            
            campos.forEach(campo => {
                if (campo.type === 'radio') {
                    if (campo.checked) {
                        dadosDocumento.dados[campo.name] = campo.value;
                    }
                } else {
                    dadosDocumento.dados[campo.id] = campo.value;
                }
            });

            // Salvar no localStorage (em produ√ß√£o, enviar para servidor)
            const documentosSalvos = JSON.parse(localStorage.getItem('cadernoDigital') || '[]');
            documentosSalvos.push(dadosDocumento);
            localStorage.setItem('cadernoDigital', JSON.stringify(documentosSalvos));

            alert('Documento salvo com sucesso!');
        }

        function exportarPDF() {
            alert('Exportando para PDF... (Funcionalidade em desenvolvimento)');
        }

        function sincronizar() {
            alert('Sincronizando com o servidor... (Funcionalidade em desenvolvimento)');
        }

        // === FUN√á√ïES PARA RECEITA M√âDICA ===
        function gerarReceita() {
            document.getElementById('modal-receita').style.display = 'flex';
        }

        function gerarExames() {
            document.getElementById('modal-exames').style.display = 'flex';
        }

        function fecharModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Textos pr√©-configurados para receitas
        const textosReceita = {
            antibiotico: `1. Amoxicilina 500mg - Tomar 1 c√°psula de 8/8h por 7 dias
2. Omeprazol 20mg - Tomar 1 c√°psula em jejum por 7 dias (protetor g√°strico)`,
            
            analgesia: `1. Dipirona 500mg - Tomar 1 comprimido de 6/6h se dor (m√°ximo 4x/dia)
2. Paracetamol 750mg - Tomar 1 comprimido de 8/8h se necess√°rio`,
            
            'anti-inflamatorio': `1. Ibuprofeno 600mg - Tomar 1 comprimido de 8/8h por 5 dias (ap√≥s alimenta√ß√£o)
2. Omeprazol 20mg - Tomar 1 c√°psula em jejum por 7 dias`,
            
            'pos-operatorio': `1. Dipirona 500mg - Tomar 1 comprimido de 6/6h por 3 dias
2. Amoxicilina + Clavulanato 875mg - Tomar 1 comprimido de 12/12h por 7 dias
3. Omeprazol 20mg - Tomar 1 c√°psula em jejum por 7 dias
4. Aplicar gelo local 15min de 4/4h nas primeiras 48h`,
            
            vitaminas: `1. Complexo B - Tomar 1 comprimido ao dia por 30 dias
2. Vitamina D3 2000UI - Tomar 1 c√°psula ao dia por 30 dias
3. Vitamina C 1g - Tomar 1 comprimido ao dia por 30 dias`
        };

        // Textos pr√©-configurados para exames
        const textosExames = {
            rotina: `‚ñ° Hemograma completo
‚ñ° Glicemia de jejum
‚ñ° Colesterol total e fra√ß√µes
‚ñ° Triglicer√≠deos
‚ñ° Ureia e creatinina
‚ñ° TGO e TGP
‚ñ° Urina tipo 1`,
            
            'pre-operatorio': `‚ñ° Hemograma completo
‚ñ° Coagulograma (TAP/PTT)
‚ñ° Glicemia de jejum
‚ñ° Ureia e creatinina
‚ñ° S√≥dio e pot√°ssio
‚ñ° ECG
‚ñ° Raio-X de t√≥rax`,
            
            cardiologico: `‚ñ° ECG de repouso
‚ñ° Ecocardiograma
‚ñ° Teste ergom√©trico
‚ñ° Colesterol total e fra√ß√µes
‚ñ° Triglicer√≠deos
‚ñ° PCR ultrassens√≠vel`,
            
            diabetes: `‚ñ° Glicemia de jejum
‚ñ° Hemoglobina glicada (HbA1c)
‚ñ° Insulina de jejum
‚ñ° Pept√≠deo C
‚ñ° Microalbumin√∫ria
‚ñ° Fundo de olho`,
            
            tireoide: `‚ñ° TSH
‚ñ° T4 livre
‚ñ° T3 livre
‚ñ° Anti-TPO
‚ñ° Anti-tireoglobulina
‚ñ° Ultrassom de tireoide`,
            
            hepatico: `‚ñ° TGO (AST)
‚ñ° TGP (ALT)
‚ñ° GGT
‚ñ° Fosfatase alcalina
‚ñ° Bilirrubinas (total e fra√ß√µes)
‚ñ° Albumina`
        };

        function inserirTextoReceita(tipo) {
            const textarea = document.getElementById('receita-texto');
            const textoAtual = textarea.value;
            const novoTexto = textosReceita[tipo];
            
            if (textoAtual.trim() === '') {
                textarea.value = novoTexto;
            } else {
                textarea.value = textoAtual + '\n\n' + novoTexto;
            }
            
            // Focar no textarea
            textarea.focus();
            textarea.setSelectionRange(textarea.value.length, textarea.value.length);
        }

        function inserirTextoExames(tipo) {
            const textarea = document.getElementById('exames-texto');
            const textoAtual = textarea.value;
            const novoTexto = textosExames[tipo];
            
            if (textoAtual.trim() === '') {
                textarea.value = novoTexto;
            } else {
                textarea.value = textoAtual + '\n\n' + novoTexto;
            }
            
            // Focar no textarea
            textarea.focus();
            textarea.setSelectionRange(textarea.value.length, textarea.value.length);
        }

        // Fun√ß√£o para assinatura digital via VIDAAS
        function assinarDigitalmente(tipo) {
            try {
                // Tentar abrir o VIDAAS
                const vidaasUrl = 'vidaas://assinar';
                
                // Criar link tempor√°rio para abrir o app
                const link = document.createElement('a');
                link.href = vidaasUrl;
                link.click();
                
                // Fallback: se n√£o conseguir abrir o app, mostrar instru√ß√µes
                setTimeout(() => {
                    const confirmar = confirm(`üì± Tentando abrir o VIDAAS para assinatura digital...

Se o aplicativo n√£o abriu automaticamente:
1. Abra o VIDAAS manualmente
2. Selecione o documento de ${tipo}
3. Realize a assinatura digital

Deseja continuar com a gera√ß√£o do PDF ap√≥s assinar?`);
                    
                    if (confirmar) {
                        if (tipo === 'receita') {
                            gerarPDFReceita();
                        } else {
                            gerarPDFExames();
                        }
                    }
                }, 1000);
                
            } catch (error) {
                alert('‚ùå Erro ao tentar abrir o VIDAAS. Abra o aplicativo manualmente para assinar o documento.');
                console.error('Erro:', error);
            }
        }

        // Fun√ß√£o para gerar PDF da receita
        function gerarPDFReceita() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Cabe√ßalho
            doc.setFontSize(18);
            doc.setFont(undefined, 'bold');
            doc.text('RECEITA M√âDICA', 105, 30, { align: 'center' });
            
            // Dados do m√©dico
            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            doc.text('Dr. Marcio Scartozzoni', 20, 50);
            doc.text('CRM: [N√öMERO]', 20, 60);
            doc.text('Especialidade: [ESPECIALIDADE]', 20, 70);
            
            // Data
            const hoje = new Date().toLocaleDateString('pt-BR');
            doc.text(`Data: ${hoje}`, 150, 50);
            
            // Paciente
            const pacienteSelecionado = document.getElementById('pacienteSelect').value;
            doc.text(`Paciente: ${pacienteSelecionado || '[Nome do Paciente]'}`, 20, 90);
            
            // Prescri√ß√£o
            doc.setFont(undefined, 'bold');
            doc.text('PRESCRI√á√ÉO:', 20, 110);
            
            doc.setFont(undefined, 'normal');
            const prescricao = document.getElementById('receita-texto').value || '[Prescri√ß√£o n√£o informada]';
            const linhasPrescricao = doc.splitTextToSize(prescricao, 170);
            doc.text(linhasPrescricao, 20, 125);
            
            // Orienta√ß√µes
            const orientacoes = document.getElementById('receita-orientacoes').value;
            if (orientacoes) {
                doc.setFont(undefined, 'bold');
                doc.text('ORIENTA√á√ïES:', 20, 125 + (linhasPrescricao.length * 7) + 15);
                
                doc.setFont(undefined, 'normal');
                const linhasOrientacoes = doc.splitTextToSize(orientacoes, 170);
                doc.text(linhasOrientacoes, 20, 125 + (linhasPrescricao.length * 7) + 30);
            }
            
            // Assinatura
            doc.setFont(undefined, 'bold');
            doc.text('_________________________________', 20, 250);
            doc.text('Dr. Marcio Scartozzoni', 20, 260);
            doc.text('CRM: [N√öMERO]', 20, 270);
            
            // Gerar e abrir PDF
            const pdfBlob = doc.output('blob');
            const pdfUrl = URL.createObjectURL(pdfBlob);
            window.open(pdfUrl, '_blank');
            
            alert('‚úÖ PDF da receita gerado com sucesso!');
        }

        // Fun√ß√£o para gerar PDF dos exames
        function gerarPDFExames() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Cabe√ßalho
            doc.setFontSize(18);
            doc.setFont(undefined, 'bold');
            doc.text('SOLICITA√á√ÉO DE EXAMES', 105, 30, { align: 'center' });
            
            // Dados do m√©dico
            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            doc.text('Dr. Marcio Scartozzoni', 20, 50);
            doc.text('CRM: [N√öMERO]', 20, 60);
            doc.text('Especialidade: [ESPECIALIDADE]', 20, 70);
            
            // Data
            const hoje = new Date().toLocaleDateString('pt-BR');
            doc.text(`Data: ${hoje}`, 150, 50);
            
            // Paciente
            const pacienteSelecionado = document.getElementById('pacienteSelect').value;
            doc.text(`Paciente: ${pacienteSelecionado || '[Nome do Paciente]'}`, 20, 90);
            
            // CID
            const cid = document.getElementById('exames-cid').value;
            if (cid) {
                doc.text(`CID-10: ${cid}`, 20, 100);
            }
            
            // Exames solicitados
            doc.setFont(undefined, 'bold');
            doc.text('EXAMES SOLICITADOS:', 20, 120);
            
            doc.setFont(undefined, 'normal');
            const exames = document.getElementById('exames-texto').value || '[Exames n√£o informados]';
            const linhasExames = doc.splitTextToSize(exames, 170);
            doc.text(linhasExames, 20, 135);
            
            // Justificativa
            const justificativa = document.getElementById('exames-justificativa').value;
            if (justificativa) {
                doc.setFont(undefined, 'bold');
                doc.text('JUSTIFICATIVA CL√çNICA:', 20, 135 + (linhasExames.length * 7) + 15);
                
                doc.setFont(undefined, 'normal');
                const linhasJustificativa = doc.splitTextToSize(justificativa, 170);
                doc.text(linhasJustificativa, 20, 135 + (linhasExames.length * 7) + 30);
            }
            
            // Assinatura
            doc.setFont(undefined, 'bold');
            doc.text('_________________________________', 20, 250);
            doc.text('Dr. Marcio Scartozzoni', 20, 260);
            doc.text('CRM: [N√öMERO]', 20, 270);
            
            // Gerar e abrir PDF
            const pdfBlob = doc.output('blob');
            const pdfUrl = URL.createObjectURL(pdfBlob);
            window.open(pdfUrl, '_blank');
            
            alert('‚úÖ PDF da solicita√ß√£o de exames gerado com sucesso!');
        }

        // Fun√ß√£o para imprimir receita
        function imprimirReceita() {
            gerarPDFReceita();
            setTimeout(() => {
                window.print();
            }, 1000);
        }

        // Fun√ß√£o para imprimir exames
        function imprimirExames() {
            gerarPDFExames();
            setTimeout(() => {
                window.print();
            }, 1000);
        }

        // Fun√ß√£o para enviar por email
        function enviarPorEmail(tipo) {
            const assunto = tipo === 'receita' ? 'Receita M√©dica' : 'Solicita√ß√£o de Exames';
            const paciente = document.getElementById('pacienteSelect').value || '[Nome do Paciente]';
            
            const corpo = `Ol√°,

Segue em anexo ${tipo === 'receita' ? 'a receita m√©dica' : 'a solicita√ß√£o de exames'} para o paciente: ${paciente}

Data: ${new Date().toLocaleDateString('pt-BR')}

Atenciosamente,
Dr. Marcio Scartozzoni`;

            // Abrir cliente de email
            const mailtoLink = `mailto:?subject=${encodeURIComponent(assunto)}&body=${encodeURIComponent(corpo)}`;
            window.location.href = mailtoLink;
            
            alert(`üìß Cliente de email aberto. Anexe o PDF da ${tipo} antes de enviar.`);
        }

        // Fechar modais clicando fora
        window.addEventListener('click', function(event) {
            if (event.target.classList.contains('modal-overlay')) {
                event.target.style.display = 'none';
            }
        });

        // Fun√ß√µes para o modelo de or√ßamento
        function visualizarOrcamentoModelo() {
            // Abrir o PDF em uma nova aba
            window.open('/public/docs/Orcamento.pdf', '_blank');
        }

        function baixarOrcamentoModelo() {
            // Criar link de download
            const link = document.createElement('a');
            link.href = '/public/docs/Orcamento.pdf';
            link.download = 'Modelo_Orcamento_Dr_Marcio.pdf';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Carregar pacientes ao inicializar
        // Verifica√ß√£o de autentica√ß√£o
        function checkAuth() {
            const userInfo = localStorage.getItem('userInfo');
            
            if (!userInfo) {
                console.log('‚ùå Nenhuma sess√£o encontrada - redirecionando para login');
                window.location.href = '/login.html';
                return false;
            }
            
            const user = JSON.parse(userInfo);
            console.log('üë§ Usu√°rio logado:', user.nome, '| Tipo:', user.tipo, '| Autorizado:', user.autorizado);
            
            // Verificar se funcion√°rio est√° autorizado
            if (user.tipo === 'funcionario' && !user.autorizado) {
                console.log('‚õî Funcion√°rio n√£o autorizado - redirecionando para login');
                alert('‚ö†Ô∏è Seu acesso ainda n√£o foi autorizado pelo administrador.\n\nVoc√™ ser√° redirecionado para a tela de login.');
                localStorage.removeItem('userInfo');
                window.location.href = '/login.html';
                return false;
            }
            
            return true;
        }

        window.onload = function() {
            // Verificar autoriza√ß√£o primeiro
            if (!checkAuth()) {
                return; // N√£o continuar carregamento se n√£o autorizado
            }
            
            // Inicializar caderno digital
            cadernoDigital.inicializar();
            
            // Verificar se existe paciente vindo da Gest√£o
            const pacienteDaGestao = localStorage.getItem('pacienteCaderno');
            
            // Simular carregamento de pacientes
            const pacientes = [
                'Jo√£o Silva',
                'Maria Santos', 
                'Pedro Oliveira',
                'Ana Costa'
            ];

            const select = document.getElementById('pacienteSelect');
            
            // Se veio da gest√£o, adicionar o paciente no topo da lista
            if (pacienteDaGestao) {
                const dadosPaciente = JSON.parse(pacienteDaGestao);
                
                // Criar op√ß√£o para o paciente da gest√£o
                const optionGestao = document.createElement('option');
                optionGestao.value = dadosPaciente.nome;
                optionGestao.textContent = `${dadosPaciente.nome} (ID: ${dadosPaciente.id})`;
                optionGestao.selected = true;
                select.appendChild(optionGestao);
                
                // Mostrar informa√ß√µes do paciente
                mostrarInfoPacienteGestao(dadosPaciente);
                
                // Limpar dados do localStorage ap√≥s uso
                localStorage.removeItem('pacienteCaderno');
            }

            pacientes.forEach(paciente => {
                const option = document.createElement('option');
                option.value = paciente;
                option.textContent = paciente;
                select.appendChild(option);
            });
        };
        
        // Fun√ß√£o para mostrar informa√ß√µes do paciente da gest√£o
        function mostrarInfoPacienteGestao(dadosPaciente) {
            // Adicionar uma notifica√ß√£o visual no topo do caderno
            const infoDiv = document.createElement('div');
            infoDiv.className = 'paciente-gestao-info';
            infoDiv.innerHTML = `
                <div style="background: #e8f5e8; border: 2px solid #27ae60; border-radius: 8px; padding: 15px; margin: 10px 0; color: #2c3e50;">
                    <h4 style="margin: 0 0 10px 0; color: #27ae60;">
                        <i class="fas fa-user-check"></i> Paciente da Gest√£o
                    </h4>
                    <p style="margin: 5px 0;"><strong>Nome:</strong> ${dadosPaciente.nome}</p>
                    <p style="margin: 5px 0;"><strong>ID:</strong> ${dadosPaciente.id}</p>
                    <p style="margin: 5px 0;"><strong>Status Geral:</strong> ${dadosPaciente.statusGeral}</p>
                    ${dadosPaciente.dataUltimaConsulta ? `<p style="margin: 5px 0;"><strong>√öltima Consulta:</strong> ${formatarDataBrasil(dadosPaciente.dataUltimaConsulta)}</p>` : ''}
                    ${dadosPaciente.observacoes ? `<p style="margin: 5px 0;"><strong>Observa√ß√µes:</strong> ${dadosPaciente.observacoes}</p>` : ''}
                </div>
            `;
            
            // Inserir ap√≥s o header
            const container = document.querySelector('.container');
            const header = container.querySelector('.header');
            container.insertBefore(infoDiv, header.nextSibling);
        }
        
        // ============ FUN√á√ïES EVOLU√á√ÉO DO PACIENTE ============
        
        function abrirEvolucao() {
            if (!pacienteAtual) {
                alert('‚ö†Ô∏è Nenhum paciente selecionado!');
                return;
            }
            
            // Criar/mostrar modal de evolu√ß√£o
            mostrarQuadroEvolucao();
        }

        function mostrarQuadroEvolucao() {
            // Criar modal se n√£o existir
            let modal = document.getElementById('modalQuadroEvolucao');
            if (!modal) {
                criarModalQuadroEvolucao();
                modal = document.getElementById('modalQuadroEvolucao');
            }
            
            // Carregar dados da evolu√ß√£o
            carregarDadosEvolucao();
            
            // Mostrar modal
            modal.style.display = 'flex';
        }

        function criarModalQuadroEvolucao() {
            const modal = document.createElement('div');
            modal.id = 'modalQuadroEvolucao';
            modal.className = 'modal-overlay';
            modal.style.cssText = `
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                z-index: 1000;
                justify-content: center;
                align-items: center;
            `;
            
            modal.innerHTML = `
                <div class="modal-content" style="
                    background: white;
                    border-radius: 20px;
                    width: 95%;
                    max-width: 1400px;
                    height: 90%;
                    overflow: hidden;
                    display: flex;
                    flex-direction: column;
                ">
                    <!-- Header do Modal -->
                    <div class="evolucao-header" style="
                        background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
                        color: white;
                        padding: 20px 30px;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                    ">
                        <div>
                            <h2><i class="fas fa-chart-line"></i> Quadro de Evolu√ß√£o</h2>
                            <p id="pacienteEvolucaoNome" style="opacity: 0.9; margin-top: 5px;">Carregando...</p>
                        </div>
                        <button onclick="fecharQuadroEvolucao()" style="
                            background: rgba(255,255,255,0.2);
                            border: none;
                            color: white;
                            font-size: 24px;
                            width: 40px;
                            height: 40px;
                            border-radius: 50%;
                            cursor: pointer;
                        ">&times;</button>
                    </div>
                    
                    <!-- Conte√∫do Principal -->
                    <div class="evolucao-content" style="
                        flex: 1;
                        display: grid;
                        grid-template-columns: 300px 1fr;
                        overflow: hidden;
                    ">
                        <!-- Sidebar de Status -->
                        <div class="evolucao-sidebar" style="
                            background: #f8f9fa;
                            padding: 20px;
                            border-right: 2px solid #e9ecef;
                            overflow-y: auto;
                        ">
                            <h3 style="margin-bottom: 20px; color: #2c3e50;">
                                <i class="fas fa-tasks"></i> Status Geral
                            </h3>
                            <div id="statusCards">
                                <!-- Cards de status ser√£o carregados aqui -->
                            </div>
                            
                            <h3 style="margin: 30px 0 20px 0; color: #2c3e50;">
                                <i class="fas fa-bell"></i> Notifica√ß√µes
                            </h3>
                            <div id="notificacoesLista">
                                <!-- Notifica√ß√µes ser√£o carregadas aqui -->
                            </div>
                        </div>
                        
                        <!-- √Årea Principal de Cards -->
                        <div class="evolucao-main" style="
                            padding: 20px;
                            overflow-y: auto;
                        ">
                            <div class="cards-header" style="
                                display: flex;
                                justify-content: space-between;
                                align-items: center;
                                margin-bottom: 20px;
                            ">
                                <h3><i class="fas fa-clipboard-list"></i> Cards de Evolu√ß√£o</h3>
                                <button onclick="adicionarNovoCard()" style="
                                    background: #28a745;
                                    color: white;
                                    border: none;
                                    padding: 10px 20px;
                                    border-radius: 8px;
                                    cursor: pointer;
                                ">
                                    <i class="fas fa-plus"></i> Novo Card
                                </button>
                            </div>
                            
                            <div id="cardsEvolucao" class="cards-grid" style="
                                display: grid;
                                grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
                                gap: 20px;
                            ">
                                <!-- Cards ser√£o carregados aqui -->
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function fecharQuadroEvolucao() {
            const modal = document.getElementById('modalQuadroEvolucao');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        function carregarDadosEvolucao() {
            if (!pacienteAtual) return;
            
            // Atualizar nome do paciente no header
            document.getElementById('pacienteEvolucaoNome').textContent = 
                `${pacienteAtual.nome} - CPF: ${pacienteAtual.cpf}`;
            
            // Carregar cards de evolu√ß√£o
            carregarCardsEvolucao();
            
            // Carregar status geral
            carregarStatusGeral();
            
            // Carregar notifica√ß√µes
            carregarNotificacoes();
        }

        function carregarCardsEvolucao() {
            const container = document.getElementById('cardsEvolucao');
            const cpf = pacienteAtual.cpf;
            
            // Buscar cards existentes ou criar autom√°ticos
            let cardsData = JSON.parse(localStorage.getItem('cardsEvolucao') || '{}');
            
            if (!cardsData[cpf]) {
                cardsData[cpf] = gerarCardsAutomaticos();
                localStorage.setItem('cardsEvolucao', JSON.stringify(cardsData));
            }
            
            const cards = cardsData[cpf];
            
            container.innerHTML = cards.map(card => criarCardHTML(card)).join('');
        }

        function gerarCardsAutomaticos() {
            const hoje = new Date();
            const historico = obterHistoricoPaciente(pacienteAtual.cpf);
            const marcos = historico.marcos;
            
            const cards = [];
            
            // Cards baseados nos marcos
            marcos.forEach(marco => {
                const diasParaMarco = Math.ceil((marco.data - hoje) / (1000 * 60 * 60 * 24));
                
                if (marco.tipo === 'primeira-consulta' && marco.status === 'realizado') {
                    cards.push({
                        id: 'pre-consulta-' + Date.now(),
                        titulo: 'Pr√©-Consulta Realizada',
                        tipo: 'pre-consulta',
                        evento: 'CONSULTA',
                        fase: 'POS',
                        status: 'sem-pendencias',
                        dataEvento: marco.data,
                        tarefas: [
                            { texto: 'Anamnese completa', concluido: true },
                            { texto: 'Exame f√≠sico', concluido: true },
                            { texto: 'Orienta√ß√µes iniciais', concluido: true }
                        ],
                        observacoes: 'Primeira consulta realizada com sucesso.',
                        prazo: null
                    });
                }
                
                if (marco.tipo === 'cirurgia') {
                    if (marco.status === 'agendado' && diasParaMarco > 0) {
                        // Pr√©-cirurgia
                        cards.push({
                            id: 'pre-cirurgia-' + Date.now(),
                            titulo: `Prepara√ß√£o Pr√©-Cir√∫rgica`,
                            tipo: 'pre-cirurgia',
                            evento: 'CIRURGIA',
                            fase: 'PRE',
                            status: diasParaMarco <= 7 ? 'pendente' : 'aguardando',
                            dataEvento: marco.data,
                            tarefas: [
                                { texto: 'Exames pr√©-operat√≥rios', concluido: false },
                                { texto: 'Suspender medicamentos', concluido: false },
                                { texto: 'Jejum 12h antes', concluido: false },
                                { texto: 'Confirmar acompanhante', concluido: false }
                            ],
                            observacoes: `Cirurgia agendada para ${marco.data.toLocaleDateString('pt-BR')}`,
                            prazo: marco.data
                        });
                    } else if (marco.status === 'realizado') {
                        // P√≥s-cirurgia
                        cards.push({
                            id: 'pos-cirurgia-' + Date.now(),
                            titulo: 'Acompanhamento P√≥s-Cir√∫rgico',
                            tipo: 'pos-cirurgia',
                            evento: 'CIRURGIA',
                            fase: 'POS',
                            status: 'pendente',
                            dataEvento: marco.data,
                            tarefas: [
                                { texto: 'Curativo di√°rio', concluido: false },
                                { texto: 'Medica√ß√£o prescrita', concluido: false },
                                { texto: 'Repouso absoluto 48h', concluido: false },
                                { texto: 'Retorno em 7 dias', concluido: false }
                            ],
                            observacoes: 'Acompanhar evolu√ß√£o p√≥s-cir√∫rgica.',
                            prazo: new Date(marco.data.getTime() + 7 * 24 * 60 * 60 * 1000) // 7 dias ap√≥s
                        });
                    }
                }
                
                if (marco.tipo === 'primeiro-retorno' && marco.status === 'pendente') {
                    cards.push({
                        id: 'primeiro-retorno-' + Date.now(),
                        titulo: '1¬∫ Retorno P√≥s-Cir√∫rgico',
                        tipo: 'retorno',
                        evento: 'CONSULTA',
                        fase: 'POS',
                        status: diasParaMarco <= 2 ? 'pendente' : 'aguardando',
                        dataEvento: marco.data,
                        tarefas: [
                            { texto: 'Avaliar cicatriza√ß√£o', concluido: false },
                            { texto: 'Retirar pontos', concluido: false },
                            { texto: 'Orientar cuidados', concluido: false },
                            { texto: 'Agendar pr√≥ximo retorno', concluido: false }
                        ],
                        observacoes: 'Primeiro retorno ap√≥s cirurgia.',
                        prazo: marco.data
                    });
                }
            });
            
            // Card de tarefas gerais
            cards.push({
                id: 'tarefas-gerais-' + Date.now(),
                titulo: 'Tarefas do Dia',
                tipo: 'tarefas-diarias',
                evento: 'GERAL',
                fase: 'ATUAL',
                status: 'aguardando',
                dataEvento: hoje,
                tarefas: [
                    { texto: 'Revisar prontu√°rio', concluido: false },
                    { texto: 'Confirmar pr√≥ximas consultas', concluido: false },
                    { texto: 'Verificar resultados de exames', concluido: false }
                ],
                observacoes: 'Tarefas di√°rias de acompanhamento.',
                prazo: hoje
            });
            
            return cards;
        }

        function criarCardHTML(card) {
            const statusClass = {
                'sem-pendencias': 'success',
                'aguardando': 'warning', 
                'pendente': 'danger'
            };
            
            const statusIcon = {
                'sem-pendencias': 'fas fa-check-circle',
                'aguardando': 'fas fa-clock',
                'pendente': 'fas fa-exclamation-triangle'
            };
            
            const statusText = {
                'sem-pendencias': 'Sem Pend√™ncias',
                'aguardando': 'Aguardando',
                'pendente': 'Pendente'
            };
            
            const diasRestantes = card.prazo ? 
                Math.ceil((new Date(card.prazo) - new Date()) / (1000 * 60 * 60 * 24)) : null;
            
            return `
                <div class="card-evolucao ${statusClass[card.status]}" data-card-id="${card.id}">
                    <div class="card-header">
                        <div class="card-title">
                            <h4>${card.titulo}</h4>
                            <span class="card-tipo">${card.evento} - ${card.fase}</span>
                        </div>
                        <div class="card-status ${statusClass[card.status]}">
                            <i class="${statusIcon[card.status]}"></i>
                            ${statusText[card.status]}
                        </div>
                    </div>
                    
                    ${diasRestantes !== null ? `
                        <div class="card-prazo ${diasRestantes <= 1 ? 'urgente' : ''}">
                            <i class="fas fa-calendar-alt"></i>
                            ${diasRestantes <= 0 ? 'Vencido!' : 
                              diasRestantes === 1 ? 'Vence hoje!' : 
                              `${diasRestantes} dias restantes`}
                        </div>
                    ` : ''}
                    
                    <div class="card-tarefas">
                        <h5><i class="fas fa-tasks"></i> Tarefas (${card.tarefas.filter(t => t.concluido).length}/${card.tarefas.length})</h5>
                        <ul>
                            ${card.tarefas.map((tarefa, index) => `
                                <li class="${tarefa.concluido ? 'concluido' : ''}">
                                    <input type="checkbox" 
                                           ${tarefa.concluido ? 'checked' : ''} 
                                           onchange="toggleTarefa('${card.id}', ${index})">
                                    <span>${tarefa.texto}</span>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                    
                    <div class="card-observacoes">
                        <textarea placeholder="Observa√ß√µes..." onchange="salvarObservacoes('${card.id}', this.value)">${card.observacoes || ''}</textarea>
                    </div>
                    
                    <div class="card-actions">
                        <button onclick="editarCard('${card.id}')" class="btn-edit">
                            <i class="fas fa-edit"></i> Editar
                        </button>
                        <button onclick="duplicarCard('${card.id}')" class="btn-duplicate">
                            <i class="fas fa-copy"></i> Duplicar
                        </button>
                        <button onclick="removerCard('${card.id}')" class="btn-remove">
                            <i class="fas fa-trash"></i> Remover
                        </button>
                    </div>
                </div>
            `;
        }

        function toggleTarefa(cardId, tarefaIndex) {
            const cardsData = JSON.parse(localStorage.getItem('cardsEvolucao') || '{}');
            const cpf = pacienteAtual.cpf;
            
            if (cardsData[cpf]) {
                const card = cardsData[cpf].find(c => c.id === cardId);
                if (card && card.tarefas[tarefaIndex]) {
                    card.tarefas[tarefaIndex].concluido = !card.tarefas[tarefaIndex].concluido;
                    
                    // Atualizar status do card baseado nas tarefas
                    const todasConcluidas = card.tarefas.every(t => t.concluido);
                    const algumaConcluida = card.tarefas.some(t => t.concluido);
                    
                    if (todasConcluidas) {
                        card.status = 'sem-pendencias';
                    } else if (algumaConcluida) {
                        card.status = 'aguardando';
                    } else {
                        card.status = 'pendente';
                    }
                    
                    localStorage.setItem('cardsEvolucao', JSON.stringify(cardsData));
                    
                    // Recarregar cards para atualizar visual
                    carregarCardsEvolucao();
                    carregarStatusGeral();
                }
            }
        }

        function salvarObservacoes(cardId, observacoes) {
            const cardsData = JSON.parse(localStorage.getItem('cardsEvolucao') || '{}');
            const cpf = pacienteAtual.cpf;
            
            if (cardsData[cpf]) {
                const card = cardsData[cpf].find(c => c.id === cardId);
                if (card) {
                    card.observacoes = observacoes;
                    localStorage.setItem('cardsEvolucao', JSON.stringify(cardsData));
                }
            }
        }

        function editarCard(cardId) {
            alert('üîß Funcionalidade de edi√ß√£o em desenvolvimento!\n\nEm breve voc√™ poder√°:\n‚Ä¢ Editar t√≠tulo e descri√ß√£o\n‚Ä¢ Adicionar/remover tarefas\n‚Ä¢ Alterar prazos\n‚Ä¢ Configurar notifica√ß√µes');
        }

        function duplicarCard(cardId) {
            const cardsData = JSON.parse(localStorage.getItem('cardsEvolucao') || '{}');
            const cpf = pacienteAtual.cpf;
            
            if (cardsData[cpf]) {
                const card = cardsData[cpf].find(c => c.id === cardId);
                if (card) {
                    const novoCard = {
                        ...card,
                        id: 'duplicado-' + Date.now(),
                        titulo: card.titulo + ' (C√≥pia)',
                        tarefas: card.tarefas.map(t => ({ ...t, concluido: false })),
                        status: 'pendente'
                    };
                    
                    cardsData[cpf].push(novoCard);
                    localStorage.setItem('cardsEvolucao', JSON.stringify(cardsData));
                    
                    carregarCardsEvolucao();
                    alert('‚úÖ Card duplicado com sucesso!');
                }
            }
        }

        function removerCard(cardId) {
            if (confirm('‚ö†Ô∏è Tem certeza que deseja remover este card?\n\nEsta a√ß√£o n√£o pode ser desfeita.')) {
                const cardsData = JSON.parse(localStorage.getItem('cardsEvolucao') || '{}');
                const cpf = pacienteAtual.cpf;
                
                if (cardsData[cpf]) {
                    cardsData[cpf] = cardsData[cpf].filter(c => c.id !== cardId);
                    localStorage.setItem('cardsEvolucao', JSON.stringify(cardsData));
                    
                    carregarCardsEvolucao();
                    carregarStatusGeral();
                    alert('‚úÖ Card removido com sucesso!');
                }
            }
        }

        function adicionarNovoCard() {
            const titulo = prompt('Digite o t√≠tulo do novo card:');
            if (!titulo) return;
            
            const tipo = prompt('Tipo do card:\n1 - Pr√©-Consulta\n2 - P√≥s-Consulta\n3 - Pr√©-Cirurgia\n4 - P√≥s-Cirurgia\n5 - Tarefas Gerais\n\nDigite o n√∫mero:');
            
            const tipos = {
                '1': { evento: 'CONSULTA', fase: 'PRE', tipo: 'pre-consulta' },
                '2': { evento: 'CONSULTA', fase: 'POS', tipo: 'pos-consulta' },
                '3': { evento: 'CIRURGIA', fase: 'PRE', tipo: 'pre-cirurgia' },
                '4': { evento: 'CIRURGIA', fase: 'POS', tipo: 'pos-cirurgia' },
                '5': { evento: 'GERAL', fase: 'ATUAL', tipo: 'tarefas-gerais' }
            };
            
            if (!tipos[tipo]) {
                alert('Tipo inv√°lido!');
                return;
            }
            
            const novoCard = {
                id: 'manual-' + Date.now(),
                titulo: titulo,
                tipo: tipos[tipo].tipo,
                evento: tipos[tipo].evento,
                fase: tipos[tipo].fase,
                status: 'pendente',
                dataEvento: new Date(),
                tarefas: [
                    { texto: 'Nova tarefa', concluido: false }
                ],
                observacoes: '',
                prazo: null
            };
            
            const cardsData = JSON.parse(localStorage.getItem('cardsEvolucao') || '{}');
            const cpf = pacienteAtual.cpf;
            
            if (!cardsData[cpf]) cardsData[cpf] = [];
            cardsData[cpf].push(novoCard);
            
            localStorage.setItem('cardsEvolucao', JSON.stringify(cardsData));
            
            carregarCardsEvolucao();
            alert('‚úÖ Novo card criado com sucesso!');
        }

        function carregarStatusGeral() {
            const container = document.getElementById('statusCards');
            const cardsData = JSON.parse(localStorage.getItem('cardsEvolucao') || '{}');
            const cpf = pacienteAtual.cpf;
            
            if (!cardsData[cpf]) return;
            
            const cards = cardsData[cpf];
            const statusCount = {
                'sem-pendencias': 0,
                'aguardando': 0,
                'pendente': 0
            };
            
            cards.forEach(card => {
                statusCount[card.status]++;
            });
            
            container.innerHTML = `
                <div class="status-card success">
                    <div class="status-icon"><i class="fas fa-check-circle"></i></div>
                    <div class="status-info">
                        <h4>${statusCount['sem-pendencias']}</h4>
                        <p>Sem Pend√™ncias</p>
                    </div>
                </div>
                
                <div class="status-card warning">
                    <div class="status-icon"><i class="fas fa-clock"></i></div>
                    <div class="status-info">
                        <h4>${statusCount['aguardando']}</h4>
                        <p>Aguardando</p>
                    </div>
                </div>
                
                <div class="status-card danger">
                    <div class="status-icon"><i class="fas fa-exclamation-triangle"></i></div>
                    <div class="status-info">
                        <h4>${statusCount['pendente']}</h4>
                        <p>Pendente</p>
                    </div>
                </div>
            `;
        }

        function carregarNotificacoes() {
            const container = document.getElementById('notificacoesLista');
            const cardsData = JSON.parse(localStorage.getItem('cardsEvolucao') || '{}');
            const cpf = pacienteAtual.cpf;
            
            if (!cardsData[cpf]) return;
            
            const cards = cardsData[cpf];
            const hoje = new Date();
            const notificacoes = [];
            
            cards.forEach(card => {
                if (card.prazo) {
                    const diasRestantes = Math.ceil((new Date(card.prazo) - hoje) / (1000 * 60 * 60 * 24));
                    
                    if (diasRestantes <= 1 && card.status !== 'sem-pendencias') {
                        notificacoes.push({
                            tipo: diasRestantes <= 0 ? 'urgent' : 'warning',
                            texto: diasRestantes <= 0 ? 
                                `‚ö†Ô∏è ${card.titulo} - VENCIDO!` : 
                                `‚è∞ ${card.titulo} - Vence hoje!`,
                            card: card
                        });
                    }
                }
                
                if (card.status === 'pendente') {
                    const tarefasPendentes = card.tarefas.filter(t => !t.concluido).length;
                    if (tarefasPendentes > 0) {
                        notificacoes.push({
                            tipo: 'info',
                            texto: `üìã ${card.titulo} - ${tarefasPendentes} tarefa(s) pendente(s)`,
                            card: card
                        });
                    }
                }
            });
            
            if (notificacoes.length === 0) {
                container.innerHTML = '<div class="no-notifications">‚úÖ Nenhuma notifica√ß√£o</div>';
                return;
            }
            
            container.innerHTML = notificacoes.map(notif => `
                <div class="notification ${notif.tipo}">
                    <div class="notification-text">${notif.texto}</div>
                    <button onclick="focarCard('${notif.card.id}')" class="notification-action">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
            `).join('');
        }

        function focarCard(cardId) {
            const cardElement = document.querySelector(`[data-card-id="${cardId}"]`);
            if (cardElement) {
                cardElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                cardElement.style.animation = 'pulse 2s ease-in-out';
                setTimeout(() => {
                    cardElement.style.animation = '';
                }, 2000);
            }
        }
        
        function carregarTimelineEvolucao() {
            const timeline = document.getElementById('timelineEvolucao');
            
            // Dados de exemplo de evolu√ß√£o
            const evolucoes = [
                {
                    data: '2025-07-30',
                    tipo: 'Consulta Inicial',
                    descricao: 'Primeira consulta para avalia√ß√£o de rinoplastia. Paciente apresenta desvio de septo nasal e desejo de melhora est√©tica. Realizada anamnese completa e exame f√≠sico.',
                    peso: '65kg',
                    pressao: '120/80',
                    observacoes: 'Paciente apta para procedimento cir√∫rgico'
                },
                {
                    data: '2025-07-25',
                    tipo: 'Exames Pr√©-op',
                    descricao: 'Solicitados exames pr√©-operat√≥rios: hemograma completo, coagulograma, glicemia, ureia, creatinina, ECG e RX de t√≥rax.',
                    observacoes: 'Aguardando resultados dos exames'
                },
                {
                    data: '2025-07-20',
                    tipo: 'Consulta Retorno',
                    descricao: 'Retorno para apresenta√ß√£o dos resultados de exames e discuss√£o do planejamento cir√∫rgico. Todos os exames dentro da normalidade.',
                    observacoes: 'Paciente liberada para cirurgia'
                }
            ];
            
            timeline.innerHTML = evolucoes.map(evolucao => `
                <div class="evolucao-item">
                    <div class="evolucao-header">
                        <span class="evolucao-data">${formatarDataBrasil(evolucao.data)}</span>
                        <span class="evolucao-tipo">${evolucao.tipo}</span>
                    </div>
                    <div class="evolucao-descricao">${evolucao.descricao}</div>
                    ${evolucao.peso || evolucao.pressao ? `
                        <div class="evolucao-detalhes">
                            ${evolucao.peso ? `
                                <div class="detalhe-item">
                                    <div class="detalhe-valor">${evolucao.peso}</div>
                                    <div class="detalhe-label">Peso</div>
                                </div>
                            ` : ''}
                            ${evolucao.pressao ? `
                                <div class="detalhe-item">
                                    <div class="detalhe-valor">${evolucao.pressao}</div>
                                    <div class="detalhe-label">Press√£o</div>
                                </div>
                            ` : ''}
                        </div>
                    ` : ''}
                    ${evolucao.observacoes ? `
                        <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px; font-style: italic; color: #6c757d;">
                            <strong>Obs:</strong> ${evolucao.observacoes}
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }
        
        function adicionarEvolucao() {
            const descricao = prompt('Descri√ß√£o da evolu√ß√£o:');
            if (!descricao) return;
            
            const novaEvolucao = {
                data: new Date().toISOString().split('T')[0],
                tipo: 'Evolu√ß√£o',
                descricao: descricao,
                observacoes: ''
            };
            
            // Aqui voc√™ adicionaria ao banco de dados
            alert('‚úÖ Evolu√ß√£o adicionada com sucesso!');
            carregarTimelineEvolucao();
        }
        
        // ============ FUN√á√ïES FICHA DE ATENDIMENTO ============
        
        function abrirFichaAtendimento() {
            // Limpar formul√°rios anteriores
            document.querySelectorAll('.document-form').forEach(form => {
                form.style.display = 'none';
            });
            
            // Esconder placeholder
            document.getElementById('placeholder').style.display = 'none';
            
            // Criar formul√°rio da Ficha de Atendimento
            let fichaForm = document.getElementById('ficha-atendimento-form');
            if (!fichaForm) {
                fichaForm = criarFormularioFichaAtendimento();
            }
            
            fichaForm.style.display = 'block';
            
            // Marcar item ativo na sidebar
            document.querySelectorAll('.document-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Pr√©-preencher dados do paciente se dispon√≠vel
            if (pacienteAtual) {
                document.getElementById('ficha-paciente-nome').value = pacienteAtual.nome || '';
                document.getElementById('ficha-paciente-idade').value = calcularIdade(pacienteAtual.dataNascimento) || '';
                document.getElementById('ficha-data-atendimento').value = new Date().toISOString().split('T')[0];
            }
        }
        
        function fecharModalFicha() {
            document.getElementById('modalFicha').classList.remove('active');
        }
        
        function criarFormularioFichaAtendimento() {
            const canvasArea = document.querySelector('.canvas-area');
            
            const fichaForm = document.createElement('div');
            fichaForm.id = 'ficha-atendimento-form';
            fichaForm.className = 'document-form';
            fichaForm.style.display = 'none';
            
            fichaForm.innerHTML = `
                <div class="form-section">
                    <h3><i class="fas fa-clipboard-check"></i> Ficha de Atendimento</h3>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Nome do Paciente</label>
                            <input type="text" id="ficha-paciente-nome" placeholder="Nome completo">
                        </div>
                        <div class="form-group">
                            <label>Idade</label>
                            <input type="number" id="ficha-paciente-idade" placeholder="Idade">
                        </div>
                        <div class="form-group">
                            <label>Data do Atendimento</label>
                            <input type="date" id="ficha-data-atendimento">
                        </div>
                        <div class="form-group">
                            <label>Tipo de Consulta</label>
                            <select id="ficha-tipo-consulta">
                                <option value="primeira-consulta">Primeira Consulta</option>
                                <option value="retorno">Retorno</option>
                                <option value="urgencia">Urg√™ncia</option>
                                <option value="pos-operatorio">P√≥s-operat√≥rio</option>
                            </select>
                        </div>
                    </div>
                    
                    <h4>Anamnese</h4>
                    <div class="form-group">
                        <label>Queixa Principal</label>
                        <textarea id="ficha-queixa-principal" rows="3" placeholder="Descreva a queixa principal do paciente"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Hist√≥ria da Doen√ßa Atual</label>
                        <textarea id="ficha-historia-doenca" rows="4" placeholder="Hist√≥ria detalhada da doen√ßa atual"></textarea>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Alergias</label>
                            <input type="text" id="ficha-alergias" placeholder="Medicamentos, alimentos, etc.">
                        </div>
                        <div class="form-group">
                            <label>Medica√ß√µes em Uso</label>
                            <input type="text" id="ficha-medicacoes" placeholder="Medicamentos atuais">
                        </div>
                    </div>
                    
                    <h4>Exame F√≠sico</h4>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Press√£o Arterial (mmHg)</label>
                            <input type="text" id="ficha-pressao" placeholder="120/80">
                        </div>
                        <div class="form-group">
                            <label>Frequ√™ncia Card√≠aca (bpm)</label>
                            <input type="number" id="ficha-fc" placeholder="72">
                        </div>
                        <div class="form-group">
                            <label>Peso (kg)</label>
                            <input type="number" id="ficha-peso" step="0.1" placeholder="70.5">
                        </div>
                        <div class="form-group">
                            <label>Altura (cm)</label>
                            <input type="number" id="ficha-altura" placeholder="170">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Exame F√≠sico Detalhado</label>
                        <textarea id="ficha-exame-fisico" rows="4" placeholder="Descri√ß√£o detalhada do exame f√≠sico"></textarea>
                    </div>
                    
                    <h4>Avalia√ß√£o e Conduta</h4>
                    <div class="form-group">
                        <label>Hip√≥tese Diagn√≥stica</label>
                        <textarea id="ficha-diagnostico" rows="2" placeholder="Hip√≥teses diagn√≥sticas"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Conduta Terap√™utica</label>
                        <textarea id="ficha-conduta" rows="3" placeholder="Prescri√ß√µes, orienta√ß√µes, exames solicitados"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Observa√ß√µes Gerais</label>
                        <textarea id="ficha-observacoes" rows="2" placeholder="Observa√ß√µes adicionais"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Pr√≥ximo Retorno</label>
                        <input type="date" id="ficha-proximo-retorno">
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" onclick="salvarFichaAtendimento()" class="btn-primary">
                            <i class="fas fa-save"></i> Salvar Ficha
                        </button>
                        <button type="button" onclick="imprimirFichaAtendimento()" class="btn-secondary">
                            <i class="fas fa-print"></i> Imprimir
                        </button>
                        <button type="button" onclick="limparFichaAtendimento()" class="btn-secondary">
                            <i class="fas fa-eraser"></i> Limpar
                        </button>
                    </div>
                </div>
            `;
            
            canvasArea.appendChild(fichaForm);
            return fichaForm;
        }
        
        function salvarFichaAtendimento() {
            const fichaData = {
                pacienteNome: document.getElementById('ficha-paciente-nome').value,
                pacienteIdade: document.getElementById('ficha-paciente-idade').value,
                dataAtendimento: document.getElementById('ficha-data-atendimento').value,
                tipoConsulta: document.getElementById('ficha-tipo-consulta').value,
                queixaPrincipal: document.getElementById('ficha-queixa-principal').value,
                historiaDoenca: document.getElementById('ficha-historia-doenca').value,
                alergias: document.getElementById('ficha-alergias').value,
                medicacoes: document.getElementById('ficha-medicacoes').value,
                pressao: document.getElementById('ficha-pressao').value,
                fc: document.getElementById('ficha-fc').value,
                peso: document.getElementById('ficha-peso').value,
                altura: document.getElementById('ficha-altura').value,
                exameFisico: document.getElementById('ficha-exame-fisico').value,
                diagnostico: document.getElementById('ficha-diagnostico').value,
                conduta: document.getElementById('ficha-conduta').value,
                observacoes: document.getElementById('ficha-observacoes').value,
                proximoRetorno: document.getElementById('ficha-proximo-retorno').value,
                timestamp: new Date().toISOString()
            };
            
            // Salvar no localStorage
            const fichas = JSON.parse(localStorage.getItem('fichasAtendimento') || '[]');
            fichas.push(fichaData);
            localStorage.setItem('fichasAtendimento', JSON.stringify(fichas));
            
            showToast('‚úÖ Ficha de Atendimento salva com sucesso!', 'success');
        }
        
        function imprimirFichaAtendimento() {
            window.print();
        }
        
        function limparFichaAtendimento() {
            if (confirm('Tem certeza que deseja limpar todos os campos da ficha?')) {
                document.getElementById('ficha-atendimento-form').querySelectorAll('input, textarea, select').forEach(field => {
                    if (field.type !== 'date' || field.id !== 'ficha-data-atendimento') {
                        field.value = '';
                    }
                });
                showToast('üìù Ficha limpa!', 'info');
            }
        }
        
        function showToast(message, type = 'info') {
            // Criar elemento de toast se n√£o existir
            let toast = document.getElementById('toast-notification');
            if (!toast) {
                toast = document.createElement('div');
                toast.id = 'toast-notification';
                toast.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 15px 20px;
                    border-radius: 8px;
                    color: white;
                    font-weight: 600;
                    z-index: 9999;
                    transform: translateX(400px);
                    transition: transform 0.3s ease;
                `;
                document.body.appendChild(toast);
            }
            
            // Definir cor baseada no tipo
            const colors = {
                'success': '#28a745',
                'error': '#dc3545',
                'info': '#17a2b8',
                'warning': '#ffc107'
            };
            
            toast.style.backgroundColor = colors[type] || colors.info;
            toast.textContent = message;
            
            // Mostrar toast
            toast.style.transform = 'translateX(0)';
            
            // Esconder ap√≥s 3 segundos
            setTimeout(() => {
                toast.style.transform = 'translateX(400px)';
            }, 3000);
        }
        
        function configurarCalculoIMC() {
            const peso = document.getElementById('peso');
            const altura = document.getElementById('altura');
            const imc = document.getElementById('imc');
            
            function calcularIMC() {
                const pesoVal = parseFloat(peso.value);
                const alturaVal = parseFloat(altura.value) / 100; // cm para metros
                
                if (pesoVal && alturaVal) {
                    const imcVal = pesoVal / (alturaVal * alturaVal);
                    imc.value = imcVal.toFixed(1);
                    
                    // Adicionar classifica√ß√£o
                    let classificacao = '';
                    if (imcVal < 18.5) classificacao = ' (Abaixo do peso)';
                    else if (imcVal < 25) classificacao = ' (Peso normal)';
                    else if (imcVal < 30) classificacao = ' (Sobrepeso)';
                    else classificacao = ' (Obesidade)';
                    
                    imc.value += classificacao;
                }
            }
            
            peso.addEventListener('input', calcularIMC);
            altura.addEventListener('input', calcularIMC);
        }
        
        function configurarCalculoOrcamento() {
            const honorarios = document.getElementById('valor-honorarios');
            const hospital = document.getElementById('valor-hospital');
            const anestesia = document.getElementById('valor-anestesia');
            const total = document.getElementById('valor-total');
            
            function calcularTotal() {
                const hon = parseFloat(honorarios.value) || 0;
                const hosp = parseFloat(hospital.value) || 0;
                const anes = parseFloat(anestesia.value) || 0;
                
                const totalVal = hon + hosp + anes;
                total.value = `R$ ${totalVal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            }
            
            honorarios.addEventListener('input', calcularTotal);
            hospital.addEventListener('input', calcularTotal);
            anestesia.addEventListener('input', calcularTotal);
        }
        
        function adicionarFoto(tipo) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        // Encontrar o slot correto
                        const slots = document.querySelectorAll('.foto-slot');
                        const slot = Array.from(slots).find(s => s.onclick.toString().includes(tipo));
                        
                        if (slot) {
                            slot.innerHTML = `<img src="${e.target.result}" alt="${tipo}">`;
                            slot.onclick = () => ampliarFoto(e.target.result, tipo);
                        }
                    };
                    reader.readAsDataURL(file);
                }
            };
            
            input.click();
        }
        
        function ampliarFoto(src, tipo) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.9); z-index: 2000; display: flex; 
                align-items: center; justify-content: center; padding: 20px;
            `;
            
            modal.innerHTML = `
                <div style="max-width: 90%; max-height: 90%; position: relative;">
                    <img src="${src}" style="max-width: 100%; max-height: 100%; border-radius: 15px;">
                    <button onclick="this.parentElement.parentElement.remove()" 
                            style="position: absolute; top: -15px; right: -15px; background: #e74c3c; 
                                   color: white; border: none; border-radius: 50%; width: 35px; height: 35px; 
                                   cursor: pointer; font-size: 18px;">&times;</button>
                    <div style="text-align: center; margin-top: 15px; color: white; font-weight: 600;">
                        ${tipo.replace('-', ' ').toUpperCase()}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function salvarFichaAtendimento() {
            // Coletar dados do formul√°rio
            const dadosFicha = {
                paciente: document.getElementById('pacienteNome').value,
                idade: document.getElementById('pacienteIdade').value,
                procedimento: document.getElementById('procedimentoDesejado').value,
                motivoPrincipal: document.getElementById('motivoPrincipal').value,
                // ... outros campos
            };
            
            // Aqui voc√™ salvaria no banco de dados
            alert('‚úÖ Ficha de atendimento salva com sucesso!');
            console.log('Dados da ficha:', dadosFicha);
        }
        
        function gerarPDFFicha() {
            // Usar jsPDF para gerar PDF da ficha
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Cabe√ßalho
            doc.setFontSize(18);
            doc.setFont(undefined, 'bold');
            doc.text('FICHA DE ATENDIMENTO - CIRURGIA PL√ÅSTICA', 20, 25);
            
            doc.setFontSize(14);
            doc.text('Dr. Marcio Scartozzoni', 20, 35);
            
            // Dados do paciente
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text('DADOS DO PACIENTE:', 20, 50);
            
            doc.setFont(undefined, 'normal');
            doc.text(`Nome: ${document.getElementById('pacienteNome').value}`, 20, 60);
            doc.text(`Idade: ${document.getElementById('pacienteIdade').value} anos`, 20, 70);
            doc.text(`Procedimento: ${document.getElementById('procedimentoDesejado').value}`, 20, 80);
            
            // Motivo da consulta
            doc.setFont(undefined, 'bold');
            doc.text('MOTIVO DA CONSULTA:', 20, 100);
            
            doc.setFont(undefined, 'normal');
            const motivo = document.getElementById('motivoPrincipal').value;
            const linhasMotivo = doc.splitTextToSize(motivo, 170);
            doc.text(linhasMotivo, 20, 110);
            
            // Or√ßamento
            doc.setFont(undefined, 'bold');
            doc.text('OR√áAMENTO:', 20, 180);
            
            doc.setFont(undefined, 'normal');
            doc.text(`Honor√°rios M√©dicos: R$ ${document.getElementById('valor-honorarios').value}`, 20, 190);
            doc.text(`Hospital/Cl√≠nica: R$ ${document.getElementById('valor-hospital').value}`, 20, 200);
            doc.text(`Anestesia: R$ ${document.getElementById('valor-anestesia').value}`, 20, 210);
            doc.text(`TOTAL: ${document.getElementById('valor-total').value}`, 20, 220);
            
            // Assinatura
            doc.setFont(undefined, 'bold');
            doc.text('_________________________________', 20, 260);
            doc.text('Dr. Marcio Scartozzoni', 20, 270);
            doc.text('CRM: [N√öMERO]', 20, 280);
            
            // Gerar e abrir PDF
            const pdfBlob = doc.output('blob');
            const pdfUrl = URL.createObjectURL(pdfBlob);
            window.open(pdfUrl, '_blank');
            
            alert('‚úÖ PDF da ficha de atendimento gerado com sucesso!');
        }
        
        // Fun√ß√£o auxiliar para formatar data
        function formatarDataBrasil(dataISO) {
            if (!dataISO) return '';
            const data = new Date(dataISO);
            return data.toLocaleDateString('pt-BR');
        }
    </script>

    <!-- Modal de Evolu√ß√£o do Paciente -->
    <div id="modalEvolucao" class="modal-evolucao">
        <div class="modal-content-evolucao">
            <div class="modal-header-evolucao">
                <h2><i class="fas fa-chart-line"></i> Evolu√ß√£o do Paciente</h2>
                <button class="modal-close" onclick="fecharModalEvolucao()">&times;</button>
            </div>
            
            <div class="modal-body-evolucao">
                <button class="btn-nova-evolucao" onclick="adicionarEvolucao()">
                    <i class="fas fa-plus"></i> Adicionar Nova Evolu√ß√£o
                </button>
                
                <div class="timeline-evolucao" id="timelineEvolucao">
                    <!-- Timeline ser√° carregada dinamicamente -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Ficha de Atendimento -->
    <div id="modalFicha" class="modal-ficha">
        <div class="modal-content-ficha">
            <div class="modal-header-ficha">
                <h2><i class="fas fa-clipboard-check"></i> Ficha de Atendimento - Cirurgia Pl√°stica</h2>
                <button class="modal-close" onclick="fecharModalFicha()">&times;</button>
            </div>
            
            <div class="modal-body-ficha">
                <form id="fichaAtendimentoForm">
                    <div class="ficha-sections">
                        <!-- Dados do Paciente -->
                        <div class="ficha-section">
                            <h3><i class="fas fa-user"></i> Dados do Paciente</h3>
                            
                            <div class="form-group-ficha">
                                <label for="pacienteNome">Nome Completo:</label>
                                <input type="text" id="pacienteNome" required>
                            </div>
                            
                            <div class="form-group-ficha">
                                <label for="pacienteIdade">Idade:</label>
                                <input type="number" id="pacienteIdade" min="0" max="120">
                            </div>
                            
                            <div class="form-group-ficha">
                                <label for="pacienteProfissao">Profiss√£o:</label>
                                <input type="text" id="pacienteProfissao">
                            </div>
                            
                            <div class="form-group-ficha">
                                <label for="pacienteEstadoCivil">Estado Civil:</label>
                                <select id="pacienteEstadoCivil">
                                    <option value="">Selecione</option>
                                    <option value="solteiro">Solteiro(a)</option>
                                    <option value="casado">Casado(a)</option>
                                    <option value="separado">Separado(a)</option>
                                    <option value="divorciado">Divorciado(a)</option>
                                    <option value="viuvo">Vi√∫vo(a)</option>
                                </select>
                            </div>
                        </div>

                        <!-- Motivo da Consulta -->
                        <div class="ficha-section">
                            <h3><i class="fas fa-stethoscope"></i> Motivo da Consulta</h3>
                            
                            <div class="form-group-ficha">
                                <label for="procedimentoDesejado">Procedimento Desejado:</label>
                                <select id="procedimentoDesejado">
                                    <option value="">Selecione</option>
                                    <option value="rinoplastia">Rinoplastia</option>
                                    <option value="mamoplastia-aumento">Mamoplastia de Aumento</option>
                                    <option value="mamoplastia-reducao">Mamoplastia de Redu√ß√£o</option>
                                    <option value="abdominoplastia">Abdominoplastia</option>
                                    <option value="lipoaspiracaoo">Lipoaspira√ß√£o</option>
                                    <option value="blefaroplastia">Blefaroplastia</option>
                                    <option value="lifting-facial">Lifting Facial</option>
                                    <option value="otoplastia">Otoplastia</option>
                                    <option value="outros">Outros</option>
                                </select>
                            </div>
                            
                            <div class="form-group-ficha">
                                <label for="motivoPrincipal">Motivo Principal:</label>
                                <textarea id="motivoPrincipal" rows="4" placeholder="Descreva o motivo principal da consulta..."></textarea>
                            </div>
                            
                            <div class="form-group-ficha">
                                <label for="expectativas">Expectativas:</label>
                                <textarea id="expectativas" rows="3" placeholder="Expectativas do paciente em rela√ß√£o ao procedimento..."></textarea>
                            </div>
                        </div>

                        <!-- Hist√≥ria M√©dica -->
                        <div class="ficha-section">
                            <h3><i class="fas fa-notes-medical"></i> Hist√≥ria M√©dica</h3>
                            
                            <div class="form-group-ficha">
                                <label>Cirurgias Anteriores:</label>
                                <div class="checkbox-group">
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="cirurgia-plastica-anterior">
                                        <label for="cirurgia-plastica-anterior">Cirurgia Pl√°stica Anterior</label>
                                    </div>
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="cirurgia-geral">
                                        <label for="cirurgia-geral">Cirurgia Geral</label>
                                    </div>
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="anestesia-geral">
                                        <label for="anestesia-geral">Anestesia Geral</label>
                                    </div>
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="complicacoes-cirurgicas">
                                        <label for="complicacoes-cirurgicas">Complica√ß√µes Cir√∫rgicas</label>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group-ficha">
                                <label for="doencas-preexistentes">Doen√ßas Pr√©-existentes:</label>
                                <textarea id="doencas-preexistentes" rows="3" placeholder="Diabetes, hipertens√£o, problemas card√≠acos, etc..."></textarea>
                            </div>
                            
                            <div class="form-group-ficha">
                                <label for="medicamentos-uso">Medicamentos em Uso:</label>
                                <textarea id="medicamentos-uso" rows="3" placeholder="Liste os medicamentos atuais..."></textarea>
                            </div>
                            
                            <div class="form-group-ficha">
                                <label for="alergias">Alergias:</label>
                                <input type="text" id="alergias" placeholder="Medicamentos, materiais, outros...">
                            </div>
                        </div>

                        <!-- Exame F√≠sico -->
                        <div class="ficha-section">
                            <h3><i class="fas fa-search"></i> Exame F√≠sico</h3>
                            
                            <div class="form-group-ficha">
                                <label for="peso">Peso (kg):</label>
                                <input type="number" id="peso" step="0.1" min="0">
                            </div>
                            
                            <div class="form-group-ficha">
                                <label for="altura">Altura (cm):</label>
                                <input type="number" id="altura" min="0" max="250">
                            </div>
                            
                            <div class="form-group-ficha">
                                <label for="imc">IMC:</label>
                                <input type="text" id="imc" readonly placeholder="Calculado automaticamente">
                            </div>
                            
                            <div class="form-group-ficha">
                                <label for="exame-fisico-detalhes">Detalhes do Exame F√≠sico:</label>
                                <textarea id="exame-fisico-detalhes" rows="4" placeholder="Descri√ß√£o detalhada do exame f√≠sico espec√≠fico para o procedimento..."></textarea>
                            </div>
                        </div>

                        <!-- Avalia√ß√£o Psicol√≥gica -->
                        <div class="ficha-section">
                            <h3><i class="fas fa-brain"></i> Avalia√ß√£o Psicol√≥gica</h3>
                            
                            <div class="form-group-ficha">
                                <label for="motivacao">Motiva√ß√£o para Cirurgia:</label>
                                <select id="motivacao">
                                    <option value="">Selecione</option>
                                    <option value="autoestima">Melhora da Autoestima</option>
                                    <option value="funcional">Motivo Funcional</option>
                                    <option value="estetico">Motivo Est√©tico</option>
                                    <option value="profissional">Motivo Profissional</option>
                                    <option value="outros">Outros</option>
                                </select>
                            </div>
                            
                            <div class="form-group-ficha">
                                <label for="apoio-familiar">Apoio Familiar:</label>
                                <select id="apoio-familiar">
                                    <option value="">Selecione</option>
                                    <option value="total">Total</option>
                                    <option value="parcial">Parcial</option>
                                    <option value="nenhum">Nenhum</option>
                                </select>
                            </div>
                            
                            <div class="form-group-ficha">
                                <label for="expectativas-reais">Expectativas Realistas:</label>
                                <select id="expectativas-reais">
                                    <option value="">Selecione</option>
                                    <option value="sim">Sim</option>
                                    <option value="parcialmente">Parcialmente</option>
                                    <option value="nao">N√£o</option>
                                </select>
                            </div>
                            
                            <div class="form-group-ficha">
                                <label for="observacoes-psicologicas">Observa√ß√µes Psicol√≥gicas:</label>
                                <textarea id="observacoes-psicologicas" rows="3" placeholder="Avalia√ß√£o do estado psicol√≥gico do paciente..."></textarea>
                            </div>
                        </div>

                        <!-- Planejamento Cir√∫rgico -->
                        <div class="ficha-section">
                            <h3><i class="fas fa-drafting-compass"></i> Planejamento Cir√∫rgico</h3>
                            
                            <div class="form-group-ficha">
                                <label for="tecnica-proposta">T√©cnica Proposta:</label>
                                <textarea id="tecnica-proposta" rows="3" placeholder="Descri√ß√£o da t√©cnica cir√∫rgica proposta..."></textarea>
                            </div>
                            
                            <div class="form-group-ficha">
                                <label for="tipo-anestesia">Tipo de Anestesia:</label>
                                <select id="tipo-anestesia">
                                    <option value="">Selecione</option>
                                    <option value="local">Local</option>
                                    <option value="local-sedacao">Local com Seda√ß√£o</option>
                                    <option value="geral">Geral</option>
                                    <option value="peridural">Peridural</option>
                                </select>
                            </div>
                            
                            <div class="form-group-ficha">
                                <label for="tempo-cirurgia">Tempo Estimado (horas):</label>
                                <input type="number" id="tempo-cirurgia" step="0.5" min="0.5" max="12">
                            </div>
                            
                            <div class="form-group-ficha">
                                <label for="local-cirurgia">Local da Cirurgia:</label>
                                <select id="local-cirurgia">
                                    <option value="">Selecione</option>
                                    <option value="hospital">Hospital</option>
                                    <option value="clinica">Cl√≠nica</option>
                                    <option value="consultorio">Consult√≥rio</option>
                                </select>
                            </div>
                        </div>

                        <!-- Or√ßamento -->
                        <div class="ficha-section">
                            <h3><i class="fas fa-calculator"></i> Or√ßamento</h3>
                            
                            <div class="form-group-ficha">
                                <label for="valor-honorarios">Honor√°rios M√©dicos (R$):</label>
                                <input type="number" id="valor-honorarios" step="0.01" min="0">
                            </div>
                            
                            <div class="form-group-ficha">
                                <label for="valor-hospital">Hospital/Cl√≠nica (R$):</label>
                                <input type="number" id="valor-hospital" step="0.01" min="0">
                            </div>
                            
                            <div class="form-group-ficha">
                                <label for="valor-anestesia">Anestesia (R$):</label>
                                <input type="number" id="valor-anestesia" step="0.01" min="0">
                            </div>
                            
                            <div class="form-group-ficha">
                                <label for="valor-total">Valor Total (R$):</label>
                                <input type="text" id="valor-total" readonly>
                            </div>
                        </div>

                        <!-- Fotos Pr√©-operat√≥rias -->
                        <div class="fotos-section">
                            <h3><i class="fas fa-camera"></i> Fotos Pr√©-operat√≥rias</h3>
                            
                            <div class="fotos-grid">
                                <div class="foto-slot" onclick="adicionarFoto('frente')">
                                    <i class="fas fa-camera"></i>
                                    <span>Foto Frontal</span>
                                </div>
                                <div class="foto-slot" onclick="adicionarFoto('perfil-dir')">
                                    <i class="fas fa-camera"></i>
                                    <span>Perfil Direito</span>
                                </div>
                                <div class="foto-slot" onclick="adicionarFoto('perfil-esq')">
                                    <i class="fas fa-camera"></i>
                                    <span>Perfil Esquerdo</span>
                                </div>
                                <div class="foto-slot" onclick="adicionarFoto('lateral')">
                                    <i class="fas fa-camera"></i>
                                    <span>Lateral</span>
                                </div>
                                <div class="foto-slot" onclick="adicionarFoto('detalhe1')">
                                    <i class="fas fa-camera"></i>
                                    <span>Detalhe 1</span>
                                </div>
                                <div class="foto-slot" onclick="adicionarFoto('detalhe2')">
                                    <i class="fas fa-camera"></i>
                                    <span>Detalhe 2</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 30px; padding-top: 20px; border-top: 2px solid #e9ecef;">
                        <button type="button" class="btn-secondary" onclick="fecharModalFicha()">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                        <button type="button" class="btn-primary" onclick="salvarFichaAtendimento()">
                            <i class="fas fa-save"></i> Salvar Ficha
                        </button>
                        <button type="button" class="btn-primary" onclick="gerarPDFFicha()">
                            <i class="fas fa-file-pdf"></i> Gerar PDF
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal para Edi√ß√£o de Dados do Paciente -->
    <div id="modalEdicaoPaciente" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-user-edit"></i> Editar Dados do Paciente</h2>
                <button class="modal-close" onclick="fecharModalEdicaoPaciente()">&times;</button>
            </div>
            
            <div class="modal-body">
                <form id="formEdicaoPaciente">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="editNome">Nome Completo: *</label>
                            <input type="text" id="editNome" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="editCPF">CPF: *</label>
                            <input type="text" id="editCPF" required maxlength="14" readonly style="background: #f0f0f0;">
                        </div>
                        
                        <div class="form-group">
                            <label for="editDataNascimento">Data de Nascimento: *</label>
                            <input type="date" id="editDataNascimento" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="editTelefone">Telefone: *</label>
                            <input type="tel" id="editTelefone" required>
                        </div>
                        
                        <div class="form-group full-width">
                            <label for="editEmail">Email:</label>
                            <input type="email" id="editEmail">
                        </div>
                    </div>
                    
                    <div class="modal-actions">
                        <button type="submit" class="btn-primary">
                            <i class="fas fa-save"></i> Salvar Altera√ß√µes
                        </button>
                        <button type="button" onclick="fecharModalEdicaoPaciente()" class="btn-secondary">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal para Edi√ß√£o de Marcos -->
    <div id="modalEdicaoMarco" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2><i class="fas fa-calendar-edit"></i> Editar Marco</h2>
                <button class="modal-close" onclick="fecharModalMarco()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="formEdicaoMarco">
                    <div class="form-group">
                        <label for="editMarcoTipo">Tipo de Marco:</label>
                        <input type="text" id="editMarcoTipo" readonly style="background: #f8f9fa;">
                    </div>
                    
                    <div class="form-group">
                        <label for="editMarcoData">Data:</label>
                        <input type="date" id="editMarcoData" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="editMarcoStatus">Status:</label>
                        <select id="editMarcoStatus" required>
                            <option value="pendente">Pendente</option>
                            <option value="agendado">Agendado</option>
                            <option value="realizado">Realizado</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="editMarcoObservacoes">Observa√ß√µes:</label>
                        <textarea id="editMarcoObservacoes" rows="3" placeholder="Observa√ß√µes sobre este marco..."></textarea>
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button type="submit" class="btn-primary" style="flex: 1;">
                            <i class="fas fa-save"></i> Salvar Marco
                        </button>
                        <button type="button" onclick="fecharModalMarco()" class="btn-secondary">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        let pacienteAtual = null;

        // Carregar dados do paciente ao inicializar
        document.addEventListener('DOMContentLoaded', function() {
            carregarDadosPaciente();
        });

        function carregarDadosPaciente() {
            const dadosPaciente = localStorage.getItem('pacienteAtual');
            
            if (!dadosPaciente) {
                alert('‚ùå Nenhum paciente selecionado!\n\nVoc√™ ser√° redirecionado para a gest√£o de prontu√°rios.');
                window.location.href = '/prontuarios.html';
                return;
            }

            pacienteAtual = JSON.parse(dadosPaciente);
            atualizarCabecalhoPaciente();
            preencherCabecalhosDocumentos();
        }

        function atualizarCabecalhoPaciente() {
            if (!pacienteAtual) return;

            document.getElementById('prontuarioId').textContent = pacienteAtual.id;
            document.getElementById('nomePacienteHeader').textContent = pacienteAtual.nome;
            
            const dadosDiv = document.getElementById('dadosPacienteHeader');
            dadosDiv.innerHTML = `
                <div>üìÖ Nascimento: ${formatarData(pacienteAtual.dataNascimento)}</div>
                <div>üì± Telefone: ${pacienteAtual.telefone}</div>
                <div>üìß Email: ${pacienteAtual.email || 'N√£o informado'}</div>
            `;
        }

        function preencherCabecalhosDocumentos() {
            // Preencher campos de dados do paciente em todos os formul√°rios
            const campos = {
                'nome-paciente': pacienteAtual.nome,
                'nome-completo': pacienteAtual.nome,
                'cpf-paciente': pacienteAtual.cpf,
                'data-nascimento': pacienteAtual.dataNascimento,
                'telefone-paciente': pacienteAtual.telefone,
                'email-paciente': pacienteAtual.email,
                // Calcular idade
                'idade-paciente': calcularIdade(pacienteAtual.dataNascimento)
            };

            Object.keys(campos).forEach(id => {
                const campo = document.getElementById(id);
                if (campo) {
                    campo.value = campos[id];
                }
            });
            
            // Carregar hist√≥rico de agendamentos
            carregarHistoricoAgendamentos();
        }

        function carregarHistoricoAgendamentos() {
            if (!pacienteAtual) return;
            
            // Simular dados de hist√≥rico (em produ√ß√£o viria da API)
            const historico = obterHistoricoPaciente(pacienteAtual.cpf);
            
            renderizarMarcosPrincipais(historico.marcos);
            renderizarAgendamentosRecentes(historico.agendamentos);
        }

        function obterHistoricoPaciente(cpf) {
            // Simular hist√≥rico baseado no CPF do paciente
            // Em produ√ß√£o, isso viria do banco de dados
            const historicos = JSON.parse(localStorage.getItem('historicosAgendamentos') || '{}');
            
            if (!historicos[cpf]) {
                // Criar hist√≥rico inicial se n√£o existir
                historicos[cpf] = {
                    marcos: gerarMarcosIniciais(),
                    agendamentos: gerarAgendamentosExemplo()
                };
                localStorage.setItem('historicosAgendamentos', JSON.stringify(historicos));
            }
            
            return historicos[cpf];
        }

        function gerarMarcosIniciais() {
            const hoje = new Date();
            return [
                {
                    tipo: 'primeira-consulta',
                    nome: 'Primeira Consulta',
                    data: new Date(hoje.getTime() - 30 * 24 * 60 * 60 * 1000), // 30 dias atr√°s
                    status: 'realizado',
                    icone: 'fas fa-user-md'
                },
                {
                    tipo: 'retorno',
                    nome: 'Consulta de Retorno',
                    data: new Date(hoje.getTime() - 15 * 24 * 60 * 60 * 1000), // 15 dias atr√°s
                    status: 'realizado',
                    icone: 'fas fa-redo'
                },
                {
                    tipo: 'cirurgia',
                    nome: 'Data da Cirurgia',
                    data: new Date(hoje.getTime() + 15 * 24 * 60 * 60 * 1000), // 15 dias no futuro
                    status: 'agendado',
                    icone: 'fas fa-procedures'
                },
                {
                    tipo: 'primeiro-retorno',
                    nome: '1¬∫ Retorno P√≥s-Cir√∫rgico',
                    data: new Date(hoje.getTime() + 22 * 24 * 60 * 60 * 1000), // 22 dias no futuro
                    status: 'pendente',
                    icone: 'fas fa-stethoscope'
                },
                {
                    tipo: 'proximo-retorno',
                    nome: 'Pr√≥ximo Retorno',
                    data: new Date(hoje.getTime() + 45 * 24 * 60 * 60 * 1000), // 45 dias no futuro
                    status: 'pendente',
                    icone: 'fas fa-calendar-check'
                },
                {
                    tipo: 'alta',
                    nome: 'Alta M√©dica',
                    data: new Date(hoje.getTime() + 90 * 24 * 60 * 60 * 1000), // 90 dias no futuro
                    status: 'pendente',
                    icone: 'fas fa-check-circle'
                }
            ];
        }

        function gerarAgendamentosExemplo() {
            const hoje = new Date();
            return [
                {
                    data: new Date(hoje.getTime() - 30 * 24 * 60 * 60 * 1000),
                    tipo: 'Primeira Consulta',
                    status: 'realizado'
                },
                {
                    data: new Date(hoje.getTime() - 15 * 24 * 60 * 60 * 1000),
                    tipo: 'Consulta de Retorno',
                    status: 'realizado'
                },
                {
                    data: new Date(hoje.getTime() + 15 * 24 * 60 * 60 * 1000),
                    tipo: 'Cirurgia Pl√°stica',
                    status: 'agendado'
                }
            ];
        }

        function renderizarMarcosPrincipais(marcos) {
            const container = document.getElementById('marcosPrincipais');
            
            container.innerHTML = marcos.map((marco, index) => `
                <div class="marco-item ${marco.tipo}">
                    <div class="marco-header">
                        <i class="${marco.icone}"></i>
                        <span class="marco-tipo">${marco.nome}</span>
                        <span class="marco-status ${marco.status}">${getStatusTexto(marco.status)}</span>
                        <button class="btn-edit-marco" onclick="editarMarco(${index})" title="Editar marco">
                            <i class="fas fa-edit"></i>
                        </button>
                    </div>
                    <div class="marco-data">${formatarDataCompleta(marco.data)}</div>
                </div>
            `).join('');
        }

        function renderizarAgendamentosRecentes(agendamentos) {
            const container = document.getElementById('agendamentosRecentes');
            
            if (agendamentos.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #6c757d; font-size: 12px; padding: 20px;">Nenhum agendamento encontrado</div>';
                return;
            }
            
            container.innerHTML = agendamentos.slice(-5).reverse().map((agendamento, index) => `
                <div class="agendamento-recente">
                    <div class="agendamento-info" onclick="abrirEvolucaoData('${agendamento.data.toISOString()}')">
                        <div class="agendamento-data">${formatarDataCompleta(agendamento.data)}</div>
                        <div class="agendamento-tipo">${agendamento.tipo}</div>
                    </div>
                    <button class="btn-edit-agendamento" onclick="editarAgendamento(${index})" title="Editar agendamento">
                        <i class="fas fa-edit"></i>
                    </button>
                </div>
            `).join('');
        }

        function getStatusTexto(status) {
            const textos = {
                'realizado': 'Realizado',
                'agendado': 'Agendado',
                'pendente': 'Pendente'
            };
            return textos[status] || status;
        }

        function formatarDataCompleta(data) {
            const dataObj = new Date(data);
            return dataObj.toLocaleDateString('pt-BR', {
                weekday: 'short',
                day: '2-digit',
                month: 'short',
                year: 'numeric'
            });
        }

        function editarMarco(index) {
            // Buscar dados atuais do marco
            const historico = obterHistoricoPaciente(pacienteAtual.cpf);
            const marco = historico.marcos[index];
            
            const novoNome = prompt('Nome do Marco:', marco.nome);
            if (novoNome !== null && novoNome.trim() !== '') {
                const novaData = prompt('Nova Data (YYYY-MM-DD):', marco.data.toISOString().split('T')[0]);
                if (novaData !== null) {
                    const novoStatus = prompt('Status (realizado/agendado/cancelado):', marco.status);
                    if (novoStatus !== null) {
                        // Atualizar marco
                        marco.nome = novoNome.trim();
                        marco.data = new Date(novaData);
                        marco.status = novoStatus;
                        
                        // Salvar altera√ß√µes
                        salvarHistoricoPaciente(pacienteAtual.cpf, historico);
                        
                        // Re-renderizar
                        renderizarMarcosPrincipais(historico.marcos);
                        
                        showToast('‚úÖ Marco atualizado com sucesso!', 'success');
                    }
                }
            }
        }

        function editarAgendamento(index) {
            // Buscar dados atuais do agendamento
            const historico = obterHistoricoPaciente(pacienteAtual.cpf);
            const agendamento = historico.agendamentos[index];
            
            const novoTipo = prompt('Tipo do Agendamento:', agendamento.tipo);
            if (novoTipo !== null && novoTipo.trim() !== '') {
                const novaData = prompt('Nova Data (YYYY-MM-DD):', agendamento.data.toISOString().split('T')[0]);
                if (novaData !== null) {
                    // Atualizar agendamento
                    agendamento.tipo = novoTipo.trim();
                    agendamento.data = new Date(novaData);
                    
                    // Salvar altera√ß√µes
                    salvarHistoricoPaciente(pacienteAtual.cpf, historico);
                    
                    // Re-renderizar
                    renderizarAgendamentosRecentes(historico.agendamentos);
                    
                    showToast('‚úÖ Agendamento atualizado com sucesso!', 'success');
                }
            }
        }

        function fecharModalMarco() {
            document.getElementById('modalEdicaoMarco').style.display = 'none';
        }

        // Event listener para o formul√°rio de edi√ß√£o de marco
        document.getElementById('formEdicaoMarco').addEventListener('submit', function(e) {
            e.preventDefault();
            salvarEdicaoMarco();
        });

        function salvarEdicaoMarco() {
            const tipo = document.getElementById('formEdicaoMarco').getAttribute('data-tipo');
            const novaData = document.getElementById('editMarcoData').value;
            const novoStatus = document.getElementById('editMarcoStatus').value;
            const observacoes = document.getElementById('editMarcoObservacoes').value;
            
            // Atualizar dados no localStorage
            const historicos = JSON.parse(localStorage.getItem('historicosAgendamentos') || '{}');
            const cpf = pacienteAtual.cpf;
            
            if (historicos[cpf]) {
                const marco = historicos[cpf].marcos.find(m => m.tipo === tipo);
                if (marco) {
                    marco.data = new Date(novaData);
                    marco.status = novoStatus;
                    marco.observacoes = observacoes;
                }
                
                localStorage.setItem('historicosAgendamentos', JSON.stringify(historicos));
                
                // Recarregar interface
                carregarHistoricoAgendamentos();
                
                alert('‚úÖ Marco atualizado com sucesso!');
                fecharModalMarco();
            }
        }

        function abrirEvolucaoData(dataISO) {
            const data = new Date(dataISO);
            const dataFormatada = data.toLocaleDateString('pt-BR');
            
            if (confirm(`üìã Abrir evolu√ß√£o do paciente do dia ${dataFormatada}?\n\nEsta funcionalidade criar√°/editar√° a evolu√ß√£o cl√≠nica desta consulta.`)) {
                // Aqui seria a integra√ß√£o com o sistema de evolu√ß√£o
                abrirEvolucao();
            }
        }

        function editarDadosPaciente() {
            if (!pacienteAtual) return;

            // Preencher o modal com os dados atuais
            document.getElementById('editNome').value = pacienteAtual.nome;
            document.getElementById('editCPF').value = pacienteAtual.cpf;
            document.getElementById('editDataNascimento').value = pacienteAtual.dataNascimento;
            document.getElementById('editTelefone').value = pacienteAtual.telefone;
            document.getElementById('editEmail').value = pacienteAtual.email || '';

            document.getElementById('modalEdicaoPaciente').style.display = 'flex';
        }

        function fecharModalEdicaoPaciente() {
            document.getElementById('modalEdicaoPaciente').style.display = 'none';
        }

        // Form de edi√ß√£o de paciente
        document.getElementById('formEdicaoPaciente').addEventListener('submit', function(e) {
            e.preventDefault();
            salvarEdicaoPaciente();
        });

        function salvarEdicaoPaciente() {
            // Atualizar dados do paciente
            pacienteAtual.nome = document.getElementById('editNome').value;
            pacienteAtual.dataNascimento = document.getElementById('editDataNascimento').value;
            pacienteAtual.telefone = document.getElementById('editTelefone').value;
            pacienteAtual.email = document.getElementById('editEmail').value;

            // Salvar no localStorage
            localStorage.setItem('pacienteAtual', JSON.stringify(pacienteAtual));

            // Atualizar a interface
            atualizarCabecalhoPaciente();
            preencherCabecalhosDocumentos();

            alert('‚úÖ Dados do paciente atualizados com sucesso!');
            fecharModalEdicaoPaciente();
        }

        function voltarProntuarios() {
            if (confirm('Deseja voltar √† gest√£o de prontu√°rios? Certifique-se de salvar os documentos antes de sair.')) {
                window.location.href = '/prontuarios.html';
            }
        }

        function agendarConsultaPaciente() {
            if (!pacienteAtual) {
                alert('‚ö†Ô∏è Nenhum paciente selecionado para agendamento.');
                return;
            }

            // Salvar dados do paciente para uso no agendamento
            const dadosAgendamento = {
                origem: 'caderno-digital',
                paciente: {
                    nome: pacienteAtual.nome,
                    cpf: pacienteAtual.cpf,
                    dataNascimento: pacienteAtual.dataNascimento,
                    telefone: pacienteAtual.telefone,
                    email: pacienteAtual.email || ''
                }
            };

            localStorage.setItem('dadosPreAgendamento', JSON.stringify(dadosAgendamento));

            // Abrir sistema de agendamento em nova aba
            const novaAba = window.open('/agendar.html', '_blank');
            
            // Mostrar confirma√ß√£o
            const confirmacao = confirm(
                `üìÖ Abrindo sistema de agendamento para:\n\n` +
                `üë§ ${pacienteAtual.nome}\n` +
                `üìÑ CPF: ${pacienteAtual.cpf}\n\n` +
                `Os dados do paciente j√° foram preenchidos automaticamente.\n\n` +
                `Deseja continuar?`
            );

            if (!confirmacao && novaAba) {
                novaAba.close();
                localStorage.removeItem('dadosPreAgendamento');
            }
        }

        function calcularIdade(dataNascimento) {
            const hoje = new Date();
            const nascimento = new Date(dataNascimento);
            let idade = hoje.getFullYear() - nascimento.getFullYear();
            const mes = hoje.getMonth() - nascimento.getMonth();
            
            if (mes < 0 || (mes === 0 && hoje.getDate() < nascimento.getDate())) {
                idade--;
            }
            
            return idade;
        }

        function formatarData(data) {
            if (!data) return '';
            const date = new Date(data);
            return date.toLocaleDateString('pt-BR');
        }

        // Sobrescrever fun√ß√£o original de voltar
        function voltarDashboard() {
            voltarProntuarios();
        }
    </script>

</body>
</html>
