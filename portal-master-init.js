// üöÄ Portal Master Initializer - Orquestrador de Inicializa√ß√£o v20250811-1700
class PortalMasterInitializer {
    constructor() {
        this.components = [];
        this.features = [];
        this.integrations = [];
        this.initialized = false;
        this.initStartTime = Date.now();
        this.initResults = [];
    }

    // üéØ Inicializa√ß√£o completa do portal
    async initializePortal() {
        console.log('üöÄ PORTAL DR. MARCIO - INICIALIZANDO SISTEMA COMPLETO...');
        
        try {
            // Fase 1: Inicializar componentes b√°sicos
            await this.initializeComponents();
            
            // Fase 2: Inicializar funcionalidades profissionais  
            await this.initializeFeatures();
            
            // Fase 3: Inicializar integra√ß√µes
            await this.initializeIntegrations();
            
            // Fase 4: Inicializar Analytics
            await this.initializeAnalytics();
            
            // Fase 5: Inicializar PWA
            await this.initializePWA();
            
            // Fase 6: Configura√ß√µes finais
            await this.finalizeInitialization();
            
            this.initialized = true;
            this.showInitializationComplete();
            
        } catch (error) {
            console.error('‚ùå Erro na inicializa√ß√£o:', error);
            this.showInitializationError(error);
        }
    }

    // üé® Inicializar Componentes
    async initializeComponents() {
        console.log('üé® Inicializando Portal Components...');

        // Aguarda at√© 2s por defini√ß√£o dos componentes globais
        await this.waitFor(() => typeof window.PortalComponents !== 'undefined' || typeof window.showModal === 'function', 2000);

        const componentTests = [
            {
                name: 'Portal Components System',
                test: () => typeof window.PortalComponents !== 'undefined',
                init: () => { /* J√° inicializado automaticamente */ }
            },
            {
                name: 'Modal Component',
                test: () => typeof window.showModal === 'function',
                init: () => { /* Fun√ß√£o global dispon√≠vel */ }
            },
            {
                name: 'Alert Component', 
                test: () => typeof window.showAlert === 'function',
                init: () => { /* Fun√ß√£o global dispon√≠vel */ }
            },
            {
                name: 'Card Component',
                test: () => typeof window.createCard === 'function',
                init: () => { /* Fun√ß√£o global dispon√≠vel */ }
            },
            {
                name: 'Chart Component',
                test: () => typeof window.createChart === 'function',
                init: () => { /* Fun√ß√£o global dispon√≠vel */ }
            },
            {
                name: 'Calendar Component',
                test: () => typeof window.createCalendar === 'function',
                init: () => { /* Fun√ß√£o global dispon√≠vel */ }
            }
        ];

        for (const component of componentTests) {
            try {
                if (component.test()) {
                    component.init();
                    this.components.push({ name: component.name, status: 'success' });
                    console.log(`‚úÖ ${component.name} inicializado`);
                } else {
                    this.components.push({ name: component.name, status: 'failed' });
                    console.log(`‚ùå ${component.name} n√£o encontrado`);
                }
            } catch (error) {
                this.components.push({ name: component.name, status: 'error', error: error.message });
                console.log(`‚ùå Erro em ${component.name}:`, error.message);
            }
        }
    }

    // üéØ Inicializar Funcionalidades Profissionais
    async initializeFeatures() {
        console.log('üéØ Inicializando Professional Features...');

        // Aguarda at√© 2s por defini√ß√£o das features globais
        await this.waitFor(() => typeof window.PortalProfessionalFeatures !== 'undefined' || typeof window.initDashboard === 'function', 2000);
        
        const featureTests = [
            {
                name: 'Dashboard Widgets',
                test: () => typeof window.initDashboard === 'function',
                init: () => {
                    const container = document.getElementById('professional-dashboard');
                    if (container && window.initDashboard) {
                        window.initDashboard(container);
                    }
                }
            },
            {
                name: 'Notification Center',
                test: () => typeof window.initNotifications === 'function',
                init: () => {
                    if (window.initNotifications) {
                        window.initNotifications();
                    }
                }
            },
            {
                name: 'Appointment Manager',
                test: () => typeof window.initAppointmentManager === 'function',
                init: () => {
                    const container = document.getElementById('appointment-manager');
                    if (container && window.initAppointmentManager) {
                        window.initAppointmentManager(container);
                    }
                }
            },
            {
                name: 'Professional Features System',
                test: () => typeof window.PortalProfessionalFeatures !== 'undefined',
                init: () => { /* Sistema j√° inicializado */ }
            }
        ];

        for (const feature of featureTests) {
            try {
                if (feature.test()) {
                    feature.init();
                    this.features.push({ name: feature.name, status: 'success' });
                    console.log(`‚úÖ ${feature.name} inicializado`);
                } else {
                    this.features.push({ name: feature.name, status: 'failed' });
                    console.log(`‚ùå ${feature.name} n√£o encontrado`);
                }
            } catch (error) {
                this.features.push({ name: feature.name, status: 'error', error: error.message });
                console.log(`‚ùå Erro em ${feature.name}:`, error.message);
            }
        }
    }

    // Utilit√°rio: esperar condi√ß√£o
    async waitFor(conditionFn, timeout = 2000, interval = 100) {
        const start = Date.now();
        return new Promise(resolve => {
            const tick = () => {
                if (conditionFn()) return resolve(true);
                if (Date.now() - start >= timeout) return resolve(false);
                setTimeout(tick, interval);
            };
            tick();
        });
    }

    // üîå Inicializar Integra√ß√µes
    async initializeIntegrations() {
        console.log('üîå Inicializando Portal Integrations...');
        
        const integrationTests = [
            {
                name: 'Portal Integrations System',
                test: () => typeof window.portalIntegrations !== 'undefined',
                init: () => { /* Sistema j√° inicializado */ }
            },
            {
                name: 'WhatsApp Integration',
                test: () => typeof window.sendWhatsApp === 'function',
                init: () => { /* Fun√ß√£o global dispon√≠vel */ }
            },
            {
                name: 'Email Integration',
                test: () => typeof window.sendEmail === 'function',
                init: () => { /* Fun√ß√£o global dispon√≠vel */ }
            },
            {
                name: 'Calendar Integration',
                test: () => typeof window.createCalendarEvent === 'function',
                init: () => { /* Fun√ß√£o global dispon√≠vel */ }
            },
            {
                name: 'Payment Integration',
                test: () => typeof window.createPayment === 'function',
                init: () => { /* Fun√ß√£o global dispon√≠vel */ }
            }
        ];

        for (const integration of integrationTests) {
            try {
                if (integration.test()) {
                    integration.init();
                    this.integrations.push({ name: integration.name, status: 'success' });
                    console.log(`‚úÖ ${integration.name} inicializada`);
                } else {
                    this.integrations.push({ name: integration.name, status: 'failed' });
                    console.log(`‚ùå ${integration.name} n√£o encontrada`);
                }
            } catch (error) {
                this.integrations.push({ name: integration.name, status: 'error', error: error.message });
                console.log(`‚ùå Erro em ${integration.name}:`, error.message);
            }
        }
    }

    // üìä Inicializar Analytics
    async initializeAnalytics() {
        console.log('üìä Inicializando Portal Analytics...');
        
        try {
            if (window.PortalAnalytics && window.PortalAnalytics.initialized) {
                console.log('‚úÖ Portal Analytics inicializado');
                
                // Registrar evento de inicializa√ß√£o
                window.trackEvent('portal_initialization_started', {
                    timestamp: new Date().toISOString(),
                    components: this.components.length,
                    features: this.features.length,
                    integrations: this.integrations.length
                });
                
                this.initResults.push({ name: 'Portal Analytics', status: 'success' });
            } else {
                console.log('‚ùå Portal Analytics n√£o inicializado');
                this.initResults.push({ name: 'Portal Analytics', status: 'failed' });
            }
        } catch (error) {
            console.log('‚ùå Erro no Portal Analytics:', error.message);
            this.initResults.push({ name: 'Portal Analytics', status: 'error', error: error.message });
        }
    }

    // üì± Inicializar PWA
    async initializePWA() {
        console.log('üì± Inicializando PWA Features...');
        
        try {
            // Service Worker
            if ('serviceWorker' in navigator) {
                const registration = await navigator.serviceWorker.register('/sw.js');
                console.log('‚úÖ Service Worker registrado');
                this.initResults.push({ name: 'Service Worker', status: 'success' });
            } else {
                console.log('‚ùå Service Worker n√£o suportado');
                this.initResults.push({ name: 'Service Worker', status: 'not_supported' });
            }
            
            // Web App Manifest
            const manifestLink = document.querySelector('link[rel="manifest"]');
            if (manifestLink) {
                console.log('‚úÖ Web App Manifest configurado');
                this.initResults.push({ name: 'Web App Manifest', status: 'success' });
            } else {
                console.log('‚ùå Web App Manifest n√£o encontrado');
                this.initResults.push({ name: 'Web App Manifest', status: 'failed' });
            }
            
            // Notification API
            if ('Notification' in window) {
                console.log('‚úÖ Notification API dispon√≠vel');
                this.initResults.push({ name: 'Notification API', status: 'success' });
            } else {
                console.log('‚ùå Notification API n√£o suportada');
                this.initResults.push({ name: 'Notification API', status: 'not_supported' });
            }
            
        } catch (error) {
            console.log('‚ùå Erro na inicializa√ß√£o PWA:', error.message);
            this.initResults.push({ name: 'PWA Features', status: 'error', error: error.message });
        }
    }

    // üèÅ Finalizar Inicializa√ß√£o
    async finalizeInitialization() {
        console.log('üèÅ Finalizando inicializa√ß√£o...');
        
        const initTime = Date.now() - this.initStartTime;
        
        // Estat√≠sticas da inicializa√ß√£o
        const totalComponents = this.components.length + this.features.length + this.integrations.length + this.initResults.length;
        const successComponents = this.components.filter(c => c.status === 'success').length +
                                  this.features.filter(f => f.status === 'success').length +
                                  this.integrations.filter(i => i.status === 'success').length +
                                  this.initResults.filter(r => r.status === 'success').length;
        
        console.log('üìä ESTAT√çSTICAS DA INICIALIZA√á√ÉO:');
        console.log(`‚è±Ô∏è  Tempo total: ${initTime}ms`);
        console.log(`üì¶ Total de componentes: ${totalComponents}`);
        console.log(`‚úÖ Inicializados com sucesso: ${successComponents}`);
        console.log(`üìà Taxa de sucesso: ${((successComponents / totalComponents) * 100).toFixed(1)}%`);
        
        // Analytics da inicializa√ß√£o completa
        if (window.trackEvent) {
            window.trackEvent('portal_initialization_completed', {
                initTime,
                totalComponents,
                successComponents,
                successRate: (successComponents / totalComponents) * 100,
                timestamp: new Date().toISOString()
            });
        }
        
        // Salvar estat√≠sticas
        this.initStats = {
            initTime,
            totalComponents,
            successComponents,
            successRate: (successComponents / totalComponents) * 100
        };
    }

    // üéâ Mostrar Inicializa√ß√£o Completa
    showInitializationComplete() {
        const { initTime, totalComponents, successComponents, successRate } = this.initStats;
        
        console.log('üéâ PORTAL DR. MARCIO INICIALIZADO COM SUCESSO!');
        
        // Mostrar notifica√ß√£o de sucesso
        setTimeout(() => {
            if (typeof window.showAlert === 'function') {
                window.showAlert({
                    type: successRate >= 80 ? 'success' : 'warning',
                    title: 'üöÄ Portal Inicializado!',
                    message: `Sistema carregado em ${initTime}ms com ${successRate.toFixed(1)}% de sucesso`,
                    timeout: 6000,
                    actions: [
                        {
                            id: 'view-details',
                            label: 'Ver Detalhes',
                            callback: () => this.showInitializationDetails()
                        }
                    ]
                });
            } else {
                // Fallback se showAlert n√£o estiver dispon√≠vel
                alert(`üöÄ Portal Inicializado!\nSistema carregado em ${initTime}ms com ${successRate.toFixed(1)}% de sucesso`);
            }
        }, 2000); // Aumentar delay para garantir carregamento
    }

    // üìã Mostrar Detalhes da Inicializa√ß√£o
    showInitializationDetails() {
        if (typeof window.showModal !== 'function') {
            // Fallback se showModal n√£o estiver dispon√≠vel
            alert('Detalhes da inicializa√ß√£o dispon√≠veis no console (F12)');
            console.log('üìä Detalhes da Inicializa√ß√£o:', {
                components: this.components,
                features: this.features,
                integrations: this.integrations,
                results: this.initResults,
                stats: this.initStats
            });
            return;
        }
        
        const categories = [
            { name: 'Componentes', items: this.components },
            { name: 'Funcionalidades', items: this.features },
            { name: 'Integra√ß√µes', items: this.integrations },
            { name: 'Sistemas', items: this.initResults }
        ];

        const categoriesHTML = categories.map(category => `
            <div class="init-category">
                <h4>${category.name} (${category.items.filter(i => i.status === 'success').length}/${category.items.length})</h4>
                <div class="init-items">
                    ${category.items.map(item => `
                        <div class="init-item ${item.status}">
                            <span class="init-status">${this.getStatusIcon(item.status)}</span>
                            <span class="init-name">${item.name}</span>
                            ${item.error ? `<span class="init-error">${item.error}</span>` : ''}
                        </div>
                    `).join('')}
                </div>
            </div>
        `).join('');

        showModal({
            title: 'üöÄ Detalhes da Inicializa√ß√£o',
            content: `
                <div class="initialization-details">
                    <div class="init-summary">
                        <h3>Resumo da Inicializa√ß√£o</h3>
                        <div class="init-stats">
                            <div class="stat-item">
                                <span class="stat-number">${this.initStats.initTime}ms</span>
                                <span class="stat-label">Tempo de Carregamento</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-number">${this.initStats.successComponents}/${this.initStats.totalComponents}</span>
                                <span class="stat-label">Componentes Carregados</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-number">${this.initStats.successRate.toFixed(1)}%</span>
                                <span class="stat-label">Taxa de Sucesso</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="init-categories">
                        ${categoriesHTML}
                    </div>
                    
                    <div class="init-actions" style="margin-top: 20px; text-align: center;">
                        <button onclick="runPortalTests()" class="btn-primary">
                            üß™ Executar Testes
                        </button>
                        <button onclick="closeModal()" class="btn-secondary">
                            ‚úÖ Fechar
                        </button>
                    </div>
                </div>
            `,
            size: 'large'
        });
    }

    // üö® Mostrar Erro de Inicializa√ß√£o
    showInitializationError(error) {
        if (typeof window.showAlert === 'function') {
            window.showAlert({
                type: 'error',
                title: '‚ùå Erro na Inicializa√ß√£o',
                message: `Falha ao inicializar o portal: ${error.message}`,
                timeout: 0,
                actions: [
                    {
                        id: 'retry',
                        label: 'Tentar Novamente',
                        callback: () => location.reload()
                    },
                    {
                        id: 'details',
                        label: 'Ver Detalhes',
                        callback: () => console.error('Erro detalhado:', error)
                    }
                ]
            });
        } else {
            // Fallback se showAlert n√£o estiver dispon√≠vel
            console.error('‚ùå Erro na Inicializa√ß√£o:', error.message);
            alert('Erro na inicializa√ß√£o do portal. Verifique o console para detalhes.');
        }
    }

    // üéØ Utilit√°rios
    getStatusIcon(status) {
        const icons = {
            'success': '‚úÖ',
            'failed': '‚ùå', 
            'error': 'üí•',
            'not_supported': '‚ö†Ô∏è'
        };
        return icons[status] || '‚ùì';
    }
}

// üåü Inst√¢ncia global do inicializador
window.PortalMasterInitializer = new PortalMasterInitializer();

// üöÄ Fun√ß√£o global para inicializa√ß√£o
window.initializePortalComplete = function() {
    return window.PortalMasterInitializer.initializePortal();
};

// üéØ Auto-inicializa√ß√£o quando o DOM estiver pronto
document.addEventListener('DOMContentLoaded', function() {
    // Aguardar um pouco para todos os scripts carregarem
    setTimeout(() => {
        console.log('üéØ Iniciando Portal Master Initializer...');
        window.initializePortalComplete();
    }, 1500); // 1.5 segundos de delay para garantir carregamento
});

console.log('üöÄ Portal Master Initializer carregado');
