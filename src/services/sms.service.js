// src/services/sms.service.js
const twilio = require('twilio');
const axios = require('axios');

class SMSService {
  constructor() {
    this.twilioClient = twilio(
      process.env.TWILIO_ACCOUNT_SID,
      process.env.TWILIO_AUTH_TOKEN
    );
    this.whatsappAPI = process.env.WHATSAPP_API_URL;
    this.whatsappToken = process.env.WHATSAPP_TOKEN;
  }

  async enviarSMS(telefone, mensagem) {
    try {
      const messageOptions = {
        body: mensagem,
        to: this.formatarTelefone(telefone)
      };

      // Usar Messaging Service ID se dispon√≠vel, sen√£o usar n√∫mero direto
      if (process.env.TWILIO_MESSAGING_SERVICE_SID) {
        messageOptions.messagingServiceSid = process.env.TWILIO_MESSAGING_SERVICE_SID;
      } else {
        messageOptions.from = process.env.TWILIO_PHONE_NUMBER;
      }

      const message = await this.twilioClient.messages.create(messageOptions);
      
      return { sucesso: true, messageId: message.sid };
    } catch (error) {
      console.error('Erro ao enviar SMS:', error);
      return { sucesso: false, erro: error.message };
    }
  }

  async enviarWhatsApp(telefone, mensagem, template = null) {
    try {
      const payload = {
        messaging_product: 'whatsapp',
        to: this.formatarTelefone(telefone),
        type: template ? 'template' : 'text'
      };

      if (template) {
        payload.template = {
          name: template.name,
          language: { code: 'pt_BR' },
          components: template.components
        };
      } else {
        payload.text = { body: mensagem };
      }

      const response = await axios.post(
        `${this.whatsappAPI}/messages`,
        payload,
        {
          headers: {
            'Authorization': `Bearer ${this.whatsappToken}`,
            'Content-Type': 'application/json'
          }
        }
      );

      return { sucesso: true, messageId: response.data.messages[0].id };
    } catch (error) {
      console.error('Erro ao enviar WhatsApp:', error);
      return { sucesso: false, erro: error.message };
    }
  }

  async enviarConfirmacaoAgendamento(dados) {
    const mensagem = `
üè• *Confirma√ß√£o de Agendamento*

Ol√° ${dados.nome}!

Seu agendamento foi confirmado:
üìÖ Data: ${new Date(dados.data).toLocaleDateString('pt-BR')}
üïê Hor√°rio: ${new Date(dados.data).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}
ü©∫ Servi√ßo: ${dados.servico}

üìç Endere√ßo: ${process.env.ENDERECO_CLINICA}
üìû Contato: ${process.env.TELEFONE_CLINICA}

Em caso de necessidade de reagendamento, entre em contato conosco.

Dr. Marcio - Cirurgia Pl√°stica
    `.trim();

    // Tentar WhatsApp primeiro, depois SMS
    let resultado = await this.enviarWhatsApp(dados.telefone, mensagem);
    
    if (!resultado.sucesso) {
      resultado = await this.enviarSMS(dados.telefone, mensagem);
    }

    return resultado;
  }

  async enviarLembreteAgendamento(dados) {
    const template = {
      name: 'lembrete_consulta',
      components: [
        {
          type: 'body',
          parameters: [
            { type: 'text', text: dados.nome },
            { type: 'text', text: new Date(dados.data).toLocaleDateString('pt-BR') },
            { type: 'text', text: new Date(dados.data).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }) },
            { type: 'text', text: dados.servico }
          ]
        }
      ]
    };

    return await this.enviarWhatsApp(dados.telefone, null, template);
  }

  async enviarCancelamentoAgendamento(dados) {
    const mensagem = `
‚ùå *Agendamento Cancelado*

Ol√° ${dados.nome}!

Informamos que seu agendamento foi cancelado:

üìÖ Data: ${dados.data}
üïê Hor√°rio: ${dados.hora}
ü©∫ Servi√ßo: ${dados.servico}
${dados.motivo ? `üìù Motivo: ${dados.motivo}` : ''}

Para reagendar, entre em contato conosco:
üìû ${process.env.TELEFONE_CLINICA}

Dr. Marcio - Cirurgia Pl√°stica
    `.trim();

    // Tentar WhatsApp primeiro, depois SMS
    let resultado = await this.enviarWhatsApp(dados.telefone, mensagem);
    
    if (!resultado.sucesso) {
      resultado = await this.enviarSMS(dados.telefone, mensagem);
    }

    return resultado;
  }

  async enviarReagendamento(dados) {
    const mensagem = `
üìÖ *Agendamento Reagendado*

Ol√° ${dados.nome}!

Seu agendamento foi reagendado:

‚ùå *Anterior:*
üìÖ Data: ${dados.dataAnterior}
üïê Hor√°rio: ${dados.horaAnterior}

‚úÖ *Novo:*
üìÖ Data: ${dados.dataNova}
üïê Hor√°rio: ${dados.horaNova}
ü©∫ Servi√ßo: ${dados.servico}

üìç Local: ${process.env.ENDERECO_CLINICA}

*Lembre-se:*
‚Ä¢ Chegue 15 min antes
‚Ä¢ Traga documento com foto

Dr. Marcio - Cirurgia Pl√°stica
    `.trim();

    // Tentar WhatsApp primeiro, depois SMS
    let resultado = await this.enviarWhatsApp(dados.telefone, mensagem);
    
    if (!resultado.sucesso) {
      resultado = await this.enviarSMS(dados.telefone, mensagem);
    }

    return resultado;
  }

  async enviarLembrete24h(dados) {
    const mensagem = `
üîî *Lembrete de Consulta*

Ol√° ${dados.nome}!

Voc√™ tem uma consulta AMANH√É:

üìÖ Data: ${dados.data}
üïê Hor√°rio: ${dados.hora}
ü©∫ Servi√ßo: ${dados.servico}

üìç Local: ${process.env.ENDERECO_CLINICA}

*Importante:*
‚Ä¢ Chegue 15 min antes
‚Ä¢ Traga RG ou CNH
‚Ä¢ Use m√°scara

Para reagendar: ${process.env.TELEFONE_CLINICA}

Dr. Marcio - Cirurgia Pl√°stica
    `.trim();

    // Tentar WhatsApp primeiro, depois SMS
    let resultado = await this.enviarWhatsApp(dados.telefone, mensagem);
    
    if (!resultado.sucesso) {
      resultado = await this.enviarSMS(dados.telefone, mensagem);
    }

    return resultado;
  }

  async enviarOrcamento(dados) {
    const servicosTexto = dados.servicos.map(s => 
      `‚Ä¢ ${s.nome} (${s.quantidade || 1}x) - R$ ${s.valor.toFixed(2)}`
    ).join('\n');

    const mensagem = `
üí∞ *Or√ßamento ${dados.numeroOrcamento}*

Ol√° ${dados.nome}!

Segue seu or√ßamento:

*Servi√ßos:*
${servicosTexto}

*Total: R$ ${dados.valorTotal.toFixed(2)}*
*V√°lido at√©: ${dados.validade}*

${dados.observacoes ? `*Observa√ß√µes:*\n${dados.observacoes}\n` : ''}

*Formas de Pagamento:*
‚Ä¢ PIX (3% desconto)
‚Ä¢ Cart√£o at√© 12x
‚Ä¢ Dinheiro (5% desconto)

Para aceitar: ${process.env.TELEFONE_CLINICA}

Dr. Marcio - Cirurgia Pl√°stica
    `.trim();

    // Tentar WhatsApp primeiro, depois SMS
    let resultado = await this.enviarWhatsApp(dados.telefone, mensagem);
    
    if (!resultado.sucesso) {
      resultado = await this.enviarSMS(dados.telefone, mensagem);
    }

    return resultado;
  }

  async enviarCodigoVerificacao(telefone, codigo) {
    const mensagem = `
üîê *C√≥digo de Verifica√ß√£o*

Seu c√≥digo de verifica√ß√£o √©: *${codigo}*

‚è∞ V√°lido por 10 minutos
üîí N√£o compartilhe este c√≥digo

Dr. Marcio - Portal M√©dico
    `.trim();

    // SMS √© mais adequado para c√≥digos de verifica√ß√£o
    return await this.enviarSMS(telefone, mensagem);
  }

  async enviarBoasVindas(dados) {
    const mensagem = `
üéâ *Bem-vindo ao Portal Dr. Marcio!*

Ol√° ${dados.nome}!

Sua conta foi criada com sucesso!

*O que voc√™ pode fazer:*
‚Ä¢ Agendar consultas online
‚Ä¢ Receber lembretes autom√°ticos
‚Ä¢ Acessar hist√≥rico m√©dico
‚Ä¢ Solicitar or√ßamentos

*Dados para login:*
üìß Email: ${dados.email}

Acesse: ${process.env.FRONTEND_URL}/login

Dr. Marcio - Cirurgia Pl√°stica
üìû ${process.env.TELEFONE_CLINICA}
    `.trim();

    // Tentar WhatsApp primeiro, depois SMS
    let resultado = await this.enviarWhatsApp(dados.telefone, mensagem);
    
    if (!resultado.sucesso) {
      resultado = await this.enviarSMS(dados.telefone, mensagem);
    }

    return resultado;
  }

  async enviarConfirmacaoPagamento(dados) {
    const mensagem = `
üéâ *Pagamento Confirmado!*

Ol√° ${dados.nome}!

Seu pagamento foi aprovado:

üìã Or√ßamento: ${dados.numeroOrcamento}
üí∞ Valor: R$ ${dados.valor.toFixed(2)}
‚úÖ Status: PAGO
üìÖ Data: ${new Date().toLocaleDateString('pt-BR')}

*Pr√≥ximos passos:*
‚Ä¢ Entraremos em contato para agendar
‚Ä¢ Prepare-se para sua transforma√ß√£o! üåü

üìû Contato: ${process.env.TELEFONE_CLINICA}

Dr. Marcio - Cirurgia Pl√°stica
Obrigado por confiar em nosso trabalho!
    `.trim();

    // Tentar WhatsApp primeiro, depois SMS
    let resultado = await this.enviarWhatsApp(dados.telefone, mensagem);
    
    if (!resultado.sucesso) {
      resultado = await this.enviarSMS(dados.telefone, mensagem);
    }

    return resultado;
  }

  formatarTelefone(telefone) {
    // Verificar se telefone foi fornecido
    if (!telefone) {
      throw new Error('N√∫mero de telefone √© obrigat√≥rio');
    }
    
    // Remove caracteres n√£o num√©ricos
    const numero = telefone.toString().replace(/\D/g, '');
    
    // Adiciona c√≥digo do pa√≠s se n√£o tiver
    if (numero.length === 11) {
      return `+55${numero}`;
    } else if (numero.length === 13 && numero.startsWith('55')) {
      return `+${numero}`;
    }
    
    return telefone;
  }

  // M√©todo para verificar status de entrega
  async verificarStatusEntrega(messageId, tipo = 'sms') {
    try {
      if (tipo === 'sms') {
        const message = await this.twilioClient.messages(messageId).fetch();
        return {
          status: message.status,
          erro: message.errorMessage
        };
      } else if (tipo === 'whatsapp') {
        const response = await axios.get(
          `${this.whatsappAPI}/messages/${messageId}`,
          {
            headers: {
              'Authorization': `Bearer ${this.whatsappToken}`
            }
          }
        );
        return response.data;
      }
    } catch (error) {
      console.error('Erro ao verificar status:', error);
      return { erro: error.message };
    }
  }

  // M√©todo para testar configura√ß√µes
  async testarConfiguracao() {
    const resultados = {
      twilio: false,
      whatsapp: false,
      erros: []
    };

    // Testar Twilio
    try {
      if (process.env.TWILIO_ACCOUNT_SID && process.env.TWILIO_AUTH_TOKEN) {
        await this.twilioClient.accounts.list({ limit: 1 });
        resultados.twilio = true;
        console.log('‚úÖ Configura√ß√£o Twilio v√°lida');
      } else {
        resultados.erros.push('Credenciais Twilio n√£o configuradas');
      }
    } catch (error) {
      resultados.erros.push(`Erro Twilio: ${error.message}`);
    }

    // Testar WhatsApp API
    try {
      if (process.env.WHATSAPP_API_URL && process.env.WHATSAPP_TOKEN) {
        const response = await axios.get(
          `${this.whatsappAPI}/phone_numbers`,
          {
            headers: {
              'Authorization': `Bearer ${this.whatsappToken}`
            }
          }
        );
        if (response.status === 200) {
          resultados.whatsapp = true;
          console.log('‚úÖ Configura√ß√£o WhatsApp v√°lida');
        }
      } else {
        resultados.erros.push('Credenciais WhatsApp n√£o configuradas');
      }
    } catch (error) {
      resultados.erros.push(`Erro WhatsApp: ${error.message}`);
    }

    return resultados;
  }

  // M√©todo para envio em lote
  async enviarEmLote(mensagens) {
    const resultados = [];
    
    for (const msg of mensagens) {
      try {
        let resultado;
        
        if (msg.tipo === 'whatsapp') {
          resultado = await this.enviarWhatsApp(msg.telefone, msg.mensagem, msg.template);
        } else {
          resultado = await this.enviarSMS(msg.telefone, msg.mensagem);
        }
        
        resultados.push({
          telefone: msg.telefone,
          sucesso: resultado.sucesso,
          messageId: resultado.messageId,
          erro: resultado.erro
        });
        
        // Delay para evitar rate limiting
        await new Promise(resolve => setTimeout(resolve, 1000));
        
      } catch (error) {
        resultados.push({
          telefone: msg.telefone,
          sucesso: false,
          erro: error.message
        });
      }
    }
    
    return resultados;
  }

  // M√©todo para criar templates WhatsApp (apenas para refer√™ncia)
  criarTemplateWhatsApp(nome, categoria, componentes) {
    return {
      name: nome,
      category: categoria,
      language: 'pt_BR',
      components: componentes
    };
  }

  // Templates pr√©-definidos
  obterTemplates() {
    return {
      lembrete_consulta: {
        name: 'lembrete_consulta',
        components: [
          {
            type: 'header',
            format: 'text',
            text: 'üîî Lembrete de Consulta'
          },
          {
            type: 'body',
            text: 'Ol√° {{1}}! Voc√™ tem uma consulta agendada para {{2}} √†s {{3}} - {{4}}. N√£o se esque√ßa!'
          },
          {
            type: 'footer',
            text: 'Dr. Marcio - Cirurgia Pl√°stica'
          }
        ]
      },
      confirmacao_agendamento: {
        name: 'confirmacao_agendamento',
        components: [
          {
            type: 'header',
            format: 'text',
            text: '‚úÖ Agendamento Confirmado'
          },
          {
            type: 'body',
            text: 'Ol√° {{1}}! Seu agendamento foi confirmado para {{2}} √†s {{3}} - {{4}}.'
          },
          {
            type: 'footer',
            text: 'Dr. Marcio - Cirurgia Pl√°stica'
          }
        ]
      }
    };
  }
}

module.exports = new SMSService();
