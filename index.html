<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Dr. Marcio - Verifica√ß√£o de Acesso</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üè•</text></svg>">
    <link rel="stylesheet" href="style.css">
    
    <!-- üé® Portal Components System -->
    <link rel="stylesheet" href="components/portal-components.css">
    
    <!-- üéØ Professional Features -->
    <link rel="stylesheet" href="features/portal-professional-features.css">
    
    <!-- üìä Analytics System -->
    <script src="analytics/portal-analytics.js"></script>
    
    <!-- üîß Configura√ß√£o -->
    <script src="assets/js/config.js"></script>
    
    <!-- üé® UI Components -->
    <script src="components/portal-components.js"></script>
    
    <!-- üîå Integrations -->
    <script src="integrations/portal-integrations.js"></script>
    
    <!-- üéØ Professional Features -->
    <script src="features/portal-professional-features.js"></script>
    
    <!-- üöÄ Edge Functions Client -->
    <script src="assets/js/edge-functions-client.js"></script>
    
    <!-- üõ£Ô∏è Sistema de Roteamento -->
    <script src="assets/js/portal-router.js"></script>
    
    <!-- üîê Sistema de Autentica√ß√£o -->
    <script src="assets/js/portal-auth.js"></script>
    
    <!-- üì± PWA Manifest -->
    <link rel="manifest" href="manifest.json">
</head>
<body>
    <div class="container">
        <div class="form-container">
            <h1>Portal Dr. Marcio</h1>
            <p>Digite seu email para acessar o sistema</p>
            
            <form id="verificarForm">
                <div class="input-group">
                    <label for="email">Email:</label>
                    <input type="email" id="email" name="email" required>
                </div>
                
                <button type="submit" class="btn-primary">Verificar Email</button>
            </form>
            
            <div id="loading" class="loading" style="display: none;">
                Verificando...
            </div>
            
            <div id="message" class="message"></div>
        </div>
    </div>

    <script>
        // üöÄ Sistema de Roteamento e Autentica√ß√£o Integrados
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üöÄ Inicializando Portal Dr. Marcio...');
            
            // Inicializar sistema de autentica√ß√£o
            if (window.PortalAuth) {
                window.PortalAuth.init();
                
                // Verificar se j√° existe uma sess√£o ativa
                const userInfo = window.PortalAuth.getCurrentUser();
                if (userInfo) {
                    console.log('üîç Sess√£o existente encontrada:', userInfo);
                    
                    // Alert moderno para sess√£o ativa
                    if (window.showAlert) {
                        window.showAlert({
                            type: 'info',
                            title: 'Sess√£o Ativa',
                            message: 'Redirecionando para o dashboard...',
                            timeout: 3000
                        });
                    }
                    
                    // Analytics
                    if (window.trackEvent) {
                        window.trackEvent('active_session_found', { 
                            userId: userInfo.id,
                            email: userInfo.email 
                        });
                    }
                    
                    // Redirecionar baseado no tipo de usu√°rio
                    setTimeout(() => {
                        const redirectRoute = userInfo.tipoUsuario === 'admin' ? 'DASHBOARD_ADMIN' : 'DASHBOARD';
                        window.PortalRouter.navigateTo(redirectRoute);
                    }, 1000);
                }
            }
            
            // Registrar Service Worker
            if ('serviceWorker' in navigator) {
                try {
                    const registration = await navigator.serviceWorker.register('/sw.js');
                    console.log('‚úÖ Service Worker registrado:', registration);
                    
                    // Analytics para PWA
                    if (window.trackEvent) {
                        window.trackEvent('pwa_service_worker_registered', {
                            scope: registration.scope
                        });
                    }
                } catch (error) {
                    console.error('‚ùå Erro ao registrar Service Worker:', error);
                }
            }
        });
        
        // Formul√°rio de verifica√ß√£o de email
        document.getElementById('verificarForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const email = document.getElementById('email').value.trim().toLowerCase();
            const loading = document.getElementById('loading');
            const message = document.getElementById('message');
            
            if (!email) {
                message.innerHTML = '<div class="error">Por favor, digite um email v√°lido</div>';
                return;
            }
            
            message.innerHTML = '';
            loading.style.display = 'block';
            
            try {
                // Usar sistema Edge Functions Client para verifica√ß√£o de email
                const resultado = await window.EdgeFunctionsClient.call(
                    'admin-auth/verify-email',
                    { email }
                );
                
                console.log('Resposta da verifica√ß√£o:', resultado);
                
                if (resultado.acao === 'login') {
                    // ‚úÖ EMAIL J√Å CADASTRADO - Redirecionar para LOGIN
                    message.innerHTML = `<div class="success">‚úÖ ${resultado.mensagem}</div>`;
                    
                    // Armazenar temporariamente para pr√©-preencher no login
                    sessionStorage.setItem('tempEmail', email);
                    console.log('‚úÖ Email j√° cadastrado. Redirecionando para login...');
                    
                    // Usar o router para navega√ß√£o
                    setTimeout(() => {
                        window.PortalRouter.navigateTo('LOGIN', { email: email });
                    }, 1500);
                    
                } else if (resultado.acao === 'cadastro_admin') {
                    // üëë EMAIL DE ADMIN N√ÉO CADASTRADO - Redirecionar para CADASTRO ADMIN
                    loading.style.display = 'none';
                    
                    if (window.showAlert) {
                        window.showAlert({
                            type: 'info',
                            title: 'Primeiro Administrador',
                            message: resultado.mensagem,
                            timeout: 4000
                        });
                    }
                    
                    // Armazenar informa√ß√µes necess√°rias
                    sessionStorage.setItem('tempEmail', email);
                    sessionStorage.setItem('emailVerificado', 'true');
                    sessionStorage.setItem('verificacaoTimestamp', Date.now().toString());
                    sessionStorage.setItem('usuarioTipo', 'admin');
                    sessionStorage.setItem('primeiroAdmin', 'true');
                    
                    console.log('üëë Admin n√£o cadastrado. Redirecionando para cadastro admin...');
                    
                    // Usar o router para navega√ß√£o
                    setTimeout(() => {
                        window.PortalRouter.navigateTo('CADASTRO', { 
                            email: email,
                            tipo: 'admin' 
                        });
                    }, 1500);
                    
                } else {
                    // üìù EMAIL N√ÉO CADASTRADO - Redirecionar para CADASTRO
                    message.innerHTML = `<div class="info">üìù ${resultado.mensagem}</div>`;
                    
                    // Armazenar informa√ß√µes necess√°rias
                    sessionStorage.setItem('tempEmail', email);
                    sessionStorage.setItem('emailVerificado', 'true');
                    sessionStorage.setItem('verificacaoTimestamp', Date.now().toString());
                    sessionStorage.setItem('usuarioTipo', resultado.tipo || 'funcionario');
                    
                    console.log('üìù Email n√£o cadastrado. Redirecionando para cadastro...');
                    
                    // Usar o router para navega√ß√£o
                    setTimeout(() => {
                        window.PortalRouter.navigateTo('CADASTRO', { email: email });
                    }, 1500);
                }
                
            } catch (error) {
                console.error('‚ùå Erro na verifica√ß√£o:', error);
                
                // Fallback para modo local (sem Supabase)
                message.innerHTML = `<div class="warning">‚ö†Ô∏è Sistema offline. Usando modo local...</div>`;
                
                // Permitir continuar para login
                setTimeout(() => {
                    window.PortalRouter.navigateTo('LOGIN', { email: email, offline: true });
                }, 2000);
            } finally {
                loading.style.display = 'none';
            }
        });
    </script>
</body>
</html>
