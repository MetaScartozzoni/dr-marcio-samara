<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro - Portal Dr. Marcio</title>
    <link rel="stylesheet" href="style.css">
    <!-- VERSAO ATUALIZADA COM TIPO DE USUARIO - 28/07/2025 -->
</head>
<body>
    <div class="container">
        <div class="form-container">
            <h1>Cadastro</h1>
            <p>Preencha seus dados para se cadastrar</p>
            
            <form id="cadastroForm">
                <div class="input-group">
                    <label for="nome">Nome Completo:</label>
                    <input type="text" id="nome" name="nome" required>
                </div>
                
                <div class="input-group">
                    <label for="email">Email:</label>
                    <input type="email" id="email" name="email" required>
                </div>
                
                <div class="input-group">
                    <label for="telefone">Telefone (opcional):</label>
                    <input type="tel" id="telefone" name="telefone">
                </div>
                
                <div class="input-group">
                    <label for="cpf">CPF (opcional):</label>
                    <input type="text" id="cpf" name="cpf">
                </div>
                
                <div class="input-group">
                    <label for="senha">Senha:</label>
                    <input type="password" id="senha" name="senha" required minlength="6">
                </div>
                
                <div class="input-group">
                    <label for="confirmar_senha">Confirmar Senha:</label>
                    <input type="password" id="confirmar_senha" name="confirmar_senha" required minlength="6">
                </div>
                
                <button type="submit" class="btn-primary">Cadastrar</button>
            </form>
            
            <div id="loading" class="loading" style="display: none;">
                Cadastrando...
            </div>
            
            <div id="message" class="message"></div>
            
            <p class="text-center">
                <a href="/" class="link">Voltar √† verifica√ß√£o de email</a>
            </p>
        </div>
    </div>

    <script>
        // Preencher email automaticamente se vier da verifica√ß√£o
        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            const emailFromUrl = urlParams.get('email');
            const emailFromStorage = localStorage.getItem('tempEmail');
            
            // Verificar se passou pela verifica√ß√£o recente (√∫ltimos 5 minutos)
            const emailVerificado = localStorage.getItem('emailVerificado');
            const verificacaoTimestamp = localStorage.getItem('verificacaoTimestamp');
            const agora = Date.now();
            const cincoMinutos = 5 * 60 * 1000; // 5 minutos em ms
            
            const verificacaoRecente = verificacaoTimestamp && 
                                     (agora - parseInt(verificacaoTimestamp)) < cincoMinutos;
            
            if (!emailVerificado || !verificacaoRecente) {
                alert('Acesso n√£o autorizado. Fa√ßa a verifica√ß√£o de email primeiro.');
                localStorage.removeItem('emailVerificado');
                localStorage.removeItem('verificacaoTimestamp');
                localStorage.removeItem('tempEmail');
                window.location.href = '/index.html';
                return;
            }
            
            const emailInput = document.getElementById('email');
            
            if (emailFromUrl) {
                emailInput.value = emailFromUrl;
                emailInput.readOnly = true; // Tornar readonly para n√£o alterar
            } else if (emailFromStorage) {
                emailInput.value = emailFromStorage;
                emailInput.readOnly = true; // Tornar readonly para n√£o alterar
            } else {
                alert('Email n√£o encontrado. Fa√ßa a verifica√ß√£o primeiro.');
                localStorage.removeItem('emailVerificado');
                localStorage.removeItem('verificacaoTimestamp');
                window.location.href = '/index.html';
                return;
            }
            
            // Limpar tokens ap√≥s uso
            localStorage.removeItem('emailVerificado');
            localStorage.removeItem('verificacaoTimestamp');
            localStorage.removeItem('tempEmail');
        };
        
        document.getElementById('cadastroForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const senha = document.getElementById('senha').value;
            const confirmarSenha = document.getElementById('confirmar_senha').value;
            
            // Validar senhas
            if (senha !== confirmarSenha) {
                document.getElementById('message').innerHTML = '<div class="error">As senhas n√£o coincidem!</div>';
                return;
            }
            
            const formData = {
                nome: document.getElementById('nome').value,
                email: document.getElementById('email').value,
                telefone: document.getElementById('telefone').value,
                cpf: document.getElementById('cpf').value,
                senha: senha
            };
            
            console.log('üìù Enviando dados:', formData);
            
            const loading = document.getElementById('loading');
            const message = document.getElementById('message');
            
            loading.style.display = 'block';
            message.innerHTML = '';
            
            try {
                const response = await fetch('/api/cadastrar', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                const data = await response.json();
                console.log('üì• Resposta recebida:', data);
                
                if (data.sucesso) {
                    message.innerHTML = '<div class="success">' + data.message + '</div>';
                    
                    // Se houver dados do usu√°rio, salv√°-los para auto-login
                    if (data.user) {
                        localStorage.setItem('userInfo', JSON.stringify(data.user));
                    }
                    
                    setTimeout(() => {
                        // Redirecionar para aprova√ß√£o ou login
                        if (data.autorizado) {
                            window.location.href = '/criar-senha?email=' + encodeURIComponent(formData.email);
                        } else {
                            window.location.href = '/aguardando-autorizacao';
                        }
                    }, 2000);
                } else {
                    message.innerHTML = '<div class="error">' + (data.message || data.erro) + '</div>';
                }
            } catch (error) {
                console.error('‚ùå Erro:', error);
                message.innerHTML = '<div class="error">Erro ao cadastrar. Tente novamente.</div>';
            } finally {
                loading.style.display = 'none';
            }
        });
    </script>
</body>
</html>