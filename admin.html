<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciar Usu√°rios - Portal Dr. Marcio</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .admin-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 25px;
        }
        
        .admin-header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .admin-header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }
        
        .admin-header p {
            font-size: 18px;
            opacity: 0.9;
        }
        
        .admin-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }
        
        .admin-section {
            background: white;
            padding: 35px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            border: 1px solid #e0e0e0;
            transition: transform 0.3s ease;
        }
        
        .admin-section:hover {
            transform: translateY(-5px);
        }
        
        .admin-section h2 {
            margin-top: 0;
            margin-bottom: 25px;
            color: #1e3c72;
            font-size: 22px;
            font-weight: 700;
            border-bottom: 3px solid #1e3c72;
            padding-bottom: 15px;
        }
        
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-col {
            flex: 1;
        }
        
        .form-col label {
            display: block;
            margin-bottom: 8px;
            font-weight: 700;
            color: #1e3c72;
            font-size: 16px;
        }
        
        .form-col input,
        .form-col select {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .form-col input:focus,
        .form-col select:focus {
            border-color: #1e3c72;
            outline: none;
        }
        
        .btn-admin {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.3s;
        }
        
        .btn-admin:hover {
            transform: translateY(-2px);
        }
        
        .users-section {
            background: white;
            padding: 35px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            border: 1px solid #e0e0e0;
        }
        
        .users-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 16px;
            margin-top: 20px;
        }
        
        .users-table th {
            background: #1e3c72;
            color: white;
            padding: 16px 12px;
            border: 1px solid #ddd;
            text-align: left;
            font-weight: 700;
            font-size: 16px;
        }
        
        .users-table td {
            padding: 14px 12px;
            border: 1px solid #ddd;
            vertical-align: middle;
            font-size: 15px;
        }
        
        .users-table tr:nth-child(even) {
            background: #f9f9f9;
        }
        
        .status-badge {
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 14px;
            font-weight: 700;
            color: white;
            display: inline-block;
        }
        
        .badge-admin { background: #dc3545; }
        .badge-funcionario { background: #ffc107; color: #333; }
        .badge-paciente { background: #28a745; }
        
        .message-area {
            margin: 25px 0;
            min-height: 60px;
        }
        
        .loading {
            text-align: center;
            padding: 25px;
            color: #1e3c72;
            font-size: 18px;
            font-weight: 600;
        }
        
        /* Responsivo para mobile */
        @media (max-width: 768px) {
            .admin-grid {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                flex-direction: column;
                gap: 15px;
            }
            
            .users-table {
                font-size: 14px;
            }
            
            .users-table th,
            .users-table td {
                padding: 10px 6px;
            }
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <div class="admin-header">
            <h1>üè• Portal Administrativo - Dr. Marcio</h1>
            <p>Sistema de gerenciamento de usu√°rios e autoriza√ß√µes</p>
        </div>
        
        <!-- Se√ß√µes lado a lado: Perfil e Status -->
        <div class="admin-grid">
            <!-- Se√ß√£o: Atualizar Role -->
            <div class="admin-section">
                <h2>üîß Atualizar Tipo de Usu√°rio</h2>
                <form id="updateRoleForm">
                    <div class="form-row">
                        <div class="form-col">
                            <label for="email">Email do Usu√°rio:</label>
                            <input type="email" id="email" name="email" required placeholder="Digite o email">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <label for="novoRole">Novo Tipo:</label>
                            <select id="novoRole" name="novoRole" required>
                                <option value="">Selecione o tipo</option>
                                <option value="paciente">üë§ Paciente</option>
                                <option value="funcionario">üë®‚Äç‚öïÔ∏è Funcion√°rio</option>
                                <option value="admin">üëë Administrador</option>
                            </select>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn-admin">Atualizar Tipo</button>
                </form>
            </div>

            <!-- Se√ß√£o: Atualizar Autoriza√ß√£o -->
            <div class="admin-section">
                <h2>‚úÖ Gerenciar Autoriza√ß√£o</h2>
                <form id="updateAuthForm">
                    <div class="form-row">
                        <div class="form-col">
                            <label for="emailAuth">Email do Usu√°rio:</label>
                            <input type="email" id="emailAuth" name="emailAuth" required placeholder="Digite o email">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <label for="autorizado">Status:</label>
                            <select id="autorizado" name="autorizado" required>
                                <option value="">Selecione o status</option>
                                <option value="sim">‚úÖ Autorizado</option>
                                <option value="nao">‚ùå Bloqueado</option>
                            </select>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn-admin">Atualizar Status</button>
                </form>
            </div>
        </div>
        
        <!-- √Årea de mensagens -->
        <div class="message-area">
            <div id="loading" class="loading" style="display: none;">
                ‚è≥ Processando...
            </div>
            <div id="message"></div>
        </div>
        
        <!-- Se√ß√£o: Lista de Usu√°rios (embaixo, largura total) -->
        <div class="users-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0; border: none; padding: 0;">üë• Usu√°rios Cadastrados</h2>
                <button onclick="carregarUsuarios()" class="btn-admin" style="width: auto; padding: 8px 16px;">
                    üîÑ Atualizar Lista
                </button>
            </div>
            
            <div id="listaUsuarios">
                <p style="text-align: center; color: #666; padding: 40px;">
                    üìã Clique em "Atualizar Lista" para carregar os usu√°rios
                </p>
            </div>
        </div>
        
        <div style="text-align: center; margin-top: 30px; padding: 20px;">
            <a href="/dashboard.html" class="btn-admin" style="width: auto; padding: 10px 20px; text-decoration: none; display: inline-block;">
                üè† Voltar ao Dashboard
            </a>
        </div>
    </div>

    <script>
        // Atualizar Role
        document.getElementById('updateRoleForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('email').value;
            const novoRole = document.getElementById('novoRole').value;
            
            await processarRequest('/api/atualizar-role', { email, novoRole }, 'Role');
        });

        // Atualizar Autoriza√ß√£o
        document.getElementById('updateAuthForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('emailAuth').value;
            const autorizado = document.getElementById('autorizado').value;
            
            await processarRequest('/api/atualizar-autorizacao', { email, autorizado }, 'Autoriza√ß√£o');
        });

        // Fun√ß√£o comum para processar requests
        async function processarRequest(url, data, tipo) {
            const loading = document.getElementById('loading');
            const message = document.getElementById('message');
            
            loading.style.display = 'block';
            message.innerHTML = '';
            
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                console.log('üì• Resposta:', result);
                
                if (result.sucesso) {
                    if (tipo === 'Role') {
                        message.innerHTML = `
                            <div class="success">
                                ‚úÖ Tipo de usu√°rio atualizado com sucesso!<br>
                                <strong>Email:</strong> ${result.email}<br>
                                <strong>De:</strong> ${result.roleAnterior} ‚Üí <strong>Para:</strong> ${result.novoRole}
                            </div>
                        `;
                        document.getElementById('updateRoleForm').reset();
                    } else if (tipo === 'Autoriza√ß√£o') {
                        message.innerHTML = `
                            <div class="success">
                                ‚úÖ Autoriza√ß√£o atualizada com sucesso!<br>
                                <strong>Email:</strong> ${result.email}<br>
                                <strong>De:</strong> ${result.autorizacaoAnterior} ‚Üí <strong>Para:</strong> ${result.novaAutorizacao}
                            </div>
                        `;
                        document.getElementById('updateAuthForm').reset();
                    }
                    
                    // Atualizar lista automaticamente
                    setTimeout(() => {
                        carregarUsuarios();
                    }, 1000);
                } else {
                    message.innerHTML = '<div class="error">' + result.erro + '</div>';
                }
            } catch (error) {
                console.error('‚ùå Erro:', error);
                message.innerHTML = '<div class="error">Erro ao atualizar ' + tipo.toLowerCase() + '. Tente novamente.</div>';
            } finally {
                loading.style.display = 'none';
            }
        }
        
        // Fun√ß√£o para carregar lista de usu√°rios
        async function carregarUsuarios() {
            const loading = document.getElementById('loading');
            const listaUsuarios = document.getElementById('listaUsuarios');
            
            loading.style.display = 'block';
            
            try {
                const response = await fetch('/api/listar-usuarios');
                const result = await response.json();
                console.log('üë• Usu√°rios:', result);
                
                if (result.sucesso) {
                    let html = `
                        <div style="margin-bottom: 15px; text-align: center;">
                            <span style="background: #667eea; color: white; padding: 8px 16px; border-radius: 20px; font-weight: 600;">
                                üìä Total: ${result.total} usu√°rios
                            </span>
                        </div>
                        <div style="overflow-x: auto;">
                            <table class="users-table">
                                <thead>
                                    <tr>
                                        <th>üë§ Nome</th>
                                        <th>üìß Email</th>
                                        <th style="text-align: center;">üè∑Ô∏è Tipo</th>
                                        <th style="text-align: center;">‚úÖ Status</th>
                                        <th style="text-align: center;">üìÖ Cadastro</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    result.usuarios.forEach(user => {
                        const tipoClass = user.tipo === 'admin' ? 'badge-admin' : 
                                         user.tipo === 'funcionario' ? 'badge-funcionario' : 'badge-paciente';
                        const autorizadoIcon = user.autorizado ? '‚úÖ Ativo' : '‚ùå Bloqueado';
                        const autorizadoColor = user.autorizado ? '#28a745' : '#dc3545';
                        const dataCadastro = new Date(user.created_at).toLocaleDateString('pt-BR', {
                            day: '2-digit',
                            month: '2-digit',
                            year: 'numeric'
                        });
                        
                        html += `
                            <tr>
                                <td style="font-weight: 500;">${user.nome}</td>
                                <td style="color: #666;">${user.email}</td>
                                <td style="text-align: center;">
                                    <span class="status-badge ${tipoClass}">
                                        ${user.tipo.toUpperCase()}
                                    </span>
                                </td>
                                <td style="text-align: center; color: ${autorizadoColor}; font-weight: 600;">
                                    ${autorizadoIcon}
                                </td>
                                <td style="text-align: center; color: #666;">
                                    ${dataCadastro}
                                </td>
                            </tr>
                        `;
                    });
                    
                    html += `
                                </tbody>
                            </table>
                        </div>
                    `;
                    
                    listaUsuarios.innerHTML = html;
                } else {
                    listaUsuarios.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #dc3545;">
                            ‚ùå Erro ao carregar usu√°rios: ${result.erro}
                        </div>
                    `;
                }
            } catch (error) {
                console.error('‚ùå Erro:', error);
                listaUsuarios.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #dc3545;">
                        ‚ùå Erro de conex√£o. Tente novamente.
                    </div>
                `;
            } finally {
                loading.style.display = 'none';
            }
        }
    </script>
</body>
</html>
