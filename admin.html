<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciar Usu√°rios - Portal Dr. Marcio</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .section {
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #fafafa;
        }
        .section h2 {
            margin-top: 0;
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="form-container">
            <h1>Gerenciar Usu√°rios</h1>
            <p>Atualize roles e autoriza√ß√µes dos usu√°rios</p>
            
            <!-- Se√ß√£o: Atualizar Role -->
            <div class="section">
                <h2>üîß Atualizar Tipo de Usu√°rio (Role)</h2>
                <form id="updateRoleForm">
                    <div class="input-group">
                        <label for="email">Email do Usu√°rio:</label>
                        <input type="email" id="email" name="email" required placeholder="Digite o email do usu√°rio">
                    </div>
                    
                    <div class="input-group">
                        <label for="novoRole">Novo Tipo de Usu√°rio:</label>
                        <select id="novoRole" name="novoRole" required>
                            <option value="">Selecione o novo tipo</option>
                            <option value="paciente">Paciente</option>
                            <option value="funcionario">Funcion√°rio</option>
                            <option value="admin">Administrador</option>
                        </select>
                    </div>
                    
                    <button type="submit" class="btn-primary">Atualizar Role</button>
                </form>
            </div>

            <!-- Se√ß√£o: Atualizar Autoriza√ß√£o -->
            <div class="section" style="margin-top: 40px;">
                <h2>‚úÖ Autorizar/Desautorizar Usu√°rio</h2>
                <form id="updateAuthForm">
                    <div class="input-group">
                        <label for="emailAuth">Email do Usu√°rio:</label>
                        <input type="email" id="emailAuth" name="emailAuth" required placeholder="Digite o email do usu√°rio">
                    </div>
                    
                    <div class="input-group">
                        <label for="autorizado">Status de Autoriza√ß√£o:</label>
                        <select id="autorizado" name="autorizado" required>
                            <option value="">Selecione o status</option>
                            <option value="sim">‚úÖ Autorizado</option>
                            <option value="nao">‚ùå N√£o Autorizado</option>
                        </select>
                    </div>
                    
                    <button type="submit" class="btn-primary">Atualizar Autoriza√ß√£o</button>
                </form>
            </div>
            
            <!-- Se√ß√£o: Listar Usu√°rios -->
            <div class="section" style="margin-top: 40px;">
                <h2>üë• Lista de Usu√°rios</h2>
                <button onclick="carregarUsuarios()" class="btn-primary" style="margin-bottom: 20px;">
                    Atualizar Lista
                </button>
                
                <div id="listaUsuarios" style="max-height: 400px; overflow-y: auto;">
                    <p>Clique em "Atualizar Lista" para ver os usu√°rios cadastrados</p>
                </div>
            </div>
            
            <div id="loading" class="loading" style="display: none;">
                Processando...
            </div>
            
            <div id="message" class="message"></div>
            
            <div class="info-section" style="margin-top: 30px; padding: 20px; background: #f5f5f5; border-radius: 8px;">
                <h3>Exemplos de uso:</h3>
                <ul>
                    <li><strong>Roles:</strong> administracao@mscartozzoni.com.br ‚Üí Administrador</li>
                    <li><strong>Autoriza√ß√£o:</strong> Novos usu√°rios come√ßam como "N√£o Autorizado"</li>
                    <li><strong>Fluxo:</strong> Cadastro ‚Üí Autorizar ‚Üí Login permitido</li>
                </ul>
            </div>
            
            <p class="text-center" style="margin-top: 20px;">
                <a href="/" class="link">Voltar ao Portal</a>
            </p>
        </div>
    </div>

    <script>
        // Atualizar Role
        document.getElementById('updateRoleForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('email').value;
            const novoRole = document.getElementById('novoRole').value;
            
            await processarRequest('/api/atualizar-role', { email, novoRole }, 'Role');
        });

        // Atualizar Autoriza√ß√£o
        document.getElementById('updateAuthForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('emailAuth').value;
            const autorizado = document.getElementById('autorizado').value;
            
            await processarRequest('/api/atualizar-autorizacao', { email, autorizado }, 'Autoriza√ß√£o');
        });

        // Fun√ß√£o comum para processar requests
        async function processarRequest(url, data, tipo) {
            const loading = document.getElementById('loading');
            const message = document.getElementById('message');
            
            loading.style.display = 'block';
            message.innerHTML = '';
            
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                console.log('üì• Resposta:', result);
                
                if (result.sucesso) {
                    if (tipo === 'Role') {
                        message.innerHTML = `
                            <div class="success">
                                ‚úÖ Tipo de usu√°rio atualizado com sucesso!<br>
                                <strong>Email:</strong> ${result.email}<br>
                                <strong>De:</strong> ${result.roleAnterior} ‚Üí <strong>Para:</strong> ${result.novoRole}
                            </div>
                        `;
                        document.getElementById('updateRoleForm').reset();
                    } else if (tipo === 'Autoriza√ß√£o') {
                        message.innerHTML = `
                            <div class="success">
                                ‚úÖ Autoriza√ß√£o atualizada com sucesso!<br>
                                <strong>Email:</strong> ${result.email}<br>
                                <strong>De:</strong> ${result.autorizacaoAnterior} ‚Üí <strong>Para:</strong> ${result.novaAutorizacao}
                            </div>
                        `;
                        document.getElementById('updateAuthForm').reset();
                    }
                    
                    // Atualizar lista automaticamente
                    setTimeout(() => {
                        carregarUsuarios();
                    }, 1000);
                } else {
                    message.innerHTML = '<div class="error">' + result.erro + '</div>';
                }
            } catch (error) {
                console.error('‚ùå Erro:', error);
                message.innerHTML = '<div class="error">Erro ao atualizar ' + tipo.toLowerCase() + '. Tente novamente.</div>';
            } finally {
                loading.style.display = 'none';
            }
        }
        
        // Fun√ß√£o para carregar lista de usu√°rios
        async function carregarUsuarios() {
            const loading = document.getElementById('loading');
            const listaUsuarios = document.getElementById('listaUsuarios');
            
            loading.style.display = 'block';
            
            try {
                const response = await fetch('/api/listar-usuarios');
                const result = await response.json();
                console.log('üë• Usu√°rios:', result);
                
                if (result.sucesso) {
                    let html = `
                        <div style="margin-bottom: 15px;">
                            <strong>Total de usu√°rios: ${result.total}</strong>
                        </div>
                        <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                            <thead>
                                <tr style="background: #f8f9fa;">
                                    <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Nome</th>
                                    <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Email</th>
                                    <th style="border: 1px solid #ddd; padding: 8px; text-align: center;">Tipo</th>
                                    <th style="border: 1px solid #ddd; padding: 8px; text-align: center;">Autorizado</th>
                                    <th style="border: 1px solid #ddd; padding: 8px; text-align: center;">Cadastro</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    result.usuarios.forEach(user => {
                        const tipoColor = user.tipo === 'admin' ? '#dc3545' : user.tipo === 'funcionario' ? '#ffc107' : '#28a745';
                        const autorizadoIcon = user.autorizado ? '‚úÖ' : '‚ùå';
                        const autorizadoColor = user.autorizado ? '#28a745' : '#dc3545';
                        const dataCadastro = new Date(user.created_at).toLocaleDateString('pt-BR');
                        
                        html += `
                            <tr>
                                <td style="border: 1px solid #ddd; padding: 8px;">${user.nome}</td>
                                <td style="border: 1px solid #ddd; padding: 8px;">${user.email}</td>
                                <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">
                                    <span style="background: ${tipoColor}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px;">
                                        ${user.tipo}
                                    </span>
                                </td>
                                <td style="border: 1px solid #ddd; padding: 8px; text-align: center; color: ${autorizadoColor};">
                                    ${autorizadoIcon}
                                </td>
                                <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">
                                    ${dataCadastro}
                                </td>
                            </tr>
                        `;
                    });
                    
                    html += `
                            </tbody>
                        </table>
                    `;
                    
                    listaUsuarios.innerHTML = html;
                } else {
                    listaUsuarios.innerHTML = '<div class="error">Erro ao carregar usu√°rios: ' + result.erro + '</div>';
                }
            } catch (error) {
                console.error('‚ùå Erro:', error);
                listaUsuarios.innerHTML = '<div class="error">Erro ao carregar usu√°rios. Tente novamente.</div>';
            } finally {
                loading.style.display = 'none';
            }
        }
    </script>
</body>
</html>
