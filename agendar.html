<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agendar Consulta - Portal Dr. Marcio</title>
    <link rel="stylesheet" href="/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .nav-link {
            display: inline-block;
            padding: 8px 12px;
            margin: 2px;
            background: rgba(255,255,255,0.1);
            color: white;
            text-decoration: none;
            border-radius: 5px;
            font-size: 14px;
            transition: all 0.3s ease;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .nav-link:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-1px);
            text-decoration: none;
            color: white;
        }

        .nav-link i {
            margin-right: 5px;
        }

        @media (max-width: 768px) {
            .nav-link {
                font-size: 12px;
                padding: 6px 10px;
            }
        }

        .calendar-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
        }

        .calendar-nav {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .nav-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
        }

        .nav-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 30px;
        }

        .calendar-header-day {
            background: #f8f9fa;
            padding: 15px;
            text-align: center;
            font-weight: bold;
            color: #495057;
        }

        .calendar-day {
            background: white;
            padding: 8px;
            min-height: 120px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            overflow: hidden;
        }

        .calendar-day:hover {
            background: #f8f9fa;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .calendar-day.selected {
            background: #e3f2fd;
            border-color: #2196f3;
        }

        .calendar-day.other-month {
            background: #f5f5f5;
            color: #999;
        }

        .calendar-day.past {
            background: #fafafa;
            color: #ccc;
            cursor: not-allowed;
        }

        .calendar-day.has-appointment {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
        }

        .day-number {
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 16px;
        }

        .day-appointments {
            display: flex;
            flex-direction: column;
            gap: 2px;
            max-height: 80px;
            overflow-y: auto;
        }

        .appointment-item {
            background: rgba(102, 126, 234, 0.1);
            border-left: 3px solid #667eea;
            padding: 4px 6px;
            border-radius: 4px;
            font-size: 10px;
            line-height: 1.2;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .appointment-item:hover {
            background: rgba(102, 126, 234, 0.2);
            transform: translateX(2px);
        }

        .appointment-item.tipo-consulta {
            border-left-color: #28a745;
            background: rgba(40, 167, 69, 0.1);
        }

        .appointment-item.tipo-cirurgia {
            border-left-color: #dc3545;
            background: rgba(220, 53, 69, 0.1);
        }

        .appointment-item.tipo-reuniao {
            border-left-color: #6f42c1;
            background: rgba(111, 66, 193, 0.1);
        }

        .appointment-time {
            font-weight: bold;
            color: #2c3e50;
        }

        .appointment-patient {
            color: #6c757d;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .more-appointments {
            text-align: center;
            font-size: 10px;
            color: #6c757d;
            font-weight: bold;
            margin-top: 2px;
            cursor: pointer;
        }

        .more-appointments:hover {
            color: #667eea;
        }

        @media (max-width: 768px) {
            .calendar-day {
                min-height: 80px;
                padding: 4px;
            }
            
            .day-number {
                font-size: 14px;
                margin-bottom: 4px;
            }
            
            .appointment-item {
                font-size: 9px;
                padding: 2px 4px;
            }
            
            .day-appointments {
                max-height: 50px;
            }
        }

        .time-slots {
            display: none;
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .time-slots.active {
            display: block;
        }

        .time-slots h3 {
            margin-bottom: 20px;
            color: #333;
        }

        .slots-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .time-slot {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            padding: 12px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .time-slot:hover {
            background: #e9ecef;
            border-color: #adb5bd;
        }

        .time-slot.selected {
            background: #007bff;
            color: white;
            border-color: #0056b3;
        }

        .time-slot.unavailable {
            background: #f8d7da;
            color: #721c24;
            border-color: #f5c6cb;
            cursor: not-allowed;
        }

        .appointment-form {
            display: none;
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-top: 20px;
        }

        .appointment-form.active {
            display: block;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .appointment-summary {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .legend {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-color {
            width: 20px;
            height: 15px;
            border-radius: 3px;
        }

        .today {
            background: #e8f5e8 !important;
            border-color: #28a745 !important;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            display: none;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            display: none;
        }

        @media (max-width: 768px) {
            .calendar-header {
                flex-direction: column;
                gap: 20px;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .slots-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                <div>
                    <h1>üè• Portal Dr. Marcio Scartozzoni</h1>
                    <p>Agendamento de Consultas</p>
                </div>
                <div style="text-align: right;">
                    <div class="user-info" style="margin-bottom: 10px;">
                        <span id="userName" style="color: #FFD700; font-weight: bold;">Carregando...</span>
                    </div>
                    <div id="nav-links" style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: flex-end;">
                        <!-- Links ser√£o carregados dinamicamente -->
                    </div>
                    <div style="margin-top: 10px;">
                        <button onclick="logout()" class="btn-secondary" style="background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer;">
                            <i class="fas fa-sign-out-alt"></i> Sair
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <div class="calendar-container">
            <!-- Mensagens de feedback -->
            <div id="successMessage" class="success-message"></div>
            <div id="errorMessage" class="error-message"></div>

            <!-- Cabe√ßalho do calend√°rio -->
            <div class="calendar-header">
                <div>
                    <h2 id="currentMonth">Carregando...</h2>
                    <p>Selecione uma data para agendar sua consulta</p>
                </div>
                <div class="calendar-nav">
                    <button class="nav-btn" onclick="previousMonth()">‚Üê Anterior</button>
                    <button class="nav-btn" onclick="currentMonth()">Hoje</button>
                    <button class="nav-btn" onclick="nextMonth()">Pr√≥ximo ‚Üí</button>
                </div>
            </div>

            <!-- Legenda -->
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: #e8f5e8; border: 2px solid #28a745;"></div>
                    <span>Hoje</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #fff3cd; border-left: 4px solid #ffc107;"></div>
                    <span>Com agendamentos</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #fafafa;"></div>
                    <span>Indispon√≠vel</span>
                </div>
            </div>

            <!-- Grade do calend√°rio -->
            <div class="calendar-grid" id="calendarGrid">
                <div class="loading">üîÑ Carregando calend√°rio...</div>
            </div>

            <!-- Sele√ß√£o de hor√°rios -->
            <div id="timeSlots" class="time-slots">
                <h3>Hor√°rios dispon√≠veis para <span id="selectedDate"></span></h3>
                <div id="slotsGrid" class="slots-grid">
                    <!-- Hor√°rios ser√£o carregados aqui -->
                </div>
                <div class="button-group">
                    <button class="btn-secondary" onclick="clearSelection()">Cancelar</button>
                </div>
            </div>

            <!-- Formul√°rio de agendamento -->
            <div id="appointmentForm" class="appointment-form">
                <h3>Finalizar Agendamento</h3>
                
                <div class="appointment-summary" id="appointmentSummary">
                    <!-- Resumo ser√° preenchido aqui -->
                </div>

                <form id="bookingForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="tipoConsulta">Tipo de Consulta *</label>
                            <select id="tipoConsulta" name="tipoConsulta" required>
                                <option value="">Selecione o tipo</option>
                                <option value="consulta-geral">Consulta Geral</option>
                                <option value="retorno">Retorno</option>
                                <option value="primeira-consulta">Primeira Consulta</option>
                                <option value="urgencia">Urg√™ncia</option>
                                <option value="teleconsulta">Teleconsulta</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="convenio">Conv√™nio</label>
                            <select id="convenio" name="convenio">
                                <option value="particular">Particular</option>
                                <option value="unimed">Unimed</option>
                                <option value="bradesco">Bradesco Sa√∫de</option>
                                <option value="sulamerica">SulAm√©rica</option>
                                <option value="amil">Amil</option>
                                <option value="outros">Outros</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="observacoes">Observa√ß√µes (opcional)</label>
                        <textarea id="observacoes" name="observacoes" rows="3" 
                                  placeholder="Descreva brevemente o motivo da consulta ou observa√ß√µes importantes"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="telefoneContato">Telefone de Contato *</label>
                        <input type="tel" id="telefoneContato" name="telefoneContato" required 
                               placeholder="(11) 99999-9999">
                    </div>

                    <div class="button-group">
                        <button type="button" class="btn-secondary" onclick="backToTimeSlots()">‚Üê Voltar</button>
                        <button type="submit" class="btn-primary">üìÖ Confirmar Agendamento</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        let currentDate = new Date();
        let selectedDate = null;
        let selectedTime = null;
        let userInfo = null;

        // Carregar informa√ß√µes do usu√°rio
        async function loadUserInfo() {
            try {
                // Usar o mesmo sistema de autentica√ß√£o do dashboard
                const storedUserInfo = localStorage.getItem('userInfo');
                if (!storedUserInfo) {
                    window.location.href = '/login.html';
                    return;
                }

                userInfo = JSON.parse(storedUserInfo);
                
                // Atualizar interface com informa√ß√µes do usu√°rio
                document.getElementById('userName').textContent = userInfo.nome || 'Usu√°rio';
                
                // Configurar navega√ß√£o baseada no tipo de usu√°rio (igual ao dashboard)
                const navLinks = document.getElementById('nav-links');
                if (navLinks) {
                    if (userInfo.tipo === 'admin') {
                        navLinks.innerHTML = `
                            <a href="/dashboard.html" class="nav-link"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
                            <a href="/gestao.html" class="nav-link"><i class="fas fa-chart-bar"></i> Gest√£o</a>
                            <a href="/admin.html" class="nav-link"><i class="fas fa-users-cog"></i> Usu√°rios</a>
                            <a href="/" class="nav-link"><i class="fas fa-home"></i> Portal</a>
                        `;
                    } else if (userInfo.tipo === 'funcionario') {
                        navLinks.innerHTML = `
                            <a href="/dashboard.html" class="nav-link"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
                            <a href="/gestao.html" class="nav-link"><i class="fas fa-chart-bar"></i> Gest√£o</a>
                            <a href="/" class="nav-link"><i class="fas fa-home"></i> Portal</a>
                        `;
                    } else {
                        navLinks.innerHTML = `
                            <a href="/dashboard.html" class="nav-link"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
                            <a href="/" class="nav-link"><i class="fas fa-home"></i> Portal</a>
                        `;
                    }
                }
                
                // Verificar se √© funcion√°rio n√£o autorizado
                if (userInfo.tipo === 'funcionario' && !userInfo.autorizado) {
                    alert('‚è≥ Aguardando aprova√ß√£o do administrador.\n\nSeu acesso ainda est√° pendente de autoriza√ß√£o.');
                    window.location.href = '/login.html';
                    return;
                }
                
                console.log('Usu√°rio carregado:', userInfo);
                
            } catch (error) {
                console.error('Erro ao carregar usu√°rio:', error);
                localStorage.removeItem('userInfo');
                localStorage.removeItem('authToken');
                window.location.href = '/login.html';
            }
        }

        // Inicializar calend√°rio
        function initCalendar() {
            generateCalendar();
            loadAppointments();
        }

        // Gerar grade do calend√°rio
        function generateCalendar() {
            const grid = document.getElementById('calendarGrid');
            const monthHeader = document.getElementById('currentMonth');
            
            // Atualizar cabe√ßalho
            monthHeader.textContent = currentDate.toLocaleDateString('pt-BR', { 
                month: 'long', 
                year: 'numeric' 
            }).replace(/^\w/, c => c.toUpperCase());

            // Limpar grade
            grid.innerHTML = '';

            // Cabe√ßalhos dos dias
            const weekDays = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];
            weekDays.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'calendar-header-day';
                dayHeader.textContent = day;
                grid.appendChild(dayHeader);
            });

            // Primeiro dia do m√™s
            const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
            const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());

            // Gerar dias
            const today = new Date();
            for (let i = 0; i < 42; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                
                // Classes condicionais
                if (date.getMonth() !== currentDate.getMonth()) {
                    dayElement.classList.add('other-month');
                }
                if (date < today.setHours(0,0,0,0)) {
                    dayElement.classList.add('past');
                }
                if (date.toDateString() === new Date().toDateString()) {
                    dayElement.classList.add('today');
                }

                dayElement.innerHTML = `
                    <div class="day-number">${date.getDate()}</div>
                    <div class="day-appointments" id="appointments-${date.toISOString().split('T')[0]}">
                        <!-- Agendamentos ser√£o carregados aqui -->
                    </div>
                `;

                // Event listener para sele√ß√£o
                if (!dayElement.classList.contains('past') && !dayElement.classList.contains('other-month')) {
                    dayElement.addEventListener('click', () => selectDate(date));
                }

                grid.appendChild(dayElement);
            }
        }

        // Selecionar data
        function selectDate(date) {
            // Remover sele√ß√£o anterior
            document.querySelectorAll('.calendar-day').forEach(day => {
                day.classList.remove('selected');
            });

            // Adicionar sele√ß√£o
            const dayElement = event.currentTarget;
            dayElement.classList.add('selected');

            selectedDate = date;
            document.getElementById('selectedDate').textContent = 
                date.toLocaleDateString('pt-BR', { 
                    weekday: 'long', 
                    day: 'numeric', 
                    month: 'long', 
                    year: 'numeric' 
                });

            // Mostrar hor√°rios
            loadTimeSlots(date);
            document.getElementById('timeSlots').classList.add('active');
            document.getElementById('appointmentForm').classList.remove('active');
        }

        // Carregar hor√°rios dispon√≠veis
        async function loadTimeSlots(date) {
            const slotsGrid = document.getElementById('slotsGrid');
            slotsGrid.innerHTML = '<div class="loading">üîÑ Carregando hor√°rios...</div>';

            try {
                const dateStr = date.toISOString().split('T')[0];
                const response = await fetch(`/api/available-slots?date=${dateStr}`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });

                const slots = await response.json();
                
                if (response.ok) {
                    renderTimeSlots(slots);
                } else {
                    throw new Error(slots.message || 'Erro ao carregar hor√°rios');
                }
            } catch (error) {
                console.error('Erro ao carregar hor√°rios:', error);
                slotsGrid.innerHTML = '<div class="error">‚ùå Erro ao carregar hor√°rios</div>';
            }
        }

        // Renderizar hor√°rios
        function renderTimeSlots(slots) {
            const slotsGrid = document.getElementById('slotsGrid');
            
            if (slots.length === 0) {
                slotsGrid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: #666;">Nenhum hor√°rio dispon√≠vel para esta data</div>';
                return;
            }

            slotsGrid.innerHTML = '';
            
            slots.forEach(slot => {
                const slotElement = document.createElement('div');
                slotElement.className = 'time-slot';
                slotElement.textContent = slot.time;
                
                if (slot.available) {
                    slotElement.addEventListener('click', () => selectTimeSlot(slot.time, slotElement));
                } else {
                    slotElement.classList.add('unavailable');
                    slotElement.title = 'Hor√°rio n√£o dispon√≠vel';
                }
                
                slotsGrid.appendChild(slotElement);
            });
        }

        // Selecionar hor√°rio
        function selectTimeSlot(time, element) {
            // Remover sele√ß√£o anterior
            document.querySelectorAll('.time-slot').forEach(slot => {
                slot.classList.remove('selected');
            });

            // Adicionar sele√ß√£o
            element.classList.add('selected');
            selectedTime = time;

            // Mostrar formul√°rio
            showAppointmentForm();
        }

        // Mostrar formul√°rio de agendamento
        function showAppointmentForm() {
            document.getElementById('timeSlots').classList.remove('active');
            document.getElementById('appointmentForm').classList.add('active');

            // Preencher resumo
            const summary = document.getElementById('appointmentSummary');
            summary.innerHTML = `
                <h4>üìÖ Resumo do Agendamento</h4>
                <p><strong>Data:</strong> ${selectedDate.toLocaleDateString('pt-BR', { 
                    weekday: 'long', 
                    day: 'numeric', 
                    month: 'long', 
                    year: 'numeric' 
                })}</p>
                <p><strong>Hor√°rio:</strong> ${selectedTime}</p>
                <p><strong>Paciente:</strong> ${userInfo.nome}</p>
            `;
        }

        // Voltar para sele√ß√£o de hor√°rios
        function backToTimeSlots() {
            document.getElementById('appointmentForm').classList.remove('active');
            document.getElementById('timeSlots').classList.add('active');
        }

        // Limpar sele√ß√£o
        function clearSelection() {
            document.querySelectorAll('.calendar-day').forEach(day => {
                day.classList.remove('selected');
            });
            document.getElementById('timeSlots').classList.remove('active');
            document.getElementById('appointmentForm').classList.remove('active');
            selectedDate = null;
            selectedTime = null;
        }

        // Navega√ß√£o do calend√°rio
        function previousMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            generateCalendar();
            loadAppointments();
        }

        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            generateCalendar();
            loadAppointments();
        }

        function currentMonth() {
            currentDate = new Date();
            generateCalendar();
            loadAppointments();
        }

        // Carregar agendamentos existentes
        async function loadAppointments() {
            try {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth() + 1;
                
                const response = await fetch(`/api/appointments?year=${year}&month=${month}`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });

                if (response.ok) {
                    const appointments = await response.json();
                    displayAppointments(appointments);
                } else {
                    // Dados de exemplo para demonstra√ß√£o
                    const exampleAppointments = generateExampleAppointments();
                    displayAppointments(exampleAppointments);
                }
            } catch (error) {
                console.error('Erro ao carregar agendamentos:', error);
                // Dados de exemplo para demonstra√ß√£o
                const exampleAppointments = generateExampleAppointments();
                displayAppointments(exampleAppointments);
            }
        }

        // Gerar dados de exemplo
        function generateExampleAppointments() {
            const today = new Date();
            const appointments = [];
            
            // Pr√≥ximos dias com agendamentos de exemplo
            for (let i = 1; i <= 10; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() + i);
                
                if (Math.random() > 0.5) { // 50% de chance de ter agendamento
                    const numAppointments = Math.floor(Math.random() * 3) + 1; // 1-3 agendamentos
                    
                    for (let j = 0; j < numAppointments; j++) {
                        const tipos = ['consulta', 'cirurgia', 'reuniao', 'retorno', 'avaliacao'];
                        const pacientes = ['Maria Silva', 'Jo√£o Santos', 'Ana Costa', 'Carlos Lima', 'Lucia Oliveira'];
                        const horas = ['08:00', '09:30', '10:00', '14:00', '15:30', '16:00'];
                        
                        appointments.push({
                            id: Date.now() + i + j,
                            data_consulta: date.toISOString().split('T')[0],
                            hora_consulta: horas[Math.floor(Math.random() * horas.length)],
                            tipo: tipos[Math.floor(Math.random() * tipos.length)],
                            paciente_nome: pacientes[Math.floor(Math.random() * pacientes.length)],
                            status: 'confirmado'
                        });
                    }
                }
            }
            
            return appointments;
        }

        // Exibir agendamentos no calend√°rio
        function displayAppointments(appointments) {
            // Agrupar por data
            const appointmentsByDate = {};
            
            appointments.forEach(appointment => {
                const date = appointment.data_consulta;
                if (!appointmentsByDate[date]) {
                    appointmentsByDate[date] = [];
                }
                appointmentsByDate[date].push(appointment);
            });
            
            // Exibir em cada dia
            Object.keys(appointmentsByDate).forEach(date => {
                const dayAppointments = appointmentsByDate[date];
                const appointmentElement = document.getElementById(`appointments-${date}`);
                
                if (appointmentElement) {
                    appointmentElement.innerHTML = '';
                    
                    // Ordenar por hor√°rio
                    dayAppointments.sort((a, b) => a.hora_consulta.localeCompare(b.hora_consulta));
                    
                    // Mostrar at√© 3 agendamentos
                    const visibleAppointments = dayAppointments.slice(0, 3);
                    const hiddenCount = dayAppointments.length - visibleAppointments.length;
                    
                    visibleAppointments.forEach(appointment => {
                        const appointmentDiv = document.createElement('div');
                        appointmentDiv.className = `appointment-item tipo-${appointment.tipo}`;
                        appointmentDiv.onclick = (e) => {
                            e.stopPropagation();
                            abrirDetalhesAgendamento(appointment.id);
                        };
                        
                        appointmentDiv.innerHTML = `
                            <div class="appointment-time">${appointment.hora_consulta}</div>
                            <div class="appointment-patient">${appointment.paciente_nome}</div>
                        `;
                        
                        appointmentElement.appendChild(appointmentDiv);
                    });
                    
                    // Mostrar "mais X" se houver agendamentos ocultos
                    if (hiddenCount > 0) {
                        const moreDiv = document.createElement('div');
                        moreDiv.className = 'more-appointments';
                        moreDiv.textContent = `+${hiddenCount} mais`;
                        moreDiv.onclick = (e) => {
                            e.stopPropagation();
                            mostrarTodosAgendamentos(date);
                        };
                        appointmentElement.appendChild(moreDiv);
                    }
                    
                    // Marcar dia como tendo agendamentos
                    const dayElement = appointmentElement.closest('.calendar-day');
                    if (dayElement) {
                        dayElement.classList.add('has-appointment');
                    }
                }
            });
        }

        // Abrir detalhes do agendamento
        function abrirDetalhesAgendamento(agendamentoId) {
            window.open(`/agendamento-detalhes.html?id=${agendamentoId}`, '_blank');
        }

        // Mostrar todos os agendamentos do dia
        function mostrarTodosAgendamentos(date) {
            // TODO: Implementar modal ou p√°gina para mostrar todos os agendamentos do dia
            alert(`Ver todos os agendamentos de ${new Date(date).toLocaleDateString('pt-BR')}`);
        }

        // Submeter formul√°rio de agendamento
        document.getElementById('bookingForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData(e.target);
            const appointmentData = {
                data_consulta: `${selectedDate.toISOString().split('T')[0]} ${selectedTime}`,
                tipo_consulta: formData.get('tipoConsulta'),
                convenio: formData.get('convenio'),
                observacoes: formData.get('observacoes'),
                telefone_contato: formData.get('telefoneContato')
            };

            try {
                const response = await fetch('/api/appointments', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(appointmentData)
                });

                const result = await response.json();

                if (response.ok) {
                    showMessage('success', '‚úÖ Consulta agendada com sucesso! Voc√™ receber√° uma confirma√ß√£o por email.');
                    clearSelection();
                    generateCalendar();
                    loadAppointments();
                    e.target.reset();
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error('Erro ao agendar:', error);
                showMessage('error', '‚ùå Erro ao agendar consulta: ' + error.message);
            }
        });

        // Mostrar mensagens
        function showMessage(type, text) {
            const messageElement = document.getElementById(type === 'success' ? 'successMessage' : 'errorMessage');
            messageElement.textContent = text;
            messageElement.style.display = 'block';
            
            setTimeout(() => {
                messageElement.style.display = 'none';
            }, 5000);
        }

        // Fun√ß√£o de logout (integrada com o dashboard)
        function logout() {
            if (confirm('Tem certeza que deseja sair?')) {
                localStorage.removeItem('userInfo');
                localStorage.removeItem('authToken');
                localStorage.removeItem('token');
                window.location.href = '/login.html';
            }
        }

        // Formata√ß√£o de telefone
        document.getElementById('telefoneContato').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            value = value.replace(/(\d{2})(\d)/, '($1) $2');
            value = value.replace(/(\d{5})(\d)/, '$1-$2');
            e.target.value = value;
        });

        // Inicializar quando a p√°gina carregar
        document.addEventListener('DOMContentLoaded', async () => {
            await loadUserInfo();
            initCalendar();
        });
    </script>
</body>
</html>
