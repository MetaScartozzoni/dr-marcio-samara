<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciar Usu√°rios - Portal Dr. Marcio</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .admin-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 25px;
        }
        
        .admin-header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .admin-header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }
        
        .admin-header p {
            font-size: 18px;
            opacity: 0.9;
        }
        
        .admin-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }
        
        .admin-section {
            background: white;
            padding: 35px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            border: 1px solid #e0e0e0;
            transition: transform 0.3s ease;
        }
        
        .admin-section:hover {
            transform: translateY(-5px);
        }
        
        .admin-section h2 {
            margin-top: 0;
            margin-bottom: 25px;
            color: #1e3c72;
            font-size: 22px;
            font-weight: 700;
            border-bottom: 3px solid #1e3c72;
            padding-bottom: 15px;
        }
        
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-col {
            flex: 1;
        }
        
        .form-col label {
            display: block;
            margin-bottom: 8px;
            font-weight: 700;
            color: #1e3c72;
            font-size: 16px;
        }
        
        .form-col input,
        .form-col select {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .form-col input:focus,
        .form-col select:focus {
            border-color: #1e3c72;
            outline: none;
        }
        
        .btn-admin {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.3s;
        }
        
        .btn-admin:hover {
            transform: translateY(-2px);
        }
        
        .users-section {
            background: white;
            padding: 35px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            border: 1px solid #e0e0e0;
        }
        
        .users-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 16px;
            margin-top: 20px;
        }
        
        .users-table th {
            background: #1e3c72;
            color: white;
            padding: 16px 12px;
            border: 1px solid #ddd;
            text-align: left;
            font-weight: 700;
            font-size: 16px;
        }
        
        .users-table td {
            padding: 14px 12px;
            border: 1px solid #ddd;
            vertical-align: middle;
            font-size: 15px;
        }
        
        .users-table tr:nth-child(even) {
            background: #f9f9f9;
        }
        
        .status-badge {
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 14px;
            font-weight: 700;
            color: white;
            display: inline-block;
        }
        
        .badge-admin { background: #dc3545; }
        .badge-funcionario { background: #ffc107; color: #333; }
        .badge-paciente { background: #28a745; }
        .badge-pending { background: #fd7e14; }
        
        .pending-card {
            background: #fff8e1;
            border: 2px solid #ff9800;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }
        
        .pending-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 152, 0, 0.3);
        }
        
        .pending-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }
        
        .pending-info h4 {
            color: #e65100;
            margin: 0 0 12px 0;
            font-size: 20px;
        }
        
        .pending-info p {
            color: #666;
            margin: 0 0 8px 0;
            font-size: 15px;
            line-height: 1.6;
        }
        
        .pending-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn-approve {
            background: #4caf50;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background 0.3s;
        }
        
        .btn-approve:hover {
            background: #45a049;
        }
        
        .approval-form {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        
        .approval-form select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            margin-bottom: 10px;
        }
        
        .no-pending {
            text-align: center;
            padding: 30px;
            color: #666;
            font-size: 16px;
        }
        
        .message-area {
            margin: 25px 0;
            min-height: 60px;
        }
        
        .loading {
            text-align: center;
            padding: 25px;
            color: #1e3c72;
            font-size: 18px;
            font-weight: 600;
        }
        
        /* Responsivo para mobile */
        @media (max-width: 768px) {
            .admin-grid {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                flex-direction: column;
                gap: 15px;
            }
            
            .users-table {
                font-size: 14px;
            }
            
            .users-table th,
            .users-table td {
                padding: 10px 6px;
            }
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <div class="admin-header">
            <h1>üè• Portal Administrativo - Dr. Marcio</h1>
            <p>Sistema de gerenciamento de usu√°rios e autoriza√ß√µes</p>
            <div style="margin-top: 15px;">
                <button onclick="atualizarDadosManual()" class="btn-refresh" style="background: #17a2b8; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                    üîÑ Atualizar Dados
                </button>
                <span id="lastUpdate" style="margin-left: 15px; color: rgba(255,255,255,0.8); font-size: 14px;"></span>
            </div>
        </div>
        
        <!-- Se√ß√µes lado a lado: Perfil e Status -->
        <div class="admin-grid">
            <!-- Se√ß√£o: Usu√°rios Pendentes -->
            <div class="admin-section" style="grid-column: 1 / -1;">
                <h2>‚è≥ Usu√°rios Aguardando Aprova√ß√£o</h2>
                <div id="pending-users-area">
                    <div class="loading">Carregando usu√°rios pendentes...</div>
                </div>
            </div>
            
            <!-- Se√ß√£o: Atualizar Role -->
            <div class="admin-section">
                <h2>üîß Atualizar Tipo de Usu√°rio</h2>
                <form id="updateRoleForm">
                    <div class="form-row">
                        <div class="form-col">
                            <label for="email">Email do Usu√°rio:</label>
                            <input type="email" id="email" name="email" required placeholder="Digite o email">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <label for="novoRole">Novo Tipo:</label>
                            <select id="novoRole" name="novoRole" required>
                                <option value="">Selecione o tipo</option>
                                <option value="paciente">üë§ Paciente</option>
                                <option value="funcionario">üë®‚Äç‚öïÔ∏è Funcion√°rio</option>
                                <option value="admin">üëë Administrador</option>
                            </select>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn-admin">Atualizar Tipo</button>
                </form>
            </div>

            <!-- Se√ß√£o: Atualizar Autoriza√ß√£o -->
            <div class="admin-section">
                <h2>‚úÖ Gerenciar Autoriza√ß√£o</h2>
                <form id="updateAuthForm">
                    <div class="form-row">
                        <div class="form-col">
                            <label for="emailAuth">Email do Usu√°rio:</label>
                            <input type="email" id="emailAuth" name="emailAuth" required placeholder="Digite o email">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <label for="autorizado">Status:</label>
                            <select id="autorizado" name="autorizado" required>
                                <option value="">Selecione o status</option>
                                <option value="sim">‚úÖ Autorizado</option>
                                <option value="nao">‚ùå Bloqueado</option>
                            </select>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn-admin">Atualizar Status</button>
                </form>
            </div>
        </div>
        
        <!-- √Årea de mensagens -->
        <div class="message-area">
            <div id="loading" class="loading" style="display: none;">
                ‚è≥ Processando...
            </div>
            <div id="message"></div>
        </div>
        
        <!-- Se√ß√£o: Lista de Usu√°rios (embaixo, largura total) -->
        <div class="users-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0; border: none; padding: 0;">üë• Usu√°rios Cadastrados</h2>
                <button onclick="carregarUsuarios()" class="btn-admin" style="width: auto; padding: 8px 16px;">
                    üîÑ Atualizar Lista
                </button>
            </div>
            
            <div id="listaUsuarios">
                <p style="text-align: center; color: #666; padding: 40px;">
                    üìã Clique em "Atualizar Lista" para carregar os usu√°rios
                </p>
            </div>
        </div>
        
        <div style="text-align: center; margin-top: 30px; padding: 20px;">
            <a href="/dashboard.html" class="btn-admin" style="width: auto; padding: 10px 20px; text-decoration: none; display: inline-block;">
                üè† Voltar ao Dashboard
            </a>
        </div>
    </div>

    <script>
        // Atualizar Role
        document.getElementById('updateRoleForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('email').value;
            const novoRole = document.getElementById('novoRole').value;
            
            await processarRequest('/api/atualizar-role', { email, novoRole }, 'Role');
        });

        // Atualizar Autoriza√ß√£o
        document.getElementById('updateAuthForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('emailAuth').value;
            const autorizado = document.getElementById('autorizado').value;
            
            await processarRequest('/api/atualizar-autorizacao', { email, autorizado }, 'Autoriza√ß√£o');
        });

        // Fun√ß√£o comum para processar requests
        async function processarRequest(url, data, tipo) {
            const loading = document.getElementById('loading');
            const message = document.getElementById('message');
            
            loading.style.display = 'block';
            message.innerHTML = '';
            
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                console.log('üì• Resposta:', result);
                
                if (result.sucesso) {
                    if (tipo === 'Role') {
                        message.innerHTML = `
                            <div class="success">
                                ‚úÖ Tipo de usu√°rio atualizado com sucesso!<br>
                                <strong>Email:</strong> ${result.email}<br>
                                <strong>De:</strong> ${result.roleAnterior} ‚Üí <strong>Para:</strong> ${result.novoRole}
                            </div>
                        `;
                        document.getElementById('updateRoleForm').reset();
                    } else if (tipo === 'Autoriza√ß√£o') {
                        message.innerHTML = `
                            <div class="success">
                                ‚úÖ Autoriza√ß√£o atualizada com sucesso!<br>
                                <strong>Email:</strong> ${result.email}<br>
                                <strong>De:</strong> ${result.autorizacaoAnterior} ‚Üí <strong>Para:</strong> ${result.novaAutorizacao}
                            </div>
                        `;
                        document.getElementById('updateAuthForm').reset();
                    }
                    
                    // Atualizar lista automaticamente
                    setTimeout(() => {
                        carregarUsuarios();
                    }, 1000);
                } else {
                    message.innerHTML = '<div class="error">' + result.erro + '</div>';
                }
            } catch (error) {
                console.error('‚ùå Erro:', error);
                message.innerHTML = '<div class="error">Erro ao atualizar ' + tipo.toLowerCase() + '. Tente novamente.</div>';
            } finally {
                loading.style.display = 'none';
            }
        }
        
        // Fun√ß√£o para carregar usu√°rios pendentes
        async function carregarUsuariosPendentes() {
            const container = document.getElementById('pending-users-area');
            
            try {
                const response = await fetch('/api/usuarios-pendentes');
                const result = await response.json();
                
                if (result.success) {
                    if (result.usuarios.length === 0) {
                        container.innerHTML = `
                            <div class="no-pending">
                                ‚úÖ N√£o h√° usu√°rios aguardando aprova√ß√£o
                            </div>
                        `;
                    } else {
                        let html = '';
                        result.usuarios.forEach(user => {
                            const statusInfo = user.autorizado ? 
                                (user.status || 'ativo') : 
                                (user.status || 'bloqueado');
                            
                            const statusClass = statusInfo === 'pending' ? 'badge-pending' : 
                                               statusInfo === 'bloqueado' ? 'badge-admin' : 'badge-funcionario';
                            
                            html += `
                                <div class="pending-card" id="pending-${user.id}">
                                    <div class="pending-header">
                                        <div class="pending-info">
                                            <h4>üë§ ${user.nome}</h4>
                                            <p>üìß ${user.email} ${user.telefone ? 'üì± ' + user.telefone : ''}</p>
                                            <p>üìÖ Cadastrado: ${new Date(user.created_at).toLocaleDateString('pt-BR')}</p>
                                            <p><strong>Tipo atual:</strong> <span class="status-badge ${user.tipo === 'admin' ? 'badge-admin' : user.tipo === 'funcionario' ? 'badge-funcionario' : 'badge-paciente'}">${user.tipo}</span></p>
                                            <p><strong>Status:</strong> <span class="status-badge ${statusClass}">${statusInfo}</span></p>
                                            <p><strong>Autorizado:</strong> ${user.autorizado ? '‚úÖ Sim' : '‚ùå N√£o'}</p>
                                        </div>
                                        <div class="pending-actions">
                                            <button class="btn-approve" onclick="mostrarFormAprovacao(${user.id})">
                                                ‚úÖ Aprovar
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div id="approval-form-${user.id}" style="display: none;" class="approval-form">
                                        <label for="tipo-${user.id}">Tipo de usu√°rio:</label>
                                        <select id="tipo-${user.id}">
                                            <option value="paciente" ${user.tipo === 'paciente' ? 'selected' : ''}>üë§ Paciente</option>
                                            <option value="funcionario" ${user.tipo === 'funcionario' ? 'selected' : ''}>üë®‚Äç‚öïÔ∏è Funcion√°rio</option>
                                        </select>
                                        <div style="display: flex; gap: 10px; margin-top: 10px;">
                                            <button class="btn-approve" onclick="aprovarUsuario(${user.id}, '${user.nome}', '${user.email}')">
                                                ‚úÖ Confirmar Aprova√ß√£o
                                            </button>
                                            <button class="btn btn-secondary" onclick="cancelarAprovacao(${user.id})">
                                                ‚ùå Cancelar
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                        container.innerHTML = html;
                    }
                } else {
                    container.innerHTML = `
                        <div class="error">
                            ‚ùå Erro ao carregar usu√°rios pendentes: ${result.message}
                        </div>
                    `;
                }
            } catch (error) {
                console.error('‚ùå Erro ao carregar usu√°rios pendentes:', error);
                container.innerHTML = `
                    <div class="error">
                        ‚ùå Erro de conex√£o. Tente novamente.
                    </div>
                `;
            }
        }
        
        // Mostrar formul√°rio de aprova√ß√£o
        function mostrarFormAprovacao(userId) {
            const form = document.getElementById(`approval-form-${userId}`);
            form.style.display = form.style.display === 'none' ? 'block' : 'none';
        }
        
        // Cancelar aprova√ß√£o
        function cancelarAprovacao(userId) {
            document.getElementById(`approval-form-${userId}`).style.display = 'none';
        }
        
        // Aprovar usu√°rio - Abrir modal avan√ßado
        async function aprovarUsuario(userId, nome, email) {
            // Armazenar dados do usu√°rio atual
            window.currentApprovalUser = { userId, nome, email };
            
            // Preencher informa√ß√µes no modal
            document.getElementById('modal-nome').textContent = nome;
            document.getElementById('modal-email').textContent = email;
            document.getElementById('modal-data').textContent = new Date().toLocaleDateString('pt-BR');
            
            // Resetar formul√°rio
            document.getElementById('modal-tipo-usuario').value = '';
            document.getElementById('modal-perfil-funcionario').value = '';
            document.getElementById('modal-observacoes').value = '';
            document.getElementById('perfil-funcionario-section').style.display = 'none';
            document.getElementById('permissoes-section').style.display = 'none';
            
            // Mostrar modal
            document.getElementById('modalAprovacao').style.display = 'flex';
        }

        // Fechar modal de aprova√ß√£o
        function fecharModalAprovacao() {
            document.getElementById('modalAprovacao').style.display = 'none';
            window.currentApprovalUser = null;
        }

        // Atualizar permiss√µes baseado no tipo
        function atualizarPermissoes() {
            const tipo = document.getElementById('modal-tipo-usuario').value;
            const perfilSection = document.getElementById('perfil-funcionario-section');
            const permissoesSection = document.getElementById('permissoes-section');
            
            if (tipo === 'funcionario') {
                perfilSection.style.display = 'block';
                permissoesSection.style.display = 'block';
            } else if (tipo === 'paciente') {
                perfilSection.style.display = 'none';
                permissoesSection.style.display = 'block';
                // Configurar permiss√µes b√°sicas para paciente
                configurarPermissoesPaciente();
            } else {
                perfilSection.style.display = 'none';
                permissoesSection.style.display = 'none';
            }
        }

        // Configurar permiss√µes para paciente
        function configurarPermissoesPaciente() {
            // Desmarcar todas as permiss√µes
            document.querySelectorAll('#permissoes-section input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
                checkbox.disabled = false;
            });
            
            // Marcar apenas permiss√µes b√°sicas para paciente
            const permissoesPaciente = [
                'perm-dashboard', 'perm-perfil', 'perm-agendamento'
            ];
            
            permissoesPaciente.forEach(permId => {
                const checkbox = document.getElementById(permId);
                if (checkbox) {
                    checkbox.checked = true;
                    if (permId === 'perm-dashboard' || permId === 'perm-perfil') {
                        checkbox.disabled = true; // Obrigat√≥rias
                    }
                }
            });
        }

        // Atualizar permiss√µes por perfil de funcion√°rio
        function atualizarPermissoesPorPerfil() {
            const perfil = document.getElementById('modal-perfil-funcionario').value;
            
            // Resetar todas as permiss√µes
            document.querySelectorAll('#permissoes-section input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
                checkbox.disabled = false;
            });
            
            // Permiss√µes b√°sicas sempre marcadas
            document.getElementById('perm-dashboard').checked = true;
            document.getElementById('perm-dashboard').disabled = true;
            document.getElementById('perm-perfil').checked = true;
            document.getElementById('perm-perfil').disabled = true;
            
            // Configurar por perfil
            if (perfil === 'administrativo') {
                const permissoesAdmin = [
                    'perm-agendamento', 'perm-gestao-pacientes', 'perm-criar-agendamento',
                    'perm-editar-agendamento', 'perm-cancelar-agendamento', 'perm-relatorios',
                    'perm-financeiro', 'perm-usuarios', 'perm-sistema'
                ];
                permissoesAdmin.forEach(permId => {
                    const checkbox = document.getElementById(permId);
                    if (checkbox) checkbox.checked = true;
                });
            } else if (perfil === 'atendimento') {
                const permissoesAtendimento = [
                    'perm-agendamento', 'perm-gestao-pacientes', 'perm-criar-agendamento',
                    'perm-editar-agendamento', 'perm-cancelar-agendamento'
                ];
                permissoesAtendimento.forEach(permId => {
                    const checkbox = document.getElementById(permId);
                    if (checkbox) checkbox.checked = true;
                });
            } else if (perfil === 'medico') {
                const permissoesMedico = [
                    'perm-agendamento', 'perm-gestao-pacientes', 'perm-criar-agendamento',
                    'perm-editar-agendamento', 'perm-quadro-evolutivo', 'perm-caderno-digital',
                    'perm-prontuarios', 'perm-prescricoes', 'perm-laudos', 'perm-relatorios'
                ];
                permissoesMedico.forEach(permId => {
                    const checkbox = document.getElementById(permId);
                    if (checkbox) checkbox.checked = true;
                });
            }
        }

        // Confirmar aprova√ß√£o
        async function confirmarAprovacao() {
            const user = window.currentApprovalUser;
            if (!user) return;
            
            const tipo = document.getElementById('modal-tipo-usuario').value;
            const perfil = document.getElementById('modal-perfil-funcionario').value;
            const observacoes = document.getElementById('modal-observacoes').value;
            
            if (!tipo) {
                alert('‚ùå Selecione o tipo de usu√°rio');
                return;
            }
            
            if (tipo === 'funcionario' && !perfil) {
                alert('‚ùå Selecione o perfil do funcion√°rio');
                return;
            }
            
            // Coletar permiss√µes selecionadas
            const permissoes = [];
            document.querySelectorAll('#permissoes-section input[type="checkbox"]:checked').forEach(checkbox => {
                permissoes.push(checkbox.id.replace('perm-', ''));
            });
            
            const dadosAprovacao = {
                userId: user.userId,
                tipo: tipo,
                perfil: perfil || null,
                permissoes: permissoes,
                observacoes: observacoes,
                autorizado: true
            };
            
            // Confirmar com o usu√°rio
            const perfilTexto = perfil ? ` - ${perfil}` : '';
            if (!confirm(`Confirmar aprova√ß√£o de "${user.nome}" como ${tipo}${perfilTexto}?\\n\\nPermiss√µes: ${permissoes.length} selecionadas\\n\\n‚úÖ O usu√°rio ser√° automaticamente ATIVADO`)) {
                return;
            }
            
            try {
                const response = await fetch('/api/aprovar-usuario-avancado', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(dadosAprovacao)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Fechar modal
                    fecharModalAprovacao();
                    
                    // Remover card da lista
                    const cardElement = document.getElementById(`pending-${user.userId}`);
                    if (cardElement) {
                        cardElement.style.transition = 'all 0.3s ease';
                        cardElement.style.opacity = '0';
                        cardElement.style.transform = 'translateX(-100%)';
                        
                        setTimeout(() => {
                            cardElement.remove();
                        }, 300);
                    }
                    
                    // Mostrar mensagem de sucesso
                    const message = document.getElementById('message');
                    message.innerHTML = `
                        <div class="success">
                            ‚úÖ Usu√°rio aprovado e configurado com sucesso!<br>
                            <strong>Nome:</strong> ${user.nome}<br>
                            <strong>Email:</strong> ${user.email}<br>
                            <strong>Tipo:</strong> ${tipo}${perfilTexto}<br>
                            <strong>Permiss√µes:</strong> ${permissoes.length} configuradas<br>
                            <strong>Status:</strong> ‚úÖ Ativo
                        </div>
                    `;
                    
                    // Recarregar listas
                    setTimeout(async () => {
                        await carregarUsuarios();
                    }, 500);
                    
                    console.log(`‚úÖ Usu√°rio ${user.nome} aprovado como ${tipo}${perfilTexto} com ${permissoes.length} permiss√µes`);
                    
                } else {
                    alert('‚ùå Erro ao aprovar usu√°rio: ' + result.message);
                }
            } catch (error) {
                console.error('‚ùå Erro ao aprovar usu√°rio:', error);
                alert('‚ùå Erro de conex√£o. Tentando com API legacy...');
                
                // Fallback para API antiga
                await aprovarUsuarioLegacy(user.userId, user.nome, user.email, tipo);
            }
        }

        // Fun√ß√£o legacy para compatibilidade
        async function aprovarUsuarioLegacy(userId, nome, email, tipo) {
            try {
                const response = await fetch('/api/aprovar-usuario', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: userId,
                        tipo: tipo,
                        autorizado: true
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    fecharModalAprovacao();
                    
                    const cardElement = document.getElementById(`pending-${userId}`);
                    if (cardElement) {
                        cardElement.style.transition = 'all 0.3s ease';
                        cardElement.style.opacity = '0';
                        cardElement.style.transform = 'translateX(-100%)';
                        
                        setTimeout(() => {
                            cardElement.remove();
                        }, 300);
                    }
                    
                    const message = document.getElementById('message');
                    message.innerHTML = `
                        <div class="success">
                            ‚úÖ Usu√°rio aprovado com sucesso (modo compatibilidade)!<br>
                            <strong>Nome:</strong> ${nome}<br>
                            <strong>Email:</strong> ${email}<br>
                            <strong>Tipo:</strong> ${tipo}<br>
                            <strong>Status:</strong> ‚úÖ Ativo
                        </div>
                    `;
                    
                    setTimeout(async () => {
                        await carregarUsuarios();
                    }, 500);
                    
                } else {
                    alert('‚ùå Erro ao aprovar usu√°rio: ' + result.message);
                }
            } catch (error) {
                console.error('‚ùå Erro na aprova√ß√£o legacy:', error);
                alert('‚ùå Erro de conex√£o. Tente novamente.');
            }
        }
        
        // Fun√ß√£o para carregar lista de usu√°rios
        async function carregarUsuarios() {
            const loading = document.getElementById('loading');
            const listaUsuarios = document.getElementById('listaUsuarios');
            
            loading.style.display = 'block';
            
            try {
                const response = await fetch('/api/listar-usuarios');
                const result = await response.json();
                console.log('üë• Usu√°rios:', result);
                
                if (result.sucesso) {
                    let html = `
                        <div style="margin-bottom: 15px; text-align: center;">
                            <span style="background: #667eea; color: white; padding: 8px 16px; border-radius: 20px; font-weight: 600;">
                                üìä Total: ${result.total} usu√°rios
                            </span>
                        </div>
                        <div style="overflow-x: auto;">
                            <table class="users-table">
                                <thead>
                                    <tr>
                                        <th>üë§ Nome</th>
                                        <th>üìß Email</th>
                                        <th style="text-align: center;">üè∑Ô∏è Tipo</th>
                                        <th style="text-align: center;">‚úÖ Status</th>
                                        <th style="text-align: center;">üìÖ Cadastro</th>
                                        <th style="text-align: center;">‚ö° A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    result.usuarios.forEach(user => {
                        const tipoClass = user.tipo === 'admin' ? 'badge-admin' : 
                                         user.tipo === 'funcionario' ? 'badge-funcionario' : 'badge-paciente';
                        const autorizadoIcon = user.autorizado ? '‚úÖ Ativo' : '‚ùå Bloqueado';
                        const autorizadoColor = user.autorizado ? '#28a745' : '#dc3545';
                        const dataCadastro = new Date(user.created_at).toLocaleDateString('pt-BR', {
                            day: '2-digit',
                            month: '2-digit',
                            year: 'numeric'
                        });
                        
                        html += `
                            <tr>
                                <td style="font-weight: 500;">${user.nome}</td>
                                <td style="color: #666;">${user.email}</td>
                                <td style="text-align: center;">
                                    <span class="status-badge ${tipoClass}">
                                        ${user.tipo.toUpperCase()}
                                    </span>
                                </td>
                                <td style="text-align: center; color: ${autorizadoColor}; font-weight: 600;">
                                    ${autorizadoIcon}
                                </td>
                                <td style="text-align: center; color: #666;">
                                    ${dataCadastro}
                                </td>
                                <td style="text-align: center;">
                                    <div style="display: flex; gap: 5px; justify-content: center;">
                                        <button onclick="arquivarUsuario('${user.email}', '${user.nome}')" 
                                            class="btn-action" style="background: #ffc107; color: #000; padding: 4px 8px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;" 
                                            title="Arquivar usu√°rio">
                                            üì¶ Arquivar
                                        </button>
                                        <button onclick="deletarUsuario('${user.email}', '${user.nome}')" 
                                            class="btn-action" style="background: #dc3545; color: white; padding: 4px 8px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;" 
                                            title="Deletar usu√°rio permanentemente">
                                            üóëÔ∏è Deletar
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    });
                    
                    html += `
                                </tbody>
                            </table>
                        </div>
                    `;
                    
                    listaUsuarios.innerHTML = html;
                } else {
                    listaUsuarios.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #dc3545;">
                            ‚ùå Erro ao carregar usu√°rios: ${result.erro}
                        </div>
                    `;
                }
            } catch (error) {
                console.error('‚ùå Erro:', error);
                listaUsuarios.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #dc3545;">
                        ‚ùå Erro de conex√£o. Tente novamente.
                    </div>
                `;
            } finally {
                loading.style.display = 'none';
            }
        }
        
        // Sistema de auto-refresh para garantir dados atualizados
        let autoRefreshInterval;
        
        function atualizarTimestamp() {
            const now = new Date();
            const timestamp = now.toLocaleString('pt-BR');
            document.getElementById('lastUpdate').textContent = `√öltima atualiza√ß√£o: ${timestamp}`;
        }
        
        async function atualizarDadosManual() {
            console.log('üîÑ Atualiza√ß√£o manual solicitada...');
            
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '‚è≥ Atualizando...';
            btn.disabled = true;
            
            try {
                await carregarUsuariosPendentes();
                await carregarUsuarios();
                atualizarTimestamp();
                
                btn.innerHTML = '‚úÖ Atualizado!';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }, 2000);
                
                console.log('‚úÖ Dados atualizados manualmente');
            } catch (error) {
                console.error('‚ùå Erro na atualiza√ß√£o manual:', error);
                btn.innerHTML = '‚ùå Erro';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }, 2000);
            }
        }
        
        function iniciarAutoRefresh() {
            // Verificar dados apenas a cada 2 minutos (mais conservador)
            autoRefreshInterval = setInterval(async () => {
                console.log('üîÑ Auto-refresh: Verifica√ß√£o peri√≥dica de pendentes...');
                await carregarUsuariosPendentes();
                atualizarTimestamp();
            }, 120000); // 2 minutos
        }
        
        function pararAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
        }
        
        // Inicializar p√°gina
        window.onload = async function() {
            console.log('üöÄ Iniciando painel administrativo...');
            
            // Carregar dados iniciais
            await carregarUsuariosPendentes();
            await carregarUsuarios();
            atualizarTimestamp();
            
            // Iniciar auto-refresh
            iniciarAutoRefresh();
            
            console.log('‚úÖ Painel administrativo carregado com sucesso!');
        };
        
        // Parar auto-refresh quando sair da p√°gina
        window.addEventListener('beforeunload', pararAutoRefresh);
        
        // Fun√ß√£o para arquivar usu√°rio
        async function arquivarUsuario(email, nome) {
            if (!confirm(`üì¶ Arquivar usu√°rio "${nome}"?\n\nO usu√°rio ser√° marcado como arquivado e n√£o poder√° mais fazer login.\n\nEssa a√ß√£o pode ser revertida posteriormente.`)) {
                return;
            }
            
            try {
                const response = await fetch('/api/arquivar-usuario', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: email,
                        arquivado: true
                    })
                });
                
                const result = await response.json();
                
                if (result.sucesso) {
                    alert(`‚úÖ Usu√°rio "${nome}" foi arquivado com sucesso!`);
                    
                    // Recarregar lista
                    await carregarUsuarios();
                    
                    // Mostrar feedback
                    const message = document.getElementById('message');
                    message.innerHTML = `
                        <div class="success">
                            üì¶ Usu√°rio arquivado com sucesso!<br>
                            <strong>Nome:</strong> ${nome}<br>
                            <strong>Email:</strong> ${email}
                        </div>
                    `;
                } else {
                    alert('‚ùå Erro ao arquivar usu√°rio: ' + result.erro);
                }
            } catch (error) {
                console.error('‚ùå Erro ao arquivar usu√°rio:', error);
                alert('‚ùå Erro de conex√£o. Tente novamente.');
            }
        }
        
        // Fun√ß√£o para deletar usu√°rio
        async function deletarUsuario(email, nome) {
            if (!confirm(`üóëÔ∏è DELETAR PERMANENTEMENTE o usu√°rio "${nome}"?\n\n‚ö†Ô∏è ATEN√á√ÉO: Esta a√ß√£o √© IRREVERS√çVEL!\n\n‚Ä¢ Todos os dados ser√£o perdidos\n‚Ä¢ N√£o poder√° ser recuperado\n‚Ä¢ Hist√≥rico ser√° apagado\n\nTem certeza absoluta?`)) {
                return;
            }
            
            // Confirma√ß√£o dupla para dele√ß√£o
            if (!confirm(`üö® √öLTIMA CONFIRMA√á√ÉO!\n\nDeletar permanentemente "${nome}" (${email})?\n\nDigite "DELETAR" na pr√≥xima tela para confirmar.`)) {
                return;
            }
            
            const confirmacao = prompt(`Para confirmar a dele√ß√£o de "${nome}", digite: DELETAR`);
            if (confirmacao !== 'DELETAR') {
                alert('‚ùå Confirma√ß√£o incorreta. Dele√ß√£o cancelada.');
                return;
            }
            
            try {
                const response = await fetch('/api/deletar-usuario', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: email
                    })
                });
                
                const result = await response.json();
                
                if (result.sucesso) {
                    alert(`‚úÖ Usu√°rio "${nome}" foi deletado permanentemente!`);
                    
                    // Recarregar listas
                    await carregarUsuarios();
                    await carregarUsuariosPendentes();
                    
                    // Mostrar feedback
                    const message = document.getElementById('message');
                    message.innerHTML = `
                        <div class="success">
                            üóëÔ∏è Usu√°rio deletado permanentemente!<br>
                            <strong>Nome:</strong> ${nome}<br>
                            <strong>Email:</strong> ${email}
                        </div>
                    `;
                } else {
                    alert('‚ùå Erro ao deletar usu√°rio: ' + result.erro);
                }
            } catch (error) {
                console.error('‚ùå Erro ao deletar usu√°rio:', error);
                alert('‚ùå Erro de conex√£o. Tente novamente.');
            }
        }
    </script>

    <!-- Modal de Aprova√ß√£o Avan√ßada -->
    <div id="modalAprovacao" class="modal-overlay" style="display: none;">
        <div class="modal-content-advanced">
            <div class="modal-header-advanced">
                <h2><i class="fas fa-user-check"></i> Aprova√ß√£o de Usu√°rio</h2>
                <button class="modal-close" onclick="fecharModalAprovacao()">&times;</button>
            </div>
            
            <div class="modal-body-advanced">
                <div class="user-info-section">
                    <h3><i class="fas fa-user"></i> Informa√ß√µes do Usu√°rio</h3>
                    <div class="user-details">
                        <div class="detail-item">
                            <strong>Nome:</strong> <span id="modal-nome">-</span>
                        </div>
                        <div class="detail-item">
                            <strong>Email:</strong> <span id="modal-email">-</span>
                        </div>
                        <div class="detail-item">
                            <strong>Data de Cadastro:</strong> <span id="modal-data">-</span>
                        </div>
                    </div>
                </div>

                <div class="tipo-section">
                    <h3><i class="fas fa-users-cog"></i> Tipo de Usu√°rio</h3>
                    <select id="modal-tipo-usuario" onchange="atualizarPermissoes()">
                        <option value="">Selecione o tipo de usu√°rio</option>
                        <option value="paciente">üë§ Paciente</option>
                        <option value="funcionario">üë• Funcion√°rio</option>
                    </select>
                </div>

                <div id="perfil-funcionario-section" class="perfil-section" style="display: none;">
                    <h3><i class="fas fa-id-badge"></i> Perfil do Funcion√°rio</h3>
                    <select id="modal-perfil-funcionario" onchange="atualizarPermissoesPorPerfil()">
                        <option value="">Selecione o perfil</option>
                        <option value="administrativo">üè¢ Administrativo Geral</option>
                        <option value="atendimento">üìû Atendimento/Recep√ß√£o</option>
                        <option value="medico">üë®‚Äç‚öïÔ∏è M√©dico</option>
                    </select>
                </div>

                <div id="permissoes-section" class="permissoes-section" style="display: none;">
                    <h3><i class="fas fa-shield-alt"></i> Permiss√µes</h3>
                    <div class="permissoes-grid">
                        <!-- Permiss√µes B√°sicas -->
                        <div class="permissao-group">
                            <h4>üìã Acesso B√°sico</h4>
                            <div class="checkbox-group">
                                <label><input type="checkbox" id="perm-dashboard" checked disabled> Dashboard</label>
                                <label><input type="checkbox" id="perm-perfil" checked disabled> Editar Perfil</label>
                                <label><input type="checkbox" id="perm-agendamento" checked> Visualizar Agendamentos</label>
                            </div>
                        </div>

                        <!-- Permiss√µes de Gest√£o -->
                        <div class="permissao-group">
                            <h4>üìä Gest√£o</h4>
                            <div class="checkbox-group">
                                <label><input type="checkbox" id="perm-gestao-pacientes"> Gest√£o de Pacientes</label>
                                <label><input type="checkbox" id="perm-criar-agendamento"> Criar Agendamentos</label>
                                <label><input type="checkbox" id="perm-editar-agendamento"> Editar Agendamentos</label>
                                <label><input type="checkbox" id="perm-cancelar-agendamento"> Cancelar Agendamentos</label>
                            </div>
                        </div>

                        <!-- Permiss√µes M√©dicas -->
                        <div class="permissao-group">
                            <h4>üè• √Årea M√©dica</h4>
                            <div class="checkbox-group">
                                <label><input type="checkbox" id="perm-quadro-evolutivo"> Quadro Evolutivo</label>
                                <label><input type="checkbox" id="perm-caderno-digital"> Caderno Digital</label>
                                <label><input type="checkbox" id="perm-prontuarios"> Prontu√°rios</label>
                                <label><input type="checkbox" id="perm-prescricoes"> Prescri√ß√µes</label>
                                <label><input type="checkbox" id="perm-laudos"> Laudos</label>
                            </div>
                        </div>

                        <!-- Permiss√µes Administrativas -->
                        <div class="permissao-group">
                            <h4>‚öôÔ∏è Administrativo</h4>
                            <div class="checkbox-group">
                                <label><input type="checkbox" id="perm-relatorios"> Relat√≥rios</label>
                                <label><input type="checkbox" id="perm-financeiro"> Financeiro</label>
                                <label><input type="checkbox" id="perm-usuarios"> Gerenciar Usu√°rios</label>
                                <label><input type="checkbox" id="perm-sistema"> Configura√ß√µes Sistema</label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="observacoes-section">
                    <h3><i class="fas fa-sticky-note"></i> Observa√ß√µes (Opcional)</h3>
                    <textarea id="modal-observacoes" placeholder="Adicione observa√ß√µes sobre este usu√°rio..." rows="3"></textarea>
                </div>
            </div>

            <div class="modal-footer-advanced">
                <button class="btn-secondary" onclick="fecharModalAprovacao()">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button class="btn-primary" onclick="confirmarAprovacao()">
                    <i class="fas fa-check"></i> Aprovar Usu√°rio
                </button>
            </div>
        </div>
    </div>

    <style>
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content-advanced {
            background: white;
            border-radius: 15px;
            width: 100%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .modal-header-advanced {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 20px 30px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header-advanced h2 {
            margin: 0;
            font-size: 24px;
        }

        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .modal-body-advanced {
            padding: 30px;
        }

        .user-info-section,
        .tipo-section,
        .perfil-section,
        .permissoes-section,
        .observacoes-section {
            margin-bottom: 25px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            background: #f8f9fa;
        }

        .user-info-section h3,
        .tipo-section h3,
        .perfil-section h3,
        .permissoes-section h3,
        .observacoes-section h3 {
            margin: 0 0 15px 0;
            color: #1e3c72;
            font-size: 18px;
            font-weight: 600;
        }

        .user-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 10px;
        }

        .detail-item {
            background: white;
            padding: 10px 15px;
            border-radius: 8px;
            border-left: 4px solid #1e3c72;
        }

        .detail-item strong {
            color: #1e3c72;
        }

        #modal-tipo-usuario,
        #modal-perfil-funcionario {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            background: white;
        }

        #modal-tipo-usuario:focus,
        #modal-perfil-funcionario:focus {
            border-color: #1e3c72;
            outline: none;
        }

        .permissoes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .permissao-group {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        .permissao-group h4 {
            margin: 0 0 12px 0;
            color: #1e3c72;
            font-size: 14px;
            font-weight: 600;
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 8px;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: color 0.2s;
        }

        .checkbox-group label:hover {
            color: #1e3c72;
        }

        .checkbox-group input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .checkbox-group input[type="checkbox"]:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }

        #modal-observacoes {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            min-height: 80px;
        }

        #modal-observacoes:focus {
            border-color: #1e3c72;
            outline: none;
        }

        .modal-footer-advanced {
            padding: 20px 30px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            justify-content: flex-end;
            gap: 15px;
        }

        .modal-footer-advanced .btn-secondary,
        .modal-footer-advanced .btn-primary {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .modal-footer-advanced .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .modal-footer-advanced .btn-secondary:hover {
            background: #5a6268;
        }

        .modal-footer-advanced .btn-primary {
            background: #28a745;
            color: white;
        }

        .modal-footer-advanced .btn-primary:hover {
            background: #218838;
        }

        @media (max-width: 768px) {
            .modal-content-advanced {
                margin: 10px;
                max-height: 95vh;
            }
            
            .modal-body-advanced {
                padding: 20px;
            }
            
            .permissoes-grid {
                grid-template-columns: 1fr;
            }
            
            .user-details {
                grid-template-columns: 1fr;
            }
        }
    </style>
</body>
</html>
